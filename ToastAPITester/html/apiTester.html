<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toast API Test Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 1rem;
            height: 1rem;
            animation: spin 1s ease-in-out infinite;
        }
        .spinner-dark {
            border-top-color: #374151; /* dark:bg-gray-700 */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Hide sections by default, except proxy */
        #workflowSelectionSection, #orderBuilderSection, #fetchOrderSection, #updateOrderSection, #stockManagementSection, #laborManagementSection, #menuManagementSection, #resultsSection {
            display: none;
        }
        details > summary {
            cursor: pointer;
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        .details-arrow {
            transition: transform 0.2s;
        }
        details[open] .details-arrow {
            transform: rotate(180deg);
        }
        input:required, select:required {
            border-color: #fbbf24; /* amber-400 */
        }

        /* Config Panel Styles */
        #configPanel {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #configPanel.open {
            transform: translateX(0);
        }
        #configOverlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #configOverlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        /* Navigation Panel Styles */
        #navPanel {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #navPanel.open {
            transform: translateX(0);
        }
        #navOverlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #navOverlay.open {
            opacity: 1;
            visibility: visible;
        }

        /* Troubleshooting Panel Styles */
        #troubleshootingPanel {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        #troubleshootingPanel.open {
            transform: translateX(0);
        }
        #troubleshootingOverlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        #troubleshootingOverlay.open {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400">Toast API Test Client</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">A multi-workflow tool for testing the Toast Orders API.</p>
        </header>

        <div id="mainContent" class="hidden grid grid-cols-1 lg:grid-cols-9 gap-6">
            <div class="lg:col-span-4 space-y-6" id="configWrapper">
                <section id="savedLocationsSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">Quick Access</h2>
                    <div class="flex items-center gap-4">
                        <select id="savedLocationsSelect" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                            <option value="">Load a saved location...</option>
                        </select>
                        <button id="clearLocationsBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition flex-shrink-0">Clear</button>
                    </div>
                </section>
                
                <details id="authSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-md" open>
                    <summary class="p-6 w-full flex justify-between items-center cursor-pointer list-none">
                        <h2 class="text-xl font-semibold">Step 1: Authentication</h2>
                        <svg class="details-arrow w-6 h-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="px-6 pb-6 border-t border-gray-200 dark:border-gray-700">
                        <div id="authForm" class="pt-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label for="environmentSelect" class="block text-sm font-medium mb-1">API Environment</label>
                                    <select id="environmentSelect" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2">
                                        <option value="https://ws-sandbox-api.eng.toasttab.com/">Sandbox</option>
                                        <option value="https://ws-preprod-api.eng.toasttab.com/">Preproduction</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="clientId" class="block text-sm font-medium mb-1">Client ID</label>
                                    <input type="password" id="clientId" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2" placeholder="Enter your Client ID">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="clientSecret" class="block text-sm font-medium mb-1">Client Secret</label>
                                    <input type="password" id="clientSecret" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2" placeholder="Enter your Client Secret">
                                </div>
                            </div>
                            <button id="authBtn" class="mt-4 w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition flex items-center justify-center disabled:bg-gray-400">
                                <span id="authBtnText">Authenticate</span>
                                <div id="authSpinner" class="spinner ml-3 hidden"></div>
                            </button>
                            <div id="authStatus" class="mt-2 text-sm text-center"></div>
                        </div>
                        <div id="authenticatedView" class="hidden pt-6">
                             <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Client ID</label>
                                    <input type="text" id="maskedClientId" class="w-full bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2" disabled>
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium mb-1">Client Secret</label>
                                    <input type="text" id="maskedClientSecret" class="w-full bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md p-2" disabled>
                                </div>
                             </div>
                             <button id="logoutBtn" class="mt-4 w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition">Reset Session</button>
                        </div>
                    </div>
                </details>
                
                <details id="dataFetchSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-md" open>
                    <summary class="p-6 w-full flex justify-between items-center cursor-pointer list-none">
                        <h2 class="text-xl font-semibold">Step 2: Fetch Data</h2>
                        <svg class="details-arrow w-6 h-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </summary>
                    <div class="px-6 pb-6 pt-0 border-t border-gray-200 dark:border-gray-700">
                         <div class="space-y-4 pt-6">
                            <div class="flex items-end gap-2">
                                <div class="flex-grow">
                                    <label for="restaurantGuid" class="block text-sm font-medium mb-1">Restaurant GUID</label>
                                    <input type="text" id="restaurantGuid" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2" placeholder="Enter restaurant GUID">
                                </div>
                                 <button id="fetchRestaurantNameBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition flex-shrink-0 flex items-center justify-center">
                                    <span id="fetchRestaurantNameBtnText">Fetch Restaurant</span>
                                    <div id="fetchRestaurantNameSpinner" class="spinner ml-2 hidden"></div>
                                </button>
                            </div>

                            <div id="restaurantNameStatus" class="mt-2 text-sm text-center"></div>

                            <div id="configFetchSection" class="hidden space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <div id="restaurantName" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-md text-center font-medium"></div>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                                    <label class="block text-sm font-medium md:col-span-4">Dining Options, Employees, Menus, etc.</label>
                                    <button id="fetchAllConfigBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-2 rounded-md transition text-sm flex items-center justify-center">
                                        <span id="fetchAllConfigBtnText">Fetch All</span>
                                        <div id="fetchAllConfigSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div id="allConfigStatus" class="md:col-span-5 text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
            
            <div class="lg:col-span-5 space-y-6" id="workflowWrapper">
                <section id="workflowSelectionSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">Step 3: Choose Your Workflow</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                        <button id="createWorkflowBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition text-center">Create New Order</button>
                        <button id="fetchWorkflowBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition text-center">Fetch/Review Order</button>
                        <button id="updateWorkflowBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition text-center">Update Existing Order</button>
                        <button id="stockWorkflowBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition text-center">Manage Inventory</button>
                        <button id="laborWorkflowBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition text-center">Manage Labor</button>
                    </div>
                </section>

                <section id="orderBuilderSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">Build Your Order</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-md font-semibold mb-2">Order Details</h3>
                            <div class="space-y-4">
                                <select id="diningOptionsSelect" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600" required></select>
                                <select id="employeeSelect" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600"></select>
                                <select id="taxSelect" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600"></select>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold mb-2">Guest Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="guestFirstName" placeholder="First Name" class="bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                <input type="text" id="guestLastName" placeholder="Last Name" class="bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                <input type="tel" id="guestPhone" placeholder="Phone Number" class="bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                <input type="email" id="guestEmail" placeholder="Email Address" class="bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                            </div>
                             <button id="generateDetailsBtn" class="mt-2 text-xs bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-2 rounded">Generate Random</button>
                        </div>
                        <div id="deliveryInfoSection" class="hidden">
                            <h3 class="text-md font-semibold mb-2">Delivery Details</h3>
                            <div class="space-y-4">
                                <input type="text" id="deliveryAddress1" placeholder="Street Address" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <input type="text" id="deliveryCity" placeholder="City" class="bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                    <input type="text" id="deliveryState" placeholder="State" class="bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                    <input type="text" id="deliveryZip" placeholder="Zip Code" class="bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                </div>
                                <textarea id="deliveryNotes" placeholder="Delivery Notes (e.g., Be careful of the dog)" rows="3" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600"></textarea>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold mb-2">Add Items to Cart</h3>
                            <div class="flex items-end gap-4 flex-wrap">
                                <div class="flex-grow">
                                    <label for="itemSelectAdd" class="block text-sm font-medium mb-1">Select Item</label>
                                     <select id="itemSelectAdd" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600"></select>
                                </div>
                                <div>
                                    <label for="itemQuantity" class="block text-sm font-medium mb-1">Quantity</label>
                                    <input type="number" id="itemQuantity" value="1" min="1" class="w-24 bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                </div>
                                <button id="addItemBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition">Add Item</button>
                            </div>
                            <div id="itemsList" class="mt-4 space-y-2"></div>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold mb-2">Apply Discount</h3>
                            <select id="discountSelect" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600"></select>
                            <div id="discountItemSelectorContainerCreate" class="hidden mt-2">
                                <label for="discountItemSelectCreate" class="block text-sm font-medium mb-1">Apply to Item</label>
                                <select id="discountItemSelectCreate" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600"></select>
                            </div>
                            <div id="discountDetailsSection" class="hidden mt-2 p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600">
                                <label for="discountValueInput" id="discountValueLabel" class="block text-sm font-medium mb-1">Discount Value</label>
                                <input type="number" id="discountValueInput" step="0.01" placeholder="Enter value" class="w-full bg-white dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500">
                            </div>
                             <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Note: Check-level and item-level discounts are supported.</p>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold mb-2">Add Custom Fields</h3>
                            <p class="text-xs text-gray-500 mb-2">Use dot notation for nested objects (e.g., deliveryInfo.address.street). Values are auto-detected as numbers, booleans, or strings.</p>
                            <div class="flex items-end gap-4 flex-wrap">
                                <div class="flex-grow">
                                    <label for="customFieldKey" class="block text-sm font-medium mb-1">Field Path</label>
                                    <input type="text" id="customFieldKey" placeholder="e.g., deliveryInfo.address.street" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                </div>
                                <div class="flex-grow">
                                    <label for="customFieldValue" class="block text-sm font-medium mb-1">Value</label>
                                    <input type="text" id="customFieldValue" placeholder="e.g., 123 Main St" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                </div>
                                <button id="addCustomFieldBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-md transition">Add Field</button>
                            </div>
                            <div id="customFieldsList" class="mt-4 space-y-2"></div>
                        </div>
                        <div class="text-center mt-6">
                            <button id="sendOrderBtn" class="w-full md:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center mx-auto disabled:bg-gray-400">
                                <span id="sendOrderBtnText">Create & Send Order</span>
                                <div id="sendOrderSpinner" class="spinner ml-3 hidden"></div>
                            </button>
                            <div id="sendOrderStatus" class="mt-2 text-sm text-center"></div>
                        </div>
                    </div>
                </section>

                <section id="fetchOrderSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                     <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">Fetch & Review Order</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="font-semibold">Lookup by GUID:</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="text" id="fetchOrderGuidInput" placeholder="Enter Order GUID" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                <button id="fetchOrderByGuidBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition">Fetch</button>
                            </div>
                             <div id="fetchOrderByGuidStatus" class="mt-2 text-sm text-center"></div>
                        </div>
                        <div class="border-t pt-4 border-gray-200 dark:border-gray-700">
                            <label class="font-semibold">Batch Lookup by Date:</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-1">
                                <div>
                                    <label for="startDate" class="block text-sm">Start Date</label>
                                    <input type="datetime-local" id="startDate" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                </div>
                                 <div>
                                    <label for="endDate" class="block text-sm">End Date</label>
                                    <input type="datetime-local" id="endDate" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                                </div>
                            </div>
                            <button id="fetchOrdersByDateBtn" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition">Fetch by Date Range</button>
                            <div id="fetchOrdersByDateStatus" class="mt-2 text-sm text-center"></div>
                        </div>
                    </div>
                </section>

                <section id="updateOrderSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">Update Existing Order</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="space-y-4">
                        <label class="font-semibold">Load Order to Update:</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" id="updateOrderGuidInput" placeholder="Enter Order GUID" class="w-full bg-gray-50 dark:bg-gray-700 rounded-md p-2 border border-gray-300 dark:border-gray-600">
                            <button id="loadOrderForUpdateBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-md transition">Load</button>
                        </div>
                        <div id="loadOrderForUpdateStatus" class="mt-2 text-sm text-center"></div>
                    </div>
                </section>

                <section id="stockManagementSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">Inventory Management</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- View All Inventory -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-md font-semibold mb-3">View Current Inventory</h3>
                            <div class="flex items-center gap-4 mb-3">
                                <select id="inventoryStatusFilter" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500">
                                    <option value="">All Items</option>
                                    <option value="OUT_OF_STOCK">Out of Stock</option>
                                    <option value="QUANTITY">Limited Quantity</option>
                                </select>
                                <button id="viewInventoryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition flex items-center">
                                    <span id="viewInventoryBtnText">View Inventory</span>
                                    <div id="viewInventorySpinner" class="spinner ml-2 hidden"></div>
                                </button>
                            </div>
                            <div id="viewInventoryStatus" class="text-sm text-center"></div>
                        </div>

                        <!-- Search Specific Items -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-md font-semibold mb-3">Search Specific Items</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Menu Item GUIDs (comma-separated)</label>
                                    <textarea id="searchItemGuids" rows="2" placeholder="Enter menu item GUIDs separated by commas" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Multi-Location IDs (comma-separated)</label>
                                    <textarea id="searchItemMLIds" rows="2" placeholder="Enter multi-location IDs separated by commas" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500"></textarea>
                                </div>
                                <button id="searchInventoryBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition flex items-center">
                                    <span id="searchInventoryBtnText">Search Items</span>
                                    <div id="searchInventorySpinner" class="spinner ml-2 hidden"></div>
                                </button>
                                <div id="searchInventoryStatus" class="text-sm text-center"></div>
                            </div>
                        </div>

                        <!-- Update Inventory -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-md font-semibold mb-3">Update Inventory</h3>
                            <div id="inventoryUpdateList" class="space-y-3 mb-4">
                                <div class="inventory-update-item bg-white dark:bg-gray-800 p-3 rounded border" id="updateTemplate" style="display: none;">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Item GUID/Multi-Location ID</label>
                                            <input type="text" class="item-identifier w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500" placeholder="Item identifier">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Status</label>
                                            <select class="item-status w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500">
                                                <option value="IN_STOCK">In Stock</option>
                                                <option value="OUT_OF_STOCK">Out of Stock</option>
                                                <option value="QUANTITY">Limited Quantity</option>
                                            </select>
                                        </div>
                                        <div class="quantity-container">
                                            <label class="block text-sm font-medium mb-1">Quantity</label>
                                            <input type="number" class="item-quantity w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500" placeholder="0.0" step="0.1" min="0" disabled>
                                        </div>
                                        <button type="button" class="remove-item-btn bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-md transition">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-3 mb-3">
                                <button id="addUpdateItemBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md transition">Add Item</button>
                                <button id="bulkUpdateInventoryBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition flex items-center">
                                    <span id="bulkUpdateInventoryBtnText">Update All Items</span>
                                    <div id="bulkUpdateInventorySpinner" class="spinner ml-2 hidden"></div>
                                </button>
                            </div>
                            <div id="bulkUpdateInventoryStatus" class="text-sm text-center"></div>
                        </div>
                    </div>
                </section>

                <!-- Employee Management Section -->
                <section id="employeeManagementSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">ðŸ‘¥ Employee Management</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Employee Management -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-indigo-600 dark:text-indigo-400">ðŸ‘¥ Employee Management</h3>
                            
                            <!-- Fetch & View Employees -->
                            <div class="mb-4">
                                <h4 class="font-medium mb-2">Employees</h4>
                                <div class="space-y-2">
                                    <button id="fetchAllEmployeesBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                        <span id="fetchAllEmployeesBtnText">Fetch All Employees</span>
                                        <div id="fetchAllEmployeesSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div class="flex gap-2">
                                        <select id="employeeDropdown" class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            <option value="">Select an employee...</option>
                                        </select>
                                        <button id="viewSelectedEmployeeBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md transition text-sm" disabled>View Details</button>
                                    </div>
                                    <details class="text-xs">
                                        <summary class="cursor-pointer text-gray-500 hover:text-gray-700">Advanced: View by Employee IDs</summary>
                                        <div class="mt-2 flex gap-2">
                                            <input type="text" id="employeeIdsInput" placeholder="Employee IDs (comma-separated)" class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            <button id="viewEmployeesBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-md transition text-sm flex items-center">
                                                <span id="viewEmployeesBtnText">View</span>
                                                <div id="viewEmployeesSpinner" class="spinner spinner-dark ml-1 hidden"></div>
                                            </button>
                                        </div>
                                    </details>
                                </div>
                                <div id="viewEmployeesStatus" class="text-xs text-center mt-2"></div>
                            </div>

                            <!-- Add Employee -->
                            <div class="mb-4 border-t pt-3">
                                <h4 class="font-medium mb-2">Add New Employee</h4>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" id="newEmployeeFirstName" placeholder="First Name" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <input type="text" id="newEmployeeLastName" placeholder="Last Name" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                    </div>
                                    <input type="email" id="newEmployeeEmail" placeholder="Email Address" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                    <input type="text" id="newEmployeeExternalId" placeholder="External ID (optional)" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                    <div class="grid grid-cols-2 gap-2">
                                        <button id="autoFillEmployeeBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-md transition text-sm">Auto-fill Test Data</button>
                                        <button id="addEmployeeBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                            <span id="addEmployeeBtnText">Add Employee</span>
                                            <div id="addEmployeeSpinner" class="spinner ml-2 hidden"></div>
                                        </button>
                                    </div>
                                    <div id="addEmployeeStatus" class="text-xs text-center"></div>
                                </div>
                            </div>

                            <!-- Update Employee -->
                            <div class="border-t pt-3">
                                <h4 class="font-medium mb-2">Update Employee</h4>
                                <div class="space-y-2">
                                    <select id="updateEmployeeDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="">Select employee to update...</option>
                                    </select>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" id="updateEmployeeFirstName" placeholder="New First Name (optional)" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <input type="text" id="updateEmployeeLastName" placeholder="New Last Name (optional)" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                    </div>
                                    <button id="updateEmployeeBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center" disabled>
                                        <span id="updateEmployeeBtnText">Update Employee</span>
                                        <div id="updateEmployeeSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div id="updateEmployeeStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Job Management Section -->
                <section id="jobManagementSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">ðŸ’¼ Job Management</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Job Management -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-purple-600 dark:text-purple-400">ðŸ’¼ Job Management</h3>
                            
                            <!-- Fetch & View Jobs -->
                            <div class="mb-4">
                                <h4 class="font-medium mb-2">Jobs</h4>
                                <div class="space-y-2">
                                    <button id="fetchAllJobsBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                        <span id="fetchAllJobsBtnText">Fetch All Jobs</span>
                                        <div id="fetchAllJobsSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div class="flex gap-2">
                                        <select id="jobDropdown" class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            <option value="">Select a job...</option>
                                        </select>
                                        <button id="viewSelectedJobBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md transition text-sm" disabled>View Details</button>
                                    </div>
                                    <details class="text-xs">
                                        <summary class="cursor-pointer text-gray-500 hover:text-gray-700">Advanced: View by Job IDs</summary>
                                        <div class="mt-2 flex gap-2">
                                            <input type="text" id="jobIdsInput" placeholder="Job IDs (comma-separated)" class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            <button id="viewJobsBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-md transition text-sm flex items-center">
                                                <span id="viewJobsBtnText">View</span>
                                                <div id="viewJobsSpinner" class="spinner spinner-dark ml-1 hidden"></div>
                                            </button>
                                        </div>
                                    </details>
                                </div>
                                <div id="viewJobsStatus" class="text-xs text-center mt-2"></div>
                            </div>

                            <!-- Job Assignment -->
                            <div class="border-t pt-3">
                                <h4 class="font-medium mb-2">Assign Jobs to Employee</h4>
                                <div class="space-y-2">
                                    <select id="assignJobEmployeeDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="">Select employee...</option>
                                    </select>
                                    <div class="space-y-1">
                                        <label class="text-xs text-gray-600 dark:text-gray-400">Select Jobs to Assign:</label>
                                        <div id="jobSelectionArea" class="max-h-32 overflow-y-auto border border-gray-300 dark:border-gray-500 rounded p-2 bg-white dark:bg-gray-600">
                                            <p class="text-xs text-gray-500">Fetch jobs first to see available options</p>
                                        </div>
                                    </div>
                                    <button id="assignJobsBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center" disabled>
                                        <span id="assignJobsBtnText">Assign Jobs</span>
                                        <div id="assignJobsSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div id="assignJobsStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Shift Management Section -->
                <section id="shiftManagementSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">ðŸ“… Shift Management</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Shift Management -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-green-600 dark:text-green-400">ðŸ“… Shift Management</h3>
                            
                            <!-- View Shifts -->
                            <div class="mb-4">
                                <h4 class="font-medium mb-2">View Shifts</h4>
                                <div class="space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="date" id="shiftsStartDate" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <input type="date" id="shiftsEndDate" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                    </div>
                                    <button id="viewShiftsBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                        <span id="viewShiftsBtnText">View Shifts</span>
                                        <div id="viewShiftsSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div id="viewShiftsStatus" class="text-xs text-center"></div>
                                </div>
                            </div>

                            <!-- Create Shift -->
                            <div class="border-t pt-3">
                                <h4 class="font-medium mb-2">Create New Shift</h4>
                                <div class="space-y-2">
                                    <select id="shiftEmployeeDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="">Select employee...</option>
                                    </select>
                                    <select id="shiftJobDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm" disabled>
                                        <option value="">Select employee first...</option>
                                    </select>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                        ðŸ’¡ Jobs will be filtered to show only positions assigned to the selected employee
                                    </div>
                                    <div class="space-y-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-600 dark:text-gray-400">Shift Start</label>
                                                <input type="datetime-local" id="shiftStartTime" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-600 dark:text-gray-400">Shift End</label>
                                                <input type="datetime-local" id="shiftEndTime" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex space-x-3 text-xs">
                                                <button type="button" onclick="setTodayShiftTimes()" class="text-blue-600 dark:text-blue-400 hover:underline">
                                                    ðŸ“… Today 9AM-5PM
                                                </button>
                                                <button type="button" onclick="setTomorrowMorningShift()" class="text-purple-600 dark:text-purple-400 hover:underline">
                                                    ðŸŒ… Tomorrow 8AM-12PM
                                                </button>
                                                <button type="button" onclick="setSimpleTestShift()" class="text-green-600 dark:text-green-400 hover:underline">
                                                    âš¡ Simple Test
                                                </button>
                                            </div>
                                            <span class="text-xs text-gray-500" id="shiftDurationDisplay"></span>
                                        </div>
                                    </div>
                                    <button id="createShiftBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center" disabled>
                                        <span id="createShiftBtnText">Create Shift</span>
                                        <div id="createShiftSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div id="createShiftStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Time Entry Management Section -->
                <section id="timeEntryManagementSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">â° Time Entry Management</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Time Entry Management -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-orange-600 dark:text-orange-400">â° Time Entry Management</h3>
                            
                            <!-- View Time Entries -->
                            <div class="mb-4">
                                <h4 class="font-medium mb-2">View Time Entries</h4>
                                <div class="space-y-2">
                                    <select id="timeEntryQuery" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="date">By Date Range</option>
                                        <option value="businessDate">By Business Date</option>
                                        <option value="modified">By Modified Date</option>
                                    </select>
                                    <div id="timeEntryDateInputs">
                                        <div class="grid grid-cols-2 gap-2">
                                            <input type="date" id="timeEntryStartDate" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            <input type="date" id="timeEntryEndDate" class="bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        </div>
                                    </div>
                                    <div id="timeEntryBusinessDateInput" style="display: none;">
                                        <input type="date" id="businessDate" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                    </div>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" id="includeMissedBreaks" class="mr-2">
                                        Include missed breaks
                                    </label>
                                    <button id="viewTimeEntriesBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                        <span id="viewTimeEntriesBtnText">View Time Entries</span>
                                        <div id="viewTimeEntriesSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div id="viewTimeEntriesStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                            
                            <!-- Create Time Entry -->
                            <div class="border-t pt-3">
                                <h4 class="font-medium mb-2">Create Time Entry</h4>
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-2 mb-3">
                                    <div class="text-xs text-yellow-800 dark:text-yellow-200">
                                        <strong>âš ï¸ Note:</strong> Time entry creation may be restricted by the Toast API for security reasons. 
                                        If it fails, use the test scenarios to understand the data structure.
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <!-- Quick Test Scenarios -->
                                    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 mb-3">
                                        <h5 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">ðŸŽ¯ Quick Test Scenarios</h5>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <button type="button" onclick="setTimeEntryScenario('perfect')" class="bg-green-100 hover:bg-green-200 dark:bg-green-900/40 dark:hover:bg-green-900/60 text-green-800 dark:text-green-200 px-2 py-1 rounded">
                                                âœ… Perfect Day
                                            </button>
                                            <button type="button" onclick="setTimeEntryScenario('late')" class="bg-yellow-100 hover:bg-yellow-200 dark:bg-yellow-900/40 dark:hover:bg-yellow-900/60 text-yellow-800 dark:text-yellow-200 px-2 py-1 rounded">
                                                â° Late Start
                                            </button>
                                            <button type="button" onclick="setTimeEntryScenario('overtime')" class="bg-orange-100 hover:bg-orange-200 dark:bg-orange-900/40 dark:hover:bg-orange-900/60 text-orange-800 dark:text-orange-200 px-2 py-1 rounded">
                                                ðŸ”¥ Overtime Shift
                                            </button>
                                            <button type="button" onclick="setTimeEntryScenario('short')" class="bg-red-100 hover:bg-red-200 dark:bg-red-900/40 dark:hover:bg-red-900/60 text-red-800 dark:text-red-200 px-2 py-1 rounded">
                                                ðŸƒ Left Early
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Employee & Job Selection -->
                                    <select id="timeEntryEmployeeDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="">Select employee...</option>
                                    </select>
                                    <select id="timeEntryJobDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm" disabled>
                                        <option value="">Select employee first...</option>
                                    </select>
                                    
                                    <!-- Work Period -->
                                    <div class="space-y-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-600 dark:text-gray-400">Clock In</label>
                                                <input type="datetime-local" id="timeEntryClockIn" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-600 dark:text-gray-400">Clock Out</label>
                                                <input type="datetime-local" id="timeEntryClockOut" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-500" id="timeEntryHoursDisplay"></span>
                                            <span class="text-xs" id="timeEntryOvertimeWarning"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Tips & Breaks -->
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 dark:text-gray-400">Cash Tips ($)</label>
                                            <input type="number" id="timeEntryCashTips" placeholder="0.00" step="0.01" min="0" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 dark:text-gray-400">Break Minutes</label>
                                            <input type="number" id="timeEntryBreakMinutes" placeholder="30" min="0" max="480" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        </div>
                                    </div>
                                    
                                    <button id="createTimeEntryBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center" disabled>
                                        <span id="createTimeEntryBtnText">Create Time Entry</span>
                                        <div id="createTimeEntrySpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div id="createTimeEntryStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Menu Structure Management Section -->
                <section id="menuStructureSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">ðŸ“‹ Menu Structure</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Menu Structure Management -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-amber-600 dark:text-amber-400">ðŸ“‹ Menu Structure</h3>
                            
                            <!-- View All Menus -->
                            <div class="mb-4">
                                <h4 class="font-medium mb-2">Menus & Categories</h4>
                                <div class="space-y-2">
                                    <button id="fetchAllMenusBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                        <span id="fetchAllMenusBtnText">Fetch All Menus</span>
                                        <div id="fetchAllMenusSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div class="flex gap-2">
                                        <select id="menuDropdown" class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            <option value="">Select a menu...</option>
                                        </select>
                                        <button id="viewSelectedMenuBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md transition text-sm" disabled>View Details</button>
                                    </div>
                                    <div id="viewMenusStatus" class="text-xs text-center mt-2"></div>
                                </div>
                            </div>

                            <!-- Menu Groups Management -->
                            <div class="border-t pt-3">
                                <h4 class="font-medium mb-2">Menu Categories/Groups</h4>
                                <div class="space-y-2">
                                    <select id="menuGroupDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="">Select a category...</option>
                                    </select>
                                    <div class="flex gap-2">
                                        <button id="viewMenuGroupBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center" disabled>
                                            <span id="viewMenuGroupBtnText">View Category</span>
                                            <div id="viewMenuGroupSpinner" class="spinner ml-2 hidden"></div>
                                        </button>
                                        <button id="createMenuGroupBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition text-sm">Create New</button>
                                    </div>
                                    <div id="viewMenuGroupStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Menu Items Management Section -->
                <section id="menuItemsSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">ðŸ½ï¸ Menu Items</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Menu Items Management -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-emerald-600 dark:text-emerald-400">ðŸ½ï¸ Menu Items</h3>
                            
                            <!-- View & Search Items -->
                            <div class="mb-4">
                                <h4 class="font-medium mb-2">Items Management</h4>
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <select id="menuItemDropdown" class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            <option value="">Select an item...</option>
                                        </select>
                                        <button id="viewSelectedItemBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md transition text-sm" disabled>View Details</button>
                                    </div>
                                    <input type="text" id="itemSearchInput" placeholder="Search items by name..." class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                    <div class="flex gap-2">
                                        <button id="searchMenuItemsBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                            <span id="searchMenuItemsBtnText">Search Items</span>
                                            <div id="searchMenuItemsSpinner" class="spinner ml-2 hidden"></div>
                                        </button>
                                        <button id="createMenuItemBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition text-sm">Create New</button>
                                    </div>
                                    <div id="searchMenuItemsStatus" class="text-xs text-center"></div>
                                </div>
                            </div>

                            <!-- Item Operations -->
                            <div class="border-t pt-3">
                                <h4 class="font-medium mb-2">Item Operations</h4>
                                <div class="space-y-2">
                                    <select id="itemOperationDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="">Select item for operations...</option>
                                    </select>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button id="updateItemPriceBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-md transition text-sm" disabled>Update Price</button>
                                        <button id="toggleItemAvailabilityBtn" class="bg-orange-600 hover:bg-orange-700 text-white py-2 rounded-md transition text-sm" disabled>Toggle Available</button>
                                    </div>
                                    <div id="itemOperationsStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Modifier Management Section -->
                <section id="modifiersSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">ðŸ”§ Modifiers</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Modifier Management -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-teal-600 dark:text-teal-400">ðŸ”§ Modifiers</h3>
                            
                            <!-- Modifier Groups -->
                            <div class="mb-4">
                                <h4 class="font-medium mb-2">Modifier Groups</h4>
                                <div class="space-y-2">
                                    <button id="fetchModifierGroupsBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                        <span id="fetchModifierGroupsBtnText">Fetch Modifier Groups</span>
                                        <div id="fetchModifierGroupsSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div class="flex gap-2">
                                        <select id="modifierGroupDropdown" class="flex-1 bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                            <option value="">Select modifier group...</option>
                                        </select>
                                        <button id="viewModifierGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md transition text-sm" disabled>View</button>
                                    </div>
                                    <div id="fetchModifierGroupsStatus" class="text-xs text-center"></div>
                                </div>
                            </div>

                            <!-- Modifier Options -->
                            <div class="border-t pt-3">
                                <h4 class="font-medium mb-2">Modifier Options</h4>
                                <div class="space-y-2">
                                    <select id="modifierOptionDropdown" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="">Select modifier option...</option>
                                    </select>
                                    <div class="flex gap-2">
                                        <button id="viewModifierOptionsBtn" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center">
                                            <span id="viewModifierOptionsBtnText">View Options</span>
                                            <div id="viewModifierOptionsSpinner" class="spinner ml-2 hidden"></div>
                                        </button>
                                        <button id="createModifierOptionBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition text-sm">Create</button>
                                    </div>
                                    <div id="viewModifierOptionsStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Bulk Operations Section -->
                <section id="bulkOperationsSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">
                        <h2 class="text-xl font-semibold">âš¡ Bulk Operations</h2>
                        <button class="resetWorkflowBtn text-sm text-blue-500 hover:underline">Change Workflow</button>
                    </div>
                    
                    <div class="max-w-4xl mx-auto">
                        <!-- Bulk Operations -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold mb-3 text-rose-600 dark:text-rose-400">âš¡ Bulk Operations</h3>
                            
                            <!-- Batch Updates -->
                            <div class="mb-4">
                                <h4 class="font-medium mb-2">Batch Operations</h4>
                                <div class="space-y-2">
                                    <select id="bulkOperationTypeSelect" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm">
                                        <option value="">Select operation type...</option>
                                        <option value="price-update">Bulk Price Update</option>
                                        <option value="availability-toggle">Bulk Availability Toggle</option>
                                        <option value="category-move">Move Items to Category</option>
                                    </select>
                                    <textarea id="bulkItemsList" rows="3" placeholder="Enter item GUIDs or names (one per line)" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500 text-sm"></textarea>
                                    <button id="executeBulkOperationBtn" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2 rounded-md transition text-sm flex items-center justify-center" disabled>
                                        <span id="executeBulkOperationBtnText">Execute Bulk Operation</span>
                                        <div id="executeBulkOperationSpinner" class="spinner ml-2 hidden"></div>
                                    </button>
                                    <div id="bulkOperationStatus" class="text-xs text-center"></div>
                                </div>
                            </div>

                            <!-- Menu Publishing -->
                            <div class="border-t pt-3">
                                <h4 class="font-medium mb-2">Menu Publishing</h4>
                                <div class="space-y-2">
                                    <div class="flex gap-2">
                                        <button id="validateMenuBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md transition text-sm">Validate Menu</button>
                                        <button id="publishMenuBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-md transition text-sm">Publish Menu</button>
                                    </div>
                                    <div id="menuPublishingStatus" class="text-xs text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="resultsSection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                     <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">Results</h2>
                     <div id="resultsContainer" class="space-y-4 max-h-[32rem] overflow-y-auto">
                         <p class="text-gray-500 dark:text-gray-400">Results will be displayed here.</p>
                     </div>
                 </section>
            </div>
        </div>
        
        <section id="proxySectionWrapper">
             <section id="proxySection" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">First Step: Activate CORS Proxy</h2>
                <p class="mb-4 text-gray-600 dark:text-gray-400">This tool uses a public proxy to communicate with the Toast API from your browser. You must activate it for this session.</p>
                <ol class="list-decimal list-inside space-y-2 mb-4">
                    <li>Click the "Activate Proxy" button to open the proxy activation page in a new tab.</li>
                    <li>On that new page, click the button that says <strong class="font-semibold">"Request temporary access to the demo server"</strong>.</li>
                    <li>Return to this tab and click the "Test Proxy" button to confirm it's working.</li>
                </ol>
                <div class="mt-4 flex flex-wrap items-center gap-4">
                    <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" rel="noopener noreferrer" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-md transition">1. Activate Proxy</a>
                    <button id="testProxyBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition flex items-center justify-center">
                         <span id="testProxyBtnText">2. Test Proxy Connection</span>
                         <div id="testProxySpinner" class="spinner ml-3 hidden"></div>
                    </button>
                </div>
                <div id="proxyStatus" class="mt-4"></div>
            </section>
        </section>
    </div>

    <!-- Navigation Panel Toggle Button -->
    <button id="toggleNavBtn" class="fixed top-1/3 -translate-y-1/2 left-0 bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-r-lg shadow-lg z-50 hidden" title="API Workflows">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>
    
    <!-- Configuration Panel Toggle Button -->
    <button id="toggleConfigBtn" class="fixed top-2/3 -translate-y-1/2 left-0 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-r-lg shadow-lg z-50 hidden" title="Configuration">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>
    
    <!-- Navigation Panel -->
    <div id="navOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30"></div>
    <div id="navPanel" class="fixed top-0 left-0 h-full w-full md:w-1/3 lg:w-1/4 bg-white dark:bg-gray-800 shadow-2xl z-40 flex flex-col">
        <div class="p-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold">API Workflows</h2>
            <button id="closeNavBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Orders API Section -->
            <div class="mb-6">
                <button class="w-full flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition" onclick="toggleApiSection('orders')">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-green-700 dark:text-green-300">Orders API</h3>
                    </div>
                    <svg id="ordersChevron" class="w-5 h-5 text-green-600 dark:text-green-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div id="ordersSubMenu" class="ml-4 mt-2 space-y-1 hidden">
                    <button id="navCreateOrderBtn" class="w-full text-left px-4 py-2 rounded-lg bg-green-50 dark:bg-green-900/10 hover:bg-green-100 dark:hover:bg-green-900/30 text-green-700 dark:text-green-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-3"></span>
                        Create New Order
                    </button>
                    <button id="navFetchOrderBtn" class="w-full text-left px-4 py-2 rounded-lg bg-green-50 dark:bg-green-900/10 hover:bg-green-100 dark:hover:bg-green-900/30 text-green-700 dark:text-green-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-3"></span>
                        Fetch/Review Order
                    </button>
                    <button id="navUpdateOrderBtn" class="w-full text-left px-4 py-2 rounded-lg bg-green-50 dark:bg-green-900/10 hover:bg-green-100 dark:hover:bg-green-900/30 text-green-700 dark:text-green-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-green-400 rounded-full mr-3"></span>
                        Update Existing Order
                    </button>
                </div>
            </div>
            
            <!-- Stock API Section -->
            <div class="mb-6">
                <button class="w-full flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/20 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition" onclick="toggleApiSection('stock')">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-orange-700 dark:text-orange-300">Stock API</h3>
                    </div>
                    <svg id="stockChevron" class="w-5 h-5 text-orange-600 dark:text-orange-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div id="stockSubMenu" class="ml-4 mt-2 space-y-1 hidden">
                    <button id="navStockBtn" class="w-full text-left px-4 py-2 rounded-lg bg-orange-50 dark:bg-orange-900/10 hover:bg-orange-100 dark:hover:bg-orange-900/30 text-orange-700 dark:text-orange-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-orange-400 rounded-full mr-3"></span>
                        Inventory Management
                    </button>
                </div>
            </div>
            
            <!-- Labor API Section -->
            <div class="mb-6">
                <button class="w-full flex items-center justify-between p-3 bg-indigo-50 dark:bg-indigo-900/20 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 rounded-lg transition" onclick="toggleApiSection('labor')">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-indigo-700 dark:text-indigo-300">Labor API</h3>
                    </div>
                    <svg id="laborChevron" class="w-5 h-5 text-indigo-600 dark:text-indigo-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div id="laborSubMenu" class="ml-4 mt-2 space-y-1 hidden">
                    <button id="navEmployeeManagementBtn" class="w-full text-left px-4 py-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/10 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>
                        Employee Management
                    </button>
                    <button id="navShiftManagementBtn" class="w-full text-left px-4 py-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/10 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>
                        Shift Management
                    </button>
                    <button id="navJobManagementBtn" class="w-full text-left px-4 py-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/10 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>
                        Job Management
                    </button>
                    <button id="navTimeEntryManagementBtn" class="w-full text-left px-4 py-2 rounded-lg bg-indigo-50 dark:bg-indigo-900/10 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-indigo-400 rounded-full mr-3"></span>
                        Time Entry Management
                    </button>
                </div>
            </div>
            
            <!-- Menus API Section -->
            <div class="mb-6">
                <button class="w-full flex items-center justify-between p-3 bg-amber-50 dark:bg-amber-900/20 hover:bg-amber-100 dark:hover:bg-amber-900/30 rounded-lg transition" onclick="toggleApiSection('menus')">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-amber-100 dark:bg-amber-900 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-amber-700 dark:text-amber-300">Menus API</h3>
                    </div>
                    <svg id="menusChevron" class="w-5 h-5 text-amber-600 dark:text-amber-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div id="menusSubMenu" class="ml-4 mt-2 space-y-1 hidden">
                    <button id="navMenuStructureBtn" class="w-full text-left px-4 py-2 rounded-lg bg-amber-50 dark:bg-amber-900/10 hover:bg-amber-100 dark:hover:bg-amber-900/30 text-amber-700 dark:text-amber-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-amber-400 rounded-full mr-3"></span>
                        Menu Structure
                    </button>
                    <button id="navMenuItemsBtn" class="w-full text-left px-4 py-2 rounded-lg bg-amber-50 dark:bg-amber-900/10 hover:bg-amber-100 dark:hover:bg-amber-900/30 text-amber-700 dark:text-amber-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-amber-400 rounded-full mr-3"></span>
                        Menu Items
                    </button>
                    <button id="navModifiersBtn" class="w-full text-left px-4 py-2 rounded-lg bg-amber-50 dark:bg-amber-900/10 hover:bg-amber-100 dark:hover:bg-amber-900/30 text-amber-700 dark:text-amber-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-amber-400 rounded-full mr-3"></span>
                        Modifiers
                    </button>
                    <button id="navBulkOperationsBtn" class="w-full text-left px-4 py-2 rounded-lg bg-amber-50 dark:bg-amber-900/10 hover:bg-amber-100 dark:hover:bg-amber-900/30 text-amber-700 dark:text-amber-300 transition text-sm flex items-center">
                        <span class="w-2 h-2 bg-amber-400 rounded-full mr-3"></span>
                        Bulk Operations
                    </button>
                </div>
            </div>
            
            <!-- Future APIs placeholder -->
            <div class="text-center py-8 text-gray-400">
                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <p class="text-sm mb-4">More APIs coming soon...</p>
                
                <!-- Quick Help -->
                <div class="text-left bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3 text-xs">
                    <div class="flex items-center mb-2">
                        <span class="text-blue-600 dark:text-blue-400">ðŸ’¡</span>
                        <span class="ml-2 font-medium text-blue-800 dark:text-blue-200">Getting Permission Errors?</span>
                    </div>
                    <p class="text-blue-700 dark:text-blue-300 mb-2">Your API client may need additional scopes to access certain resources.</p>
                    <a href="https://doc.toasttab.com/doc/devguide/apiScopes.html" target="_blank" rel="noopener noreferrer" 
                       class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium underline">
                        View API Scopes Documentation â†’
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration Panel -->
    <div id="configOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30"></div>
    <div id="configPanel" class="fixed top-0 left-0 h-full w-full md:w-1/3 lg:w-1/4 bg-gray-50 dark:bg-gray-800 shadow-2xl z-40 flex flex-col">
        <div class="p-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold">Configuration</h2>
            <button id="closeConfigBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="configPanelContent" class="p-6 overflow-y-auto flex-grow space-y-6">
            </div>
    </div>
    <button id="toggleTroubleshootingBtn" class="fixed top-1/2 -translate-y-1/2 right-0 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-l-lg shadow-lg z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
    <div id="troubleshootingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30"></div>
    <div id="troubleshootingPanel" class="fixed top-0 right-0 h-full w-full md:w-3/4 lg:w-1/2 bg-white dark:bg-gray-800 shadow-2xl z-40 flex flex-col">
        <div class="p-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold">API Log & Troubleshooting</h2>
            <button id="closeTroubleshootingBtn" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-6 overflow-y-auto flex-grow">
            <div id="logContainer" class="space-y-2">
                 <p class="text-gray-500 dark:text-gray-400">No API calls logged yet.</p>
            </div>
        </div>
    </div>

    <select id="alternatePaymentTypeSelect" class="hidden"></select>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- API Configuration ---
            const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
            const AUTH_PATH = 'authentication/v1/authentication/login';
            const RESTAURANTS_PATH = 'restaurants/v1/restaurants';
            const MENUS_PATH = 'menus/v2/menus';
            const DINING_OPTIONS_PATH = 'config/v2/diningOptions';
            const EMPLOYEES_PATH = '/labor/v1/employees';
            const DISCOUNTS_PATH = 'config/v2/discounts';
            const TAXES_PATH = 'config/v2/taxRates';
            const ORDERS_PATH = 'orders/v2/orders';
            const ALTERNATE_PAYMENT_TYPES_PATH = 'config/v2/alternatePaymentTypes';
            
            // --- Stock API Endpoints ---
            const STOCK_INVENTORY_PATH = 'stock/v1/inventory';
            const STOCK_SEARCH_PATH = 'stock/v1/inventory/search';
            const STOCK_UPDATE_PATH = 'stock/v1/inventory/update';
            
            // --- Labor API Endpoints ---
            const EMPLOYEES_PATH_BASE = 'labor/v1/employees';
            const JOBS_PATH_BASE = 'labor/v1/jobs';
            const SHIFTS_PATH = 'labor/v1/shifts';
            const TIME_ENTRIES_PATH = 'labor/v1/timeEntries';
            
            // --- DOM Element References ---
            const mainContent = document.getElementById('mainContent');
            const proxySectionWrapper = document.getElementById('proxySectionWrapper');
            const testProxyBtn = document.getElementById('testProxyBtn');
            const testProxyBtnText = document.getElementById('testProxyBtnText');
            const testProxySpinner = document.getElementById('testProxySpinner');
            const proxyStatus = document.getElementById('proxyStatus');
            
            const configWrapper = document.getElementById('configWrapper');
            const workflowWrapper = document.getElementById('workflowWrapper');
            const savedLocationsSection = document.getElementById('savedLocationsSection');
            const savedLocationsSelect = document.getElementById('savedLocationsSelect');
            const clearLocationsBtn = document.getElementById('clearLocationsBtn');

            const authSection = document.getElementById('authSection');
            const authForm = document.getElementById('authForm');
            const authenticatedView = document.getElementById('authenticatedView');
            const maskedClientId = document.getElementById('maskedClientId');
            const maskedClientSecret = document.getElementById('maskedClientSecret');
            const environmentSelect = document.getElementById('environmentSelect');
            const clientIdInput = document.getElementById('clientId');
            const clientSecretInput = document.getElementById('clientSecret');
            const authBtn = document.getElementById('authBtn');
            const authBtnText = document.getElementById('authBtnText');
            const authSpinner = document.getElementById('authSpinner');
            const authStatus = document.getElementById('authStatus');
            const logoutBtn = document.getElementById('logoutBtn');
            
            const dataFetchSection = document.getElementById('dataFetchSection');
            const restaurantGuidInput = document.getElementById('restaurantGuid');
            const fetchRestaurantNameBtn = document.getElementById('fetchRestaurantNameBtn');
            const fetchRestaurantNameBtnText = document.getElementById('fetchRestaurantNameBtnText');
            const fetchRestaurantNameSpinner = document.getElementById('fetchRestaurantNameSpinner');
            const restaurantNameStatus = document.getElementById('restaurantNameStatus');
            const configFetchSection = document.getElementById('configFetchSection');
            const restaurantName = document.getElementById('restaurantName');
            
            const fetchAllConfigBtn = document.getElementById('fetchAllConfigBtn');
            const allConfigStatus = document.getElementById('allConfigStatus');
            
            const diningOptionsSelect = document.getElementById('diningOptionsSelect');
            const employeeSelect = document.getElementById('employeeSelect');
            const discountSelect = document.getElementById('discountSelect');
            const taxSelect = document.getElementById('taxSelect');
            const alternatePaymentTypeSelect = document.getElementById('alternatePaymentTypeSelect');
            
            const orderBuilderSection = document.getElementById('orderBuilderSection');
            const guestFirstNameInput = document.getElementById('guestFirstName');
            const guestLastNameInput = document.getElementById('guestLastName');
            const guestPhoneInput = document.getElementById('guestPhone');
            const guestEmailInput = document.getElementById('guestEmail');
            const generateDetailsBtn = document.getElementById('generateDetailsBtn');
            
            const deliveryInfoSection = document.getElementById('deliveryInfoSection');
            const deliveryAddress1Input = document.getElementById('deliveryAddress1');
            const deliveryCityInput = document.getElementById('deliveryCity');
            const deliveryStateInput = document.getElementById('deliveryState');
            const deliveryZipInput = document.getElementById('deliveryZip');
            const deliveryNotesInput = document.getElementById('deliveryNotes');

            const itemSelectAdd = document.getElementById('itemSelectAdd'); 
            const itemQuantityInput = document.getElementById('itemQuantity');
            const addItemBtn = document.getElementById('addItemBtn');
            const itemsList = document.getElementById('itemsList');
            const sendOrderBtn = document.getElementById('sendOrderBtn');
            const sendOrderBtnText = document.getElementById('sendOrderBtnText');
            const sendOrderSpinner = document.getElementById('sendOrderSpinner');
            const sendOrderStatus = document.getElementById('sendOrderStatus');
            
            const discountDetailsSection = document.getElementById('discountDetailsSection');
            const discountValueInput = document.getElementById('discountValueInput');
            const discountValueLabel = document.getElementById('discountValueLabel');
            
            // Navigation Panel Elements
            const navPanel = document.getElementById('navPanel');
            const navOverlay = document.getElementById('navOverlay');
            const toggleNavBtn = document.getElementById('toggleNavBtn');
            const closeNavBtn = document.getElementById('closeNavBtn');
            
            // Navigation Workflow Buttons
            const navCreateOrderBtn = document.getElementById('navCreateOrderBtn');
            const navFetchOrderBtn = document.getElementById('navFetchOrderBtn');
            const navUpdateOrderBtn = document.getElementById('navUpdateOrderBtn');
            const navStockBtn = document.getElementById('navStockBtn');
            
            // Labor Management Sub-navigation
            const navEmployeeManagementBtn = document.getElementById('navEmployeeManagementBtn');
            const navShiftManagementBtn = document.getElementById('navShiftManagementBtn');
            const navJobManagementBtn = document.getElementById('navJobManagementBtn');
            const navTimeEntryManagementBtn = document.getElementById('navTimeEntryManagementBtn');
            
            // Menu Management Sub-navigation
            const navMenuStructureBtn = document.getElementById('navMenuStructureBtn');
            const navMenuItemsBtn = document.getElementById('navMenuItemsBtn');
            const navModifiersBtn = document.getElementById('navModifiersBtn');
            const navBulkOperationsBtn = document.getElementById('navBulkOperationsBtn');
            
            // Config Panel Elements
            const configPanel = document.getElementById('configPanel');
            const configOverlay = document.getElementById('configOverlay');
            const toggleConfigBtn = document.getElementById('toggleConfigBtn');
            const closeConfigBtn = document.getElementById('closeConfigBtn');
            const configPanelContent = document.getElementById('configPanelContent');

            // Troubleshooting Panel Elements
            const troubleshootingPanel = document.getElementById('troubleshootingPanel');
            const troubleshootingOverlay = document.getElementById('troubleshootingOverlay');
            const toggleTroubleshootingBtn = document.getElementById('toggleTroubleshootingBtn');
            const closeTroubleshootingBtn = document.getElementById('closeTroubleshootingBtn');
            const logContainer = document.getElementById('logContainer');

            // Workflow Elements
            const workflowSelectionSection = document.getElementById('workflowSelectionSection');
            const createWorkflowBtn = document.getElementById('createWorkflowBtn');
            const fetchWorkflowBtn = document.getElementById('fetchWorkflowBtn');
            const updateWorkflowBtn = document.getElementById('updateWorkflowBtn');
            const stockWorkflowBtn = document.getElementById('stockWorkflowBtn');
            const resetWorkflowBtns = document.querySelectorAll('.resetWorkflowBtn');

            // Fetch Order Elements
            const fetchOrderSection = document.getElementById('fetchOrderSection');
            const fetchOrderGuidInput = document.getElementById('fetchOrderGuidInput');
            const fetchOrderByGuidBtn = document.getElementById('fetchOrderByGuidBtn');
            const fetchOrderByGuidStatus = document.getElementById('fetchOrderByGuidStatus');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const fetchOrdersByDateBtn = document.getElementById('fetchOrdersByDateBtn');
            const fetchOrdersByDateStatus = document.getElementById('fetchOrdersByDateStatus');
            
            // Update Order Elements
            const updateOrderSection = document.getElementById('updateOrderSection');
            const updateOrderGuidInput = document.getElementById('updateOrderGuidInput');
            const loadOrderForUpdateBtn = document.getElementById('loadOrderForUpdateBtn');
            const loadOrderForUpdateStatus = document.getElementById('loadOrderForUpdateStatus');

            // Stock Management Elements
            const stockManagementSection = document.getElementById('stockManagementSection');
            const inventoryStatusFilter = document.getElementById('inventoryStatusFilter');
            const viewInventoryBtn = document.getElementById('viewInventoryBtn');
            const viewInventoryBtnText = document.getElementById('viewInventoryBtnText');
            const viewInventorySpinner = document.getElementById('viewInventorySpinner');
            const viewInventoryStatus = document.getElementById('viewInventoryStatus');
            const searchItemGuids = document.getElementById('searchItemGuids');
            const searchItemMLIds = document.getElementById('searchItemMLIds');
            const searchInventoryBtn = document.getElementById('searchInventoryBtn');
            const searchInventoryBtnText = document.getElementById('searchInventoryBtnText');
            const searchInventorySpinner = document.getElementById('searchInventorySpinner');
            const searchInventoryStatus = document.getElementById('searchInventoryStatus');
            const inventoryUpdateList = document.getElementById('inventoryUpdateList');
            const addUpdateItemBtn = document.getElementById('addUpdateItemBtn');
            const bulkUpdateInventoryBtn = document.getElementById('bulkUpdateInventoryBtn');
            const bulkUpdateInventoryBtnText = document.getElementById('bulkUpdateInventoryBtnText');
            const bulkUpdateInventorySpinner = document.getElementById('bulkUpdateInventorySpinner');
            const bulkUpdateInventoryStatus = document.getElementById('bulkUpdateInventoryStatus');

            // Labor Management Elements
            const employeeManagementSection = document.getElementById('employeeManagementSection');
            const jobManagementSection = document.getElementById('jobManagementSection');
            const shiftManagementSection = document.getElementById('shiftManagementSection');
            const timeEntryManagementSection = document.getElementById('timeEntryManagementSection');
            
            // Employee Management
            const fetchAllEmployeesBtn = document.getElementById('fetchAllEmployeesBtn');
            const fetchAllEmployeesBtnText = document.getElementById('fetchAllEmployeesBtnText');
            const fetchAllEmployeesSpinner = document.getElementById('fetchAllEmployeesSpinner');
            const employeeDropdown = document.getElementById('employeeDropdown');
            const viewSelectedEmployeeBtn = document.getElementById('viewSelectedEmployeeBtn');
            const employeeIdsInput = document.getElementById('employeeIdsInput');
            const viewEmployeesBtn = document.getElementById('viewEmployeesBtn');
            const viewEmployeesBtnText = document.getElementById('viewEmployeesBtnText');
            const viewEmployeesSpinner = document.getElementById('viewEmployeesSpinner');
            const viewEmployeesStatus = document.getElementById('viewEmployeesStatus');
            const newEmployeeFirstName = document.getElementById('newEmployeeFirstName');
            const newEmployeeLastName = document.getElementById('newEmployeeLastName');
            const newEmployeeEmail = document.getElementById('newEmployeeEmail');
            const newEmployeeExternalId = document.getElementById('newEmployeeExternalId');
            const autoFillEmployeeBtn = document.getElementById('autoFillEmployeeBtn');
            const addEmployeeBtn = document.getElementById('addEmployeeBtn');
            const addEmployeeBtnText = document.getElementById('addEmployeeBtnText');
            const addEmployeeSpinner = document.getElementById('addEmployeeSpinner');
            const addEmployeeStatus = document.getElementById('addEmployeeStatus');
            const updateEmployeeDropdown = document.getElementById('updateEmployeeDropdown');
            const updateEmployeeFirstName = document.getElementById('updateEmployeeFirstName');
            const updateEmployeeLastName = document.getElementById('updateEmployeeLastName');
            const updateEmployeeBtn = document.getElementById('updateEmployeeBtn');
            const updateEmployeeBtnText = document.getElementById('updateEmployeeBtnText');
            const updateEmployeeSpinner = document.getElementById('updateEmployeeSpinner');
            const updateEmployeeStatus = document.getElementById('updateEmployeeStatus');
            
            // Job Management
            const fetchAllJobsBtn = document.getElementById('fetchAllJobsBtn');
            const fetchAllJobsBtnText = document.getElementById('fetchAllJobsBtnText');
            const fetchAllJobsSpinner = document.getElementById('fetchAllJobsSpinner');
            const jobDropdown = document.getElementById('jobDropdown');
            const viewSelectedJobBtn = document.getElementById('viewSelectedJobBtn');
            const jobIdsInput = document.getElementById('jobIdsInput');
            const viewJobsBtn = document.getElementById('viewJobsBtn');
            const viewJobsBtnText = document.getElementById('viewJobsBtnText');
            const viewJobsSpinner = document.getElementById('viewJobsSpinner');
            const viewJobsStatus = document.getElementById('viewJobsStatus');
            const assignJobEmployeeDropdown = document.getElementById('assignJobEmployeeDropdown');
            const jobSelectionArea = document.getElementById('jobSelectionArea');
            const assignJobsBtn = document.getElementById('assignJobsBtn');
            const assignJobsBtnText = document.getElementById('assignJobsBtnText');
            const assignJobsSpinner = document.getElementById('assignJobsSpinner');
            const assignJobsStatus = document.getElementById('assignJobsStatus');
            
            // Shift Management
            const shiftsStartDate = document.getElementById('shiftsStartDate');
            const shiftsEndDate = document.getElementById('shiftsEndDate');
            const viewShiftsBtn = document.getElementById('viewShiftsBtn');
            const viewShiftsBtnText = document.getElementById('viewShiftsBtnText');
            const viewShiftsSpinner = document.getElementById('viewShiftsSpinner');
            const viewShiftsStatus = document.getElementById('viewShiftsStatus');
            const shiftEmployeeDropdown = document.getElementById('shiftEmployeeDropdown');
            const shiftJobDropdown = document.getElementById('shiftJobDropdown');
            const shiftStartTime = document.getElementById('shiftStartTime');
            const shiftEndTime = document.getElementById('shiftEndTime');
            const createShiftBtn = document.getElementById('createShiftBtn');
            const createShiftBtnText = document.getElementById('createShiftBtnText');
            const createShiftSpinner = document.getElementById('createShiftSpinner');
            const createShiftStatus = document.getElementById('createShiftStatus');
            
            // Time Entry Management
            const timeEntryQuery = document.getElementById('timeEntryQuery');
            const timeEntryDateInputs = document.getElementById('timeEntryDateInputs');
            const timeEntryBusinessDateInput = document.getElementById('timeEntryBusinessDateInput');
            const timeEntryStartDate = document.getElementById('timeEntryStartDate');
            const timeEntryEndDate = document.getElementById('timeEntryEndDate');
            const businessDate = document.getElementById('businessDate');
            const includeMissedBreaks = document.getElementById('includeMissedBreaks');
            const viewTimeEntriesBtn = document.getElementById('viewTimeEntriesBtn');
            const viewTimeEntriesBtnText = document.getElementById('viewTimeEntriesBtnText');
            const viewTimeEntriesSpinner = document.getElementById('viewTimeEntriesSpinner');
            const viewTimeEntriesStatus = document.getElementById('viewTimeEntriesStatus');
            
            // Time Entry Creation
            const timeEntryEmployeeDropdown = document.getElementById('timeEntryEmployeeDropdown');
            const timeEntryJobDropdown = document.getElementById('timeEntryJobDropdown');
            const timeEntryClockIn = document.getElementById('timeEntryClockIn');
            const timeEntryClockOut = document.getElementById('timeEntryClockOut');
            const timeEntryHoursDisplay = document.getElementById('timeEntryHoursDisplay');
            const timeEntryOvertimeWarning = document.getElementById('timeEntryOvertimeWarning');
            const timeEntryCashTips = document.getElementById('timeEntryCashTips');
            const timeEntryBreakMinutes = document.getElementById('timeEntryBreakMinutes');
            const createTimeEntryBtn = document.getElementById('createTimeEntryBtn');
            const createTimeEntryBtnText = document.getElementById('createTimeEntryBtnText');
            const createTimeEntrySpinner = document.getElementById('createTimeEntrySpinner');
            const createTimeEntryStatus = document.getElementById('createTimeEntryStatus');

            // Custom Field Elements
            const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');
            const customFieldKeyInput = document.getElementById('customFieldKey');
            const customFieldValueInput = document.getElementById('customFieldValue');
            const customFieldsList = document.getElementById('customFieldsList');

            // Menu Management Elements
            const menuStructureSection = document.getElementById('menuStructureSection');
            const menuItemsSection = document.getElementById('menuItemsSection');
            const modifiersSection = document.getElementById('modifiersSection');
            const bulkOperationsSection = document.getElementById('bulkOperationsSection');
            
            // Menu Structure
            const fetchAllMenusBtn = document.getElementById('fetchAllMenusBtn');
            const fetchAllMenusBtnText = document.getElementById('fetchAllMenusBtnText');
            const fetchAllMenusSpinner = document.getElementById('fetchAllMenusSpinner');
            const menuDropdown = document.getElementById('menuDropdown');
            const viewSelectedMenuBtn = document.getElementById('viewSelectedMenuBtn');
            const viewMenusStatus = document.getElementById('viewMenusStatus');
            
            // Menu Groups
            const menuGroupDropdown = document.getElementById('menuGroupDropdown');
            const viewMenuGroupBtn = document.getElementById('viewMenuGroupBtn');
            const viewMenuGroupBtnText = document.getElementById('viewMenuGroupBtnText');
            const viewMenuGroupSpinner = document.getElementById('viewMenuGroupSpinner');
            const createMenuGroupBtn = document.getElementById('createMenuGroupBtn');
            const viewMenuGroupStatus = document.getElementById('viewMenuGroupStatus');
            
            // Menu Items
            const menuItemDropdown = document.getElementById('menuItemDropdown');
            const viewSelectedItemBtn = document.getElementById('viewSelectedItemBtn');
            const itemSearchInput = document.getElementById('itemSearchInput');
            const searchMenuItemsBtn = document.getElementById('searchMenuItemsBtn');
            const searchMenuItemsBtnText = document.getElementById('searchMenuItemsBtnText');
            const searchMenuItemsSpinner = document.getElementById('searchMenuItemsSpinner');
            const createMenuItemBtn = document.getElementById('createMenuItemBtn');
            const searchMenuItemsStatus = document.getElementById('searchMenuItemsStatus');
            
            // Item Operations
            const itemOperationDropdown = document.getElementById('itemOperationDropdown');
            const updateItemPriceBtn = document.getElementById('updateItemPriceBtn');
            const toggleItemAvailabilityBtn = document.getElementById('toggleItemAvailabilityBtn');
            const itemOperationsStatus = document.getElementById('itemOperationsStatus');
            
            // Modifier Management
            const fetchModifierGroupsBtn = document.getElementById('fetchModifierGroupsBtn');
            const fetchModifierGroupsBtnText = document.getElementById('fetchModifierGroupsBtnText');
            const fetchModifierGroupsSpinner = document.getElementById('fetchModifierGroupsSpinner');
            const modifierGroupDropdown = document.getElementById('modifierGroupDropdown');
            const viewModifierGroupBtn = document.getElementById('viewModifierGroupBtn');
            const fetchModifierGroupsStatus = document.getElementById('fetchModifierGroupsStatus');
            
            const modifierOptionDropdown = document.getElementById('modifierOptionDropdown');
            const viewModifierOptionsBtn = document.getElementById('viewModifierOptionsBtn');
            const viewModifierOptionsBtnText = document.getElementById('viewModifierOptionsBtnText');
            const viewModifierOptionsSpinner = document.getElementById('viewModifierOptionsSpinner');
            const createModifierOptionBtn = document.getElementById('createModifierOptionBtn');
            const viewModifierOptionsStatus = document.getElementById('viewModifierOptionsStatus');
            
            // Bulk Operations
            const bulkOperationTypeSelect = document.getElementById('bulkOperationTypeSelect');
            const bulkItemsList = document.getElementById('bulkItemsList');
            const executeBulkOperationBtn = document.getElementById('executeBulkOperationBtn');
            const executeBulkOperationBtnText = document.getElementById('executeBulkOperationBtnText');
            const executeBulkOperationSpinner = document.getElementById('executeBulkOperationSpinner');
            const bulkOperationStatus = document.getElementById('bulkOperationStatus');
            
            // Menu Publishing
            const validateMenuBtn = document.getElementById('validateMenuBtn');
            const publishMenuBtn = document.getElementById('publishMenuBtn');
            const menuPublishingStatus = document.getElementById('menuPublishingStatus');

            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('resultsContainer');

            // --- State Management ---
            let cartItems = [];
            let stagedItemsForUpdate = [];
            let customFields = [];
            let apiLogHistory = [];
            let isProxyActive = false;
            let currentCredentials = { id: '', secret: '' };
            let currentWorkflow = null; // null, 'create', 'fetch', 'update', 'stock', 'labor'
            let activeUpdateOrder = null; // Store the order being updated

            // --- Authentication & Token Management ---
            function getAuthToken() {
                const tokenDataString = localStorage.getItem('toastApiTokenData');
                if (!tokenDataString) return null;

                const tokenData = JSON.parse(tokenDataString);
                if (new Date().getTime() > tokenData.expiry) {
                    localStorage.removeItem('toastApiTokenData');
                    return null;
                }
                return tokenData.token;
            }

            function setAuthToken(token) {
                 const now = new Date();
                const expiry = now.getTime() + 60 * 60 * 1000; // 1 hour in milliseconds
                const tokenData = { token, expiry };
                localStorage.setItem('toastApiTokenData', JSON.stringify(tokenData));
            }

            // --- Local Storage & Saved Locations ---
            function loadSavedLocations() {
                const locations = JSON.parse(localStorage.getItem('toastTestClientLocations')) || [];
                savedLocationsSelect.innerHTML = '<option value="">Load a saved location...</option>'; // Reset
                
                if (locations.length > 0) {
                    locations.forEach((loc, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = loc.name;
                        savedLocationsSelect.appendChild(option);
                    });
                    configWrapper.insertBefore(savedLocationsSection, configWrapper.firstChild);
                    savedLocationsSection.style.display = 'block';
                } else {
                    savedLocationsSection.style.display = 'none';
                }
            }

            function saveLocation(name, guid, id, secret) {
                let locations = JSON.parse(localStorage.getItem('toastTestClientLocations')) || [];
                const locationName = `${name} (${guid.substring(0, 8)}...)`;
                const newLocation = { name: locationName, restaurantGuid: guid, clientId: id, clientSecret: secret };
                const existingIndex = locations.findIndex(loc => loc.restaurantGuid === guid && loc.clientId === id);


                if (existingIndex > -1) {
                    locations[existingIndex] = newLocation;
                } else {
                    locations.push(newLocation);
                }
                localStorage.setItem('toastTestClientLocations', JSON.stringify(locations));
                loadSavedLocations();
            }


            // --- UI Management ---
            function updateUIState() {
                if (!isProxyActive) {
                    mainContent.classList.add('hidden');
                    proxySectionWrapper.classList.remove('hidden');
                    return;
                }
                
                mainContent.classList.remove('hidden');
                proxySectionWrapper.classList.add('hidden');
                loadSavedLocations(); 
                
                const token = getAuthToken();
                const isRestaurantSelected = !configFetchSection.classList.contains('hidden');
                
                // Hide all dynamic sections first
                workflowWrapper.style.display = 'none';
                workflowSelectionSection.style.display = 'none';
                orderBuilderSection.style.display = 'none';
                fetchOrderSection.style.display = 'none';
                updateOrderSection.style.display = 'none';
                stockManagementSection.style.display = 'none';
                employeeManagementSection.style.display = 'none';
                jobManagementSection.style.display = 'none';
                shiftManagementSection.style.display = 'none';
                timeEntryManagementSection.style.display = 'none';
                menuStructureSection.style.display = 'none';
                menuItemsSection.style.display = 'none';
                modifiersSection.style.display = 'none';
                bulkOperationsSection.style.display = 'none';
                resultsSection.style.display = 'none';

                if (token) {
                    authForm.style.display = 'none';
                    authenticatedView.style.display = 'block';
                    maskedClientId.value = '************' + currentCredentials.id.slice(-4);
                    maskedClientSecret.value = '************' + currentCredentials.secret.slice(-4);

                    if (isRestaurantSelected) {
                        configWrapper.style.display = 'none';
                        workflowWrapper.style.display = 'block';
                        toggleConfigBtn.classList.remove('hidden');
                        toggleNavBtn.classList.remove('hidden');
                        
                        // Move config sections to the slide-out panel
                        configPanelContent.appendChild(savedLocationsSection);
                        configPanelContent.appendChild(authSection);
                        configPanelContent.appendChild(dataFetchSection);
                        
                        // workflowSelectionSection.style.display = 'block'; // Now using navigation panel
                        resultsSection.style.display = 'block'; 
                        
                        // Show welcome message if no workflow is selected
                        if (!currentWorkflow) {
                            resultsContainer.innerHTML = `
                                <div class="text-center py-12">
                                    <div class="mb-6">
                                        <svg class="w-16 h-16 mx-auto text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-3">Welcome to Toast API Test Client</h3>
                                    <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">
                                        Use the navigation menu (â˜°) on the left to select an API workflow and start testing Toast API endpoints.
                                    </p>
                                    <div class="flex justify-center">
                                        <button id="welcomeNavBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition inline-flex items-center">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                            </svg>
                                            Open API Workflows
                                        </button>
                                    </div>
                                </div>
                            `;
                        }

                        switch (currentWorkflow) {
                            case 'create':
                                orderBuilderSection.style.display = 'block';
                                break;
                            case 'fetch':
                                fetchOrderSection.style.display = 'block';
                                break;
                            case 'update':
                                updateOrderSection.style.display = 'block';
                                break;
                            case 'stock':
                                stockManagementSection.style.display = 'block';
                                break;
                            case 'employee-management':
                                employeeManagementSection.style.display = 'block';
                                break;
                            case 'shift-management':
                                shiftManagementSection.style.display = 'block';
                                break;
                            case 'job-management':
                                jobManagementSection.style.display = 'block';
                                break;
                            case 'time-entry-management':
                                timeEntryManagementSection.style.display = 'block';
                                break;
                            case 'menu-structure':
                                menuStructureSection.style.display = 'block';
                                break;
                            case 'menu-items':
                                menuItemsSection.style.display = 'block';
                                break;
                            case 'modifiers':
                                modifiersSection.style.display = 'block';
                                break;
                            case 'bulk-operations':
                                bulkOperationsSection.style.display = 'block';
                                break;
                            default:
                                break;
                        }
                    } else {
                        configWrapper.style.display = 'block';
                        workflowWrapper.style.display = 'none';
                        toggleConfigBtn.classList.add('hidden');
                        toggleNavBtn.classList.add('hidden');
                    }
                } else {
                    authForm.style.display = 'block';
                    authenticatedView.style.display = 'none';
                }
            }

            function showInlineStatus(element, status, message, isError) {
                if (!element) return;
                const colorClass = isError ? 'text-red-500' : 'text-green-500';
                
                // Check if message contains HTML (for enhanced error messages like scope errors)
                if (message.includes('<div') || message.includes('<p') || message.includes('<a')) {
                    // For HTML messages, display them directly with just a status prefix
                    element.innerHTML = `
                        <div class="border-l-4 ${isError ? 'border-red-500 bg-red-50 dark:bg-red-900/10' : 'border-green-500 bg-green-50 dark:bg-green-900/10'} p-4 rounded-r-lg">
                            <div class="text-xs font-mono ${colorClass} mb-2">[${status}]</div>
                            ${message}
                        </div>
                    `;
                    setTimeout(() => { element.innerHTML = ''; }, 15000); // Longer timeout for detailed messages
                } else {
                    // For simple text messages, use the original format
                    element.innerHTML = `<p class="${colorClass} font-medium">[${status}] ${message}</p>`;
                    setTimeout(() => { element.innerHTML = ''; }, 5000);
                }
            }
            
            function renderApiLogHistory() {
                if (apiLogHistory.length === 0) {
                    logContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No API calls logged yet.</p>';
                    return;
                }

                logContainer.innerHTML = apiLogHistory.map(log => {
                    const reqBodyText = log.reqBody ? JSON.stringify(log.reqBody, null, 2) : 'No request body sent.';
                    const resBodyText = JSON.stringify(log.resBody, null, 2);
                    const shortUrl = log.fullUrl.replace(CORS_PROXY, '').replace(environmentSelect.value, '');
                    
                    return `
                    <details class="bg-gray-100 dark:bg-gray-900 rounded-md">
                        <summary class="p-3 cursor-pointer flex justify-between items-center list-none">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <span class="font-bold px-2 py-1 text-xs rounded ${log.statusClass}">${log.status}</span>
                                <span class="font-mono text-sm flex-shrink-0">${log.method || '...'}</span>
                                <code class="text-sm truncate">${shortUrl}</code>
                            </div>
                            <span class="text-xs text-gray-500 dark:text-gray-400 flex-shrink-0 ml-2">${log.timestamp.toLocaleTimeString()}</span>
                        </summary>
                        <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
                            <div>
                                <h3 class="text-md font-semibold mb-1">Request URL</h3>
                                <div class="bg-gray-200 dark:bg-gray-800 rounded-md p-2">
                                    <code class="text-xs break-all">${log.fullUrl}</code>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-md font-semibold mb-1">Request Payload</h3>
                                <div class="bg-gray-200 dark:bg-gray-800 rounded-md p-2 max-h-64 overflow-y-auto">
                                    <pre><code class="text-sm break-words whitespace-pre-wrap">${reqBodyText}</code></pre>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-md font-semibold mb-1">API Response</h3>
                                <div class="bg-gray-200 dark:bg-gray-800 rounded-md p-2 max-h-64 overflow-y-auto">
                                    <pre><code class="text-sm break-words whitespace-pre-wrap">${resBodyText}</code></pre>
                                </div>
                            </div>
                        </div>
                    </details>
                    `;
                }).join('');
            }


            function logApiCall(logData) {
                const timestamp = new Date();
                apiLogHistory.unshift({ ...logData, timestamp }); // Add to the beginning of the array
                renderApiLogHistory();
            }


            // --- API Call Functions ---
            
            async function testProxyConnection() {
                testProxyBtn.disabled = true;
                testProxyBtnText.textContent = "Testing...";
                testProxySpinner.classList.remove('hidden');
                proxyStatus.innerHTML = '';
                
                const testUrl = CORS_PROXY + environmentSelect.value + AUTH_PATH;
                try {
                    const response = await fetch(testUrl, { method: 'HEAD', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                    
                    if (response.ok || response.status === 405) { // 405 is also a valid proxy response for HEAD
                        proxyStatus.innerHTML = `<p class="text-green-600 dark:text-green-400 font-medium">Proxy connection successful! You may now authenticate.</p>`;
                        isProxyActive = true;
                        updateUIState();
                    } else {
                         throw new Error(`Proxy returned status: ${response.status}`);
                    }
                } catch (error) {
                     proxyStatus.innerHTML = `<p class="text-red-500 font-medium">Proxy test failed. Please ensure you have activated it in the other tab.</p>`;
                } finally {
                    testProxyBtn.disabled = false;
                    testProxyBtnText.textContent = "2. Test Proxy Connection";
                    testProxySpinner.classList.add('hidden');
                }
            }


            function handleLogout() {
                localStorage.removeItem('toastApiTokenData');
                currentCredentials = { id: '', secret: '' };
                currentWorkflow = null;
                apiLogHistory = [];
                renderApiLogHistory();
                configFetchSection.classList.add('hidden');
                authSection.open = true;
                dataFetchSection.open = true;

                // Move config sections back to the main wrapper
                configWrapper.appendChild(savedLocationsSection);
                configWrapper.appendChild(authSection);
                configWrapper.appendChild(dataFetchSection);
                updateUIState();
            }

            async function makeApiCall(url, method = 'GET', body = null, statusElement, successMessage = 'Fetch successful.') {
                try {
                    const headers = {
                        'X-Requested-With': 'XMLHttpRequest',
                    };
                    
                    const token = getAuthToken();
                    // Add auth token if it exists and it's not the login call
                    if (token && !url.includes(AUTH_PATH)) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
            
                    // Add restaurant header if it's not an authentication call
                    if (!url.includes(AUTH_PATH)) {
                        const restaurantGuid = restaurantGuidInput.value.trim();
                        if (restaurantGuid) {
                           headers['Toast-Restaurant-External-Id'] = restaurantGuid;
                        }
                    }
                    
                    if (method !== 'GET' && method !== 'DELETE') {
                       headers['Content-Type'] = 'application/json';
                    }

                    const options = { method, headers };
                    if (body) {
                        options.body = JSON.stringify(body);
                    }

                    // Debug logging for shift creation requests
                    if (url.includes('shifts') && method === 'POST') {
                        console.log('=== HTTP REQUEST DEBUG ===');
                        console.log('URL:', url);
                        console.log('Method:', method);
                        console.log('Headers:', JSON.stringify(headers, null, 2));
                        console.log('Body:', options.body);
                        console.log('Request options:', JSON.stringify(options, null, 2));
                    }

                    const response = await fetch(url, options);
                    const responseText = await response.text();
                    const data = responseText ? JSON.parse(responseText) : null;

                    // Debug logging for POST responses
                    if ((url.includes('shifts') || url.includes('timeEntries')) && method === 'POST') {
                        console.log('=== HTTP RESPONSE DEBUG ===');
                        console.log('Status:', response.status);
                        console.log('Status Text:', response.statusText);
                        console.log('Response Headers:', Object.fromEntries(response.headers.entries()));
                        console.log('Allow Header:', response.headers.get('Allow')); // Shows allowed methods
                        console.log('Response Body (raw):', responseText);
                        console.log('Response Body (parsed):', data);
                        console.log('Response OK:', response.ok);
                        
                        if (response.status === 405) {
                            console.log('=== 405 METHOD NOT ALLOWED DEBUG ===');
                            console.log('This endpoint does not support POST method');
                            console.log('Allowed methods:', response.headers.get('Allow') || 'Not specified');
                        }
                    }


                    if (response.ok) {
                        logApiCall({
                            status: response.status,
                            statusClass: 'text-green-800 bg-green-100 dark:bg-green-900 dark:text-green-300',
                            resBody: data, reqBody: body, fullUrl: url, method: method
                        });
                        if(statusElement) showInlineStatus(statusElement, response.status, successMessage, false);
                        return { data, error: null };
                    } else {
                        let errorMessage = (data && data.message) || 'An error occurred.';
                        if (errorMessage.includes('You are not permitted to access this resource')) {
                            errorMessage = `
                                <div class="space-y-3">
                                    <div class="font-semibold text-red-700 dark:text-red-300">ðŸ”’ Permission Denied</div>
                                    <div class="text-sm">
                                        <p class="mb-2">You don't have the required API scopes to access this resource.</p>
                                        <p class="mb-3"><strong>What this means:</strong> Your Toast API client credentials may not be configured with the correct permissions for this operation.</p>
                                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-3 mb-3">
                                            <p class="text-yellow-800 dark:text-yellow-200 text-xs">
                                                <strong>ðŸ’¡ Next Steps:</strong><br>
                                                â€¢ Contact your Toast integration team to request the required scopes<br>
                                                â€¢ Review the scopes documentation to understand what permissions you need<br>
                                                â€¢ Verify your API client has the correct scopes for this functionality
                                            </p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs">ðŸ“–</span>
                                            <a href="https://doc.toasttab.com/doc/devguide/apiScopes.html" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium underline">
                                                View Toast API Scopes Documentation
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }

                        logApiCall({
                            status: response.status,
                            statusClass: 'text-red-800 bg-red-100 dark:bg-red-900 dark:text-red-300',
                            resBody: data, reqBody: body, fullUrl: url, method: method
                        });

                        if(statusElement) showInlineStatus(statusElement, response.status, errorMessage, true);
                        return { data: null, error: data };
                    }
                } catch(error) {
                    logApiCall({
                        status: 'NET',
                        statusClass: 'text-yellow-800 bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-300',
                        resBody: { message: error.message }, reqBody: body, fullUrl: url, method: method
                    });
                    if(statusElement) showInlineStatus(statusElement, 'NET', 'Network or CORS Proxy Error', true);
                    return { data: null, error: { message: 'Network or CORS Proxy Error' } };
                }
            }

             async function handleAuthentication() {
                authBtn.disabled = true;
                authBtnText.textContent = 'Authenticating...';
                authSpinner.classList.remove('hidden');

                currentCredentials.id = clientIdInput.value.trim();
                currentCredentials.secret = clientSecretInput.value.trim();
                
                if (!currentCredentials.id || !currentCredentials.secret) {
                    showInlineStatus(authStatus, 'Client Error', 'Client ID and Secret are required.', true);
                } else {
                    const apiBase = environmentSelect.value;
                    const authPayload = { clientId: currentCredentials.id, clientSecret: currentCredentials.secret, userAccessType: "TOAST_MACHINE_CLIENT" };
                    const fullUrl = CORS_PROXY + apiBase + AUTH_PATH;
                    
                    const { data } = await makeApiCall(fullUrl, 'POST', authPayload, authStatus, 'Authentication Successful!');

                    if (data) {
                        setAuthToken(data.token.accessToken);
                        authSection.open = false; // Collapse on success
                        updateUIState();
                    }
                }
                
                authBtn.disabled = false;
                authBtnText.textContent = 'Authenticate';
                authSpinner.classList.add('hidden');
            }

            async function fetchRestaurantName() {
                fetchRestaurantNameBtn.disabled = true;
                fetchRestaurantNameSpinner.classList.remove('hidden');
                fetchRestaurantNameBtnText.textContent = 'Fetching';
                
                const restaurantGuid = restaurantGuidInput.value.trim();
                if (!getAuthToken()) {
                    showInlineStatus(restaurantNameStatus, 'Client Error', "Auth token missing. Please re-authenticate.", true);
                    handleLogout();
                } else if (!restaurantGuid) {
                    showInlineStatus(restaurantNameStatus, 'Client Error', "Restaurant GUID is required.", true);
                } else {
                    const apiBase = environmentSelect.value;
                    const fullUrl = CORS_PROXY + apiBase + `${RESTAURANTS_PATH}/${restaurantGuid}`;
                    const { data } = await makeApiCall(fullUrl, 'GET', null, restaurantNameStatus, "Successfully fetched restaurant.");
                    
                    if (data) {
                        const name = data.general.name;
                        restaurantName.textContent = name;
                        configFetchSection.classList.remove('hidden');
                        saveLocation(name, restaurantGuid, currentCredentials.id, currentCredentials.secret);
                        dataFetchSection.open = false; // Collapse on success
                        updateUIState();
                        fetchAllConfig();
                    }
                }
                
                fetchRestaurantNameBtn.disabled = false;
                fetchRestaurantNameSpinner.classList.add('hidden');
                fetchRestaurantNameBtnText.textContent = 'Fetch Restaurant';
            }

            
            async function fetchAllConfig() {
                 fetchAllConfigBtn.disabled = true;
                 fetchAllConfigBtnText.textContent = '';
                 fetchAllConfigSpinner.classList.remove('hidden');
                 showInlineStatus(allConfigStatus, '...', 'Fetching all config...', false);
                
                 const fetches = [
                    {urlPath: DINING_OPTIONS_PATH, selectElement: diningOptionsSelect, dataParser: parseDiningOptions },
                    {urlPath: EMPLOYEES_PATH, selectElement: employeeSelect, dataParser: parseEmployees },
                    {urlPath: MENUS_PATH, selectElement: itemSelectAdd, dataParser: parseMenus },
                    {urlPath: DISCOUNTS_PATH, selectElement: discountSelect, dataParser: parseDiscounts },
                    {urlPath: TAXES_PATH, selectElement: taxSelect, dataParser: parseTaxes },
                    {urlPath: ALTERNATE_PAYMENT_TYPES_PATH, selectElement: alternatePaymentTypeSelect, dataParser: parseAlternatePaymentTypes }
                 ];

                 try {
                    await Promise.all(fetches.map(f => fetchAndPopulate(f)));
                    showInlineStatus(allConfigStatus, '200', "All configuration fetched successfully!", false);
                 } catch (error) {
                    showInlineStatus(allConfigStatus, 'Error', "An error occurred during fetch.", true);
                 } finally {
                    fetchAllConfigBtn.disabled = false;
                    fetchAllConfigBtnText.textContent = 'Fetch All';
                    fetchAllConfigSpinner.classList.add('hidden');
                 }
            }


             async function fetchAndPopulate(options) {
                const { urlPath, selectElement, dataParser } = options;
                
                const apiBase = environmentSelect.value;
                const fullUrl = CORS_PROXY + apiBase + urlPath;
                const { data, error } = await makeApiCall(fullUrl, 'GET', null, null);

                if(data) {
                    selectElement.innerHTML = dataParser(data);
                } else {
                     throw new Error('Failed to fetch ' + urlPath);
                }
            }

            // Data Parsers
            const parseDiningOptions = data => `<option value="">Select Dining Option</option>` + data.map(opt => `<option value="${opt.guid}">${opt.name}</option>`).join('');
            const parseEmployees = data => `<option value="">Select Employee</option>` + data.map(emp => `<option value="${emp.guid}">${emp.firstName} ${emp.lastName}</option>`).join('');
            const parseDiscounts = data => `<option value="">Select Discount</option>` + data.map(d => `<option value="${d.guid}" data-type="${d.discountType}" data-selection-type="${d.selectionType}">${d.name}</option>`).join('');
            const parseTaxes = data => `<option value="">Select Tax</option>` + data.map(t => `<option value="${t.guid}">${t.name} (${t.rate}%)</option>`).join('');
            const parseAlternatePaymentTypes = data => `<option value="">Select Payment Type</option>` + data.map(p => `<option value="${p.guid}">${p.name}</option>`).join('');
            const parseMenus = data => {
                const menuList = data.menus || (Array.isArray(data) ? data : [data]);
                let optionsHtml = '';

                menuList.forEach(menu => {
                    (menu.menuGroups || []).forEach(group => {
                        const itemOptions = (group.menuItems || [])
                            .map(item => `<option value="${item.guid}|${group.guid}">${item.name}</option>`)
                            .join('');

                        if (itemOptions) {
                             optionsHtml += `<optgroup label="${group.name || 'Unnamed Group'}">${itemOptions}</optgroup>`;
                        }
                    });
                });

                if (!optionsHtml) {
                    return `<option value="">No items found in menu(s).</option>`;
                }
                
                return `<option value="">Select an item</option>` + optionsHtml;
            };

            // --- Order Management (Create) ---
            function renderCart() {
                if (cartItems.length === 0) {
                    itemsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Cart is empty.</p>';
                } else {
                    itemsList.innerHTML = cartItems.map((item, index) => `
                        <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-md">
                            <div>
                                <p class="font-semibold">${item.quantity}x ${item.name}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400 font-mono">${item.guid}</p>
                            </div>
                            <button data-index="${index}" class="removeItemBtn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-sm">Remove</button>
                        </div>
                    `).join('');
                }
                // When cart changes, re-evaluate discount display
                handleDiscountSelectChange({ target: discountSelect });
            }
            
            function renderCustomFields() {
                if (customFields.length === 0) {
                    customFieldsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No custom fields added.</p>';
                    return;
                }
                customFieldsList.innerHTML = customFields.map((field, index) => `
                    <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-3 rounded-md">
                        <div>
                            <p class="font-semibold font-mono">${field.key}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Value: <code class="bg-gray-200 dark:bg-gray-600 p-1 rounded">${field.value}</code></p>
                        </div>
                        <button data-index="${index}" class="removeCustomFieldBtn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-sm">Remove</button>
                    </div>
                `).join('');
            }

            function setNestedValue(obj, path, value) {
                const keys = path.split('.');
                let current = obj;
                for (let i = 0; i < keys.length - 1; i++) {
                    const key = keys[i];
                    if (!current[key] || typeof current[key] !== 'object') {
                        current[key] = {};
                    }
                    current = current[key];
                }
                current[keys[keys.length - 1]] = value;
            }

            function smartParse(value) {
                const trimmedValue = value.trim();
                if (trimmedValue === '') return value;

                if (!isNaN(trimmedValue) && !isNaN(parseFloat(trimmedValue)) && Number.isFinite(Number(trimmedValue))) {
                    return parseFloat(trimmedValue);
                }
                if (trimmedValue.toLowerCase() === 'true') return true;
                if (trimmedValue.toLowerCase() === 'false') return false;
                if ((trimmedValue.startsWith('{') && trimmedValue.endsWith('}')) || (trimmedValue.startsWith('[') && trimmedValue.endsWith(']'))) {
                    try {
                        return JSON.parse(trimmedValue);
                    } catch (e) { /* Fallback to string */ }
                }
                return value; // Return original string if no other type matches
            }


            async function createAndSendOrder() {
                sendOrderBtn.disabled = true;
                sendOrderBtnText.textContent = 'Sending...';
                sendOrderSpinner.classList.remove('hidden');

                const unhideButton = () => {
                    sendOrderBtn.disabled = false;
                    sendOrderBtnText.textContent = 'Create & Send Order';
                    sendOrderSpinner.classList.add('hidden');
                };

                if (!diningOptionsSelect.value) {
                    showInlineStatus(sendOrderStatus, 'Validation Error', 'A Dining Option is required to create an order.', true);
                    unhideButton();
                    return;
                }

                if (cartItems.length === 0) {
                    showInlineStatus(sendOrderStatus, 'Client Error', 'Cannot send an empty order.', true);
                    unhideButton();
                    return;
                } 
                
                const isDelivery = deliveryInfoSection.style.display === 'block';
                if (isDelivery && (!guestFirstNameInput.value || !guestLastNameInput.value || !guestPhoneInput.value)) {
                    showInlineStatus(sendOrderStatus, 'Validation Error', 'First Name, Last Name, and Phone are required for delivery.', true);
                    unhideButton();
                    return;
                }
                
                const apiBase = environmentSelect.value;
                 const selections = cartItems.map(item => ({
                    item: { guid: item.guid },
                    itemGroup: { guid: item.itemGroupGuid },
                    quantity: parseInt(item.quantity, 10),
                    modifiers: []
                }));

                const orderPayload = {
                    diningOption: { "guid": diningOptionsSelect.value },
                    checks: [{
                        selections: selections
                    }]
                };

                const selectedDiscountOption = discountSelect.options[discountSelect.selectedIndex];
                if (selectedDiscountOption && selectedDiscountOption.value) {
                    const discountGuid = selectedDiscountOption.value;
                    const discountType = selectedDiscountOption.dataset.type;
                    const selectionType = selectedDiscountOption.dataset.selectionType;

                    const appliedDiscount = {
                        discount: { guid: discountGuid }
                    };

                    const openTypes = ['OPEN_FIXED', 'OPEN_PERCENT'];
                    if (openTypes.includes(discountType)) {
                        const discountValue = parseFloat(discountValueInput.value);

                         if (isNaN(discountValue) || discountValue <= 0) {
                            showInlineStatus(sendOrderStatus, 'Validation Error', 'Please enter a valid, positive discount value.', true);
                            unhideButton();
                            return;
                        }
                        if (discountType === 'OPEN_PERCENT') {
                            appliedDiscount.discountPercent = discountValue;
                        } else { // OPEN_FIXED
                            appliedDiscount.discountAmount = discountValue;
                        }
                    }
                    
                    if (selectionType === 'ITEM') {
                        const itemSelectCreate = document.getElementById('discountItemSelectCreate');
                        const selectedItemIndex = itemSelectCreate.value;

                        if (selectedItemIndex === "") {
                            showInlineStatus(sendOrderStatus, 'Validation Error', 'Please select an item to apply the discount to.', true);
                            unhideButton();
                            return;
                        }
                        const selectionToDiscount = orderPayload.checks[0].selections[selectedItemIndex];
                        if (selectionToDiscount) {
                            if (!selectionToDiscount.appliedDiscounts) {
                                selectionToDiscount.appliedDiscounts = [];
                            }
                            selectionToDiscount.appliedDiscounts.push(appliedDiscount);
                        }
                    } else { 
                        orderPayload.checks[0].appliedDiscounts = [appliedDiscount];
                    }
                }

                // Add selected tax to the payload
                const selectedTaxOption = taxSelect.options[taxSelect.selectedIndex];
                if (selectedTaxOption && selectedTaxOption.value) {
                    orderPayload.checks[0].appliedTaxes = [{
                        taxRate: { guid: selectedTaxOption.value }
                    }];
                }
                
                const customerFirstName = guestFirstNameInput.value.trim();
                const customerLastName = guestLastNameInput.value.trim();
                const customerPhone = guestPhoneInput.value.trim();
                const customerEmail = guestEmailInput.value.trim();

                if (customerFirstName || customerLastName || customerPhone || customerEmail) {
                    orderPayload.checks[0].customer = { firstName: customerFirstName, lastName: customerLastName, phone: customerPhone, email: customerEmail };
                }

                if(isDelivery) {
                    orderPayload.deliveryInfo = { address1: deliveryAddress1Input.value, city: deliveryCityInput.value, state: deliveryStateInput.value, zipCode: deliveryZipInput.value, notes: deliveryNotesInput.value };
                }
                
                customFields.forEach(field => setNestedValue(orderPayload, field.key, smartParse(field.value)));

                const fullUrl = CORS_PROXY + apiBase + ORDERS_PATH;
                const { data } = await makeApiCall(fullUrl, 'POST', orderPayload, sendOrderStatus, 'Order created successfully!');
                
                if (data) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.appendChild(createToggleView(data));
                }

                unhideButton();
            }
            
            // --- Fetch/Review Order Functions ---
            async function fetchOrderByGuid() {
                const orderGuid = fetchOrderGuidInput.value.trim();
                if(!orderGuid) {
                    showInlineStatus(fetchOrderByGuidStatus, 'Client Error', 'Please enter an Order GUID.', true);
                    return;
                }
                const apiBase = environmentSelect.value;
                const fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${orderGuid}`;
                
                resultsContainer.innerHTML = `<div class="flex justify-center items-center"><div class="spinner spinner-dark"></div><p class="ml-2">Fetching...</p></div>`;
                const { data } = await makeApiCall(fullUrl, 'GET', null, fetchOrderByGuidStatus);

                if (data) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.appendChild(createToggleView(data));
                } else {
                     resultsContainer.innerHTML = `<p class="text-red-500">Failed to fetch. See API log for details.</p>`;
                }
            }

            async function fetchOrdersByDate() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                if (!startDate || !endDate) {
                    showInlineStatus(fetchOrdersByDateStatus, 'Client Error', 'Please select both a start and end date.', true);
                    return;
                }
                const apiBase = environmentSelect.value;
                const formattedStartDate = new Date(startDate).toISOString();
                const formattedEndDate = new Date(endDate).toISOString();
                
                const params = new URLSearchParams({ startDate: formattedStartDate, endDate: formattedEndDate, pageSize: 100 });
                const fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}Bulk?${params.toString()}`;
                
                resultsContainer.innerHTML = `<div class="flex justify-center items-center"><div class="spinner spinner-dark"></div><p class="ml-2">Fetching...</p></div>`;
                const { data } = await makeApiCall(fullUrl, 'GET', null, fetchOrdersByDateStatus);

                if (data) {
                    if (data.length > 0) {
                        resultsContainer.innerHTML = data.map(order => {
                            const status = getOrderStatus(order);
                            const statusFlag = `<span class="ml-3 px-2 py-1 text-xs font-bold rounded-full ${status.bgClass} ${status.textClass}">${status.text}</span>`;
                            
                            return `
                            <details class="bg-gray-100 dark:bg-gray-700 rounded-md" data-guid="${order.guid}">
                                <summary class="p-3 cursor-pointer font-semibold flex justify-between items-center list-none">
                                    <div class="flex items-center">
                                      <span>Order GUID: <span class="font-mono">${order.guid}</span></span>
                                      ${statusFlag}
                                    </div>
                                    <div class="text-right">
                                       <p class="text-sm text-gray-500 dark:text-gray-400">${new Date(order.openedDate).toLocaleString()}</p>
                                       <p class="text-xs font-normal text-gray-500 dark:text-gray-400">Type: ${order.diningOption ? order.diningOption.name : 'N/A'}</p>
                                    </div>
                                </summary>
                                <div class="p-3 border-t border-gray-200 dark:border-gray-600 order-details-content">
                                    <p class="text-sm text-gray-500">Loading details...</p>
                                </div>
                            </details>
                        `}).join('');
                    } else {
                        resultsContainer.innerHTML = `<p>No orders found in the selected time range.</p>`;
                    }
                } else {
                    resultsContainer.innerHTML = `<p class="text-red-500">Failed to fetch orders. See API log for details.</p>`;
                }
            }
            
            async function fetchAndDisplayOrderDetails(detailsElement) {
                const guid = detailsElement.dataset.guid;
                const contentDiv = detailsElement.querySelector('.order-details-content');

                if (!guid || detailsElement.dataset.loaded === 'true') return;

                const apiBase = environmentSelect.value;
                const fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${guid}`;
                
                const { data } = await makeApiCall(fullUrl, 'GET', null, null);
                
                if (data) {
                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(createToggleView(data, true));
                    detailsElement.dataset.loaded = 'true';
                } else {
                    contentDiv.innerHTML = `<p class="text-red-500 text-sm">Failed to load order details. See API Log.</p>`;
                }
            }


            // --- Update Order Functions ---
            async function loadOrderForUpdate() {
                const orderGuid = updateOrderGuidInput.value.trim();
                if(!orderGuid) {
                    showInlineStatus(loadOrderForUpdateStatus, 'Client Error', 'Please enter an Order GUID.', true);
                    return;
                }
                const apiBase = environmentSelect.value;
                const fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${orderGuid}`;
                
                resultsContainer.innerHTML = `<div class="flex justify-center items-center"><div class="spinner spinner-dark"></div><p class="ml-2">Fetching...</p></div>`;
                const { data } = await makeApiCall(fullUrl, 'GET', null, loadOrderForUpdateStatus);

                if (data) {
                    activeUpdateOrder = data;
                    stagedItemsForUpdate = [];
                    renderUpdateEditor(data);
                } else {
                    resultsContainer.innerHTML = `<p class="text-red-500">Failed to load order for update. See API log.</p>`;
                }
            }
            
            function renderUpdateEditor(order) {
                const guestOrderStatus = order.guestOrderStatus;
                const isVoided = order.voided;
                
                // An order is considered editable if its guestOrderStatus is not CLOSED or VOIDED.
                const isEditable = guestOrderStatus !== 'CLOSED' && guestOrderStatus !== 'VOIDED' && !isVoided;

                const receiptHtml = renderReceipt(order); 

                let modificationHtml = '';
                if (isEditable) {
                    modificationHtml = `
                        <div class="p-4 bg-gray-200 dark:bg-gray-700 rounded-md">
                            <h4 class="font-semibold">Add Items to Check</h4>
                            <div class="flex items-end gap-4 flex-wrap mt-2">
                                <div class="flex-grow">
                                    <label for="itemSelectUpdate" class="block text-sm font-medium mb-1">Select Item</label>
                                    <select id="itemSelectUpdate" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500"></select>
                                </div>
                                <div>
                                    <label for="itemQuantityUpdate" class="block text-sm font-medium mb-1">Quantity</label>
                                    <input type="number" id="itemQuantityUpdate" value="1" min="1" class="w-24 bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500">
                                </div>
                                <button id="stageItemBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-md transition">Stage Item</button>
                            </div>
                            <div id="stagedItemsList" class="mt-4 space-y-2"></div>
                             <button id="addStagedItemsBtn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition hidden">Add Staged Items to Check</button>
                        </div>
                        <div class="p-4 bg-gray-200 dark:bg-gray-700 rounded-md">
                            <h4 class="font-semibold">Apply Discount</h4>
                            <div class="mt-2 space-y-2">
                                <select id="discountSelectUpdate" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500"></select>
                                <div id="discountItemSelectorContainer" class="hidden mt-2">
                                    <label for="discountItemSelect" class="block text-sm font-medium mb-1">Apply to Item</label>
                                    <select id="discountItemSelect" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500"></select>
                                </div>
                                <div id="discountDetailsSectionUpdate" class="hidden mt-2 p-3 bg-gray-100 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600">
                                    <label for="discountValueInputUpdate" id="discountValueLabelUpdate" class="block text-sm font-medium mb-1">Discount Value</label>
                                    <input type="number" id="discountValueInputUpdate" step="0.01" placeholder="Enter value" class="w-full bg-white dark:bg-gray-500 rounded-md p-2 border border-gray-300 dark:border-gray-400">
                                </div>
                                <button id="applyDiscountBtn" class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition">Apply Discount</button>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-200 dark:bg-gray-700 rounded-md">
                            <h4 class="font-semibold">Add Payment</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Target Check GUID: ${order.checks[0].guid}</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div>
                                    <label for="alternatePaymentTypeSelectUpdate" class="block text-sm font-medium mb-1">Payment Type</label>
                                    <select id="alternatePaymentTypeSelectUpdate" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500"></select>
                                </div>
                                <div>
                                    <label for="paymentAmountInput" class="block text-sm font-medium mb-1">Amount</label>
                                    <input type="number" id="paymentAmountInput" placeholder="Amount" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="tipAmountInput" class="block text-sm font-medium mb-1">Tip Amount</label>
                                    <input type="number" id="tipAmountInput" placeholder="Tip" value="0" class="w-full bg-gray-50 dark:bg-gray-600 rounded-md p-2 border border-gray-300 dark:border-gray-500">
                                </div>
                            </div>
                            <button id="addPaymentBtn" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition">Add Payment</button>
                        </div>
                        <div class="p-4 bg-gray-200 dark:bg-gray-700 rounded-md">
                             <h4 class="font-semibold">Void Entire Order</h4>
                            <button id="voidOrderBtn" class="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md transition">Void Order</button>
                        </div>
                    `;
                } else {
                     modificationHtml = `
                        <div class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300 p-4 rounded-md" role="alert">
                            <p class="font-bold">Order Not Editable</p>
                            <p>This order's status is <strong>${isVoided ? 'VOIDED' : guestOrderStatus}</strong> and it cannot be modified through this tool.</p>
                        </div>
                    `;
                }

                 resultsContainer.innerHTML = `
                    <h3 class="text-lg font-bold">Editing Order: ${order.guid}</h3>
                    <div class="my-4">${receiptHtml}</div>
                    <div id="updateActionStatus" class="mt-2 text-sm text-center"></div>
                    <div class="space-y-4 mt-4">
                        ${modificationHtml}
                    </div>
                `;

                 if (isEditable) {
                    const itemSelectUpdate = document.getElementById('itemSelectUpdate');
                    const alternatePaymentTypeSelectUpdate = document.getElementById('alternatePaymentTypeSelectUpdate');
                    const discountSelectUpdate = document.getElementById('discountSelectUpdate');

                    if (itemSelectUpdate && alternatePaymentTypeSelectUpdate && discountSelectUpdate) {
                        itemSelectUpdate.innerHTML = itemSelectAdd.innerHTML;
                        alternatePaymentTypeSelectUpdate.innerHTML = alternatePaymentTypeSelect.innerHTML;
                        discountSelectUpdate.innerHTML = discountSelect.innerHTML;
                        discountSelectUpdate.addEventListener('change', handleDiscountSelectChange);
                        renderStagedItems();
                    }
                }
            }
            
            function renderStagedItems() {
                const stagedItemsList = document.getElementById('stagedItemsList');
                const addStagedItemsBtn = document.getElementById('addStagedItemsBtn');
                if (!stagedItemsList || !addStagedItemsBtn) return;
                
                if (stagedItemsForUpdate.length === 0) {
                    stagedItemsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No items staged for addition.</p>';
                    addStagedItemsBtn.classList.add('hidden');
                } else {
                     stagedItemsList.innerHTML = stagedItemsForUpdate.map((item, index) => `
                        <div class="flex justify-between items-center bg-gray-100 dark:bg-gray-800 p-2 rounded-md">
                            <span>${item.quantity}x ${item.name}</span>
                            <button data-index="${index}" class="removeStagedItemBtn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded">Remove</button>
                        </div>
                     `).join('');
                     addStagedItemsBtn.classList.remove('hidden');
                }
            }


            async function addItemsToCheck(e) {
                if(e.target.id !== 'addStagedItemsBtn') return;
                const statusEl = document.getElementById('updateActionStatus');

                if (stagedItemsForUpdate.length === 0) {
                    showInlineStatus(statusEl, 'Client Error', 'No items are staged to be added.', true);
                    return;
                }

                const orderGuid = activeUpdateOrder.guid;
                const checkGuid = activeUpdateOrder.checks[0].guid;

                const selectionsPayload = stagedItemsForUpdate.map(item => ({
                    item: { guid: item.guid },
                    itemGroup: { guid: item.itemGroupGuid },
                    quantity: item.quantity,
                    modifiers: []
                }));

                const apiBase = environmentSelect.value;
                const fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${orderGuid}/checks/${checkGuid}/selections`;
                
                const { data } = await makeApiCall(fullUrl, 'POST', selectionsPayload, statusEl, "Item(s) added! Reloading order...");

                if(data) {
                    setTimeout(loadOrderForUpdate, 1500);
                }
            }

            async function applyDiscountToOrder(e) {
                if (e.target.id !== 'applyDiscountBtn') return;
                const statusEl = document.getElementById('updateActionStatus');

                const discountSelectUpdate = document.getElementById('discountSelectUpdate');
                const discountValueInputUpdate = document.getElementById('discountValueInputUpdate');
                const itemSelect = document.getElementById('discountItemSelect');

                const selectedOption = discountSelectUpdate.options[discountSelectUpdate.selectedIndex];
                if (!selectedOption || !selectedOption.value) {
                    showInlineStatus(statusEl, 'Client Error', 'Please select a discount to apply.', true);
                    return;
                }

                const discountGuid = selectedOption.value;
                const discountType = selectedOption.dataset.type;
                const selectionType = selectedOption.dataset.selectionType;

                const appliedDiscount = {
                    discount: { guid: discountGuid }
                };

                const openTypes = ['OPEN_FIXED', 'OPEN_PERCENT'];
                if (openTypes.includes(discountType)) {
                    const discountValue = parseFloat(discountValueInputUpdate.value);
                    if (isNaN(discountValue) || discountValue <= 0) {
                        showInlineStatus(statusEl, 'Validation Error', 'Please enter a valid, positive discount value.', true);
                        return;
                    }
                    if (discountType === 'OPEN_PERCENT') {
                        appliedDiscount.discountPercent = discountValue;
                    } else { // Handles OPEN_FIXED
                        appliedDiscount.discountAmount = discountValue;
                    }
                }
                
                const orderGuid = activeUpdateOrder.guid;
                const checkGuid = activeUpdateOrder.checks[0].guid;
                const apiBase = environmentSelect.value;
                let fullUrl = '';
                
                if (selectionType === 'ITEM') {
                    const selectionGuid = itemSelect.value;
                    if (!selectionGuid) {
                        showInlineStatus(statusEl, 'Client Error', 'Please select an item to apply the discount to.', true);
                        return;
                    }
                    fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${orderGuid}/checks/${checkGuid}/selections/${selectionGuid}/appliedDiscounts`;
                } else { // Defaults to CHECK
                    fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${orderGuid}/checks/${checkGuid}/appliedDiscounts`;
                }

                // POSTing an array with a single discount object.
                const { data } = await makeApiCall(fullUrl, 'POST', [appliedDiscount], statusEl, "Discount applied! Reloading order...");

                if (data) {
                    setTimeout(loadOrderForUpdate, 1500);
                }
            }

            async function addPayment(e) {
                if(e.target.id !== 'addPaymentBtn') return;
                const statusEl = document.getElementById('updateActionStatus');
                const amountInput = document.getElementById('paymentAmountInput');
                const tipAmountInput = document.getElementById('tipAmountInput');
                const alternatePaymentTypeSelectUpdate = document.getElementById('alternatePaymentTypeSelectUpdate');
                
                const amount = parseFloat(amountInput.value);
                const tipAmount = parseFloat(tipAmountInput.value) || 0;
                
                if (isNaN(amount) || amount <= 0) {
                     showInlineStatus(statusEl, 'Client Error', 'Please enter a valid payment amount.', true);
                     return;
                }
                
                const orderGuid = activeUpdateOrder.guid;
                const checkGuid = activeUpdateOrder.checks[0].guid;
                
                const alternatePaymentGuid = alternatePaymentTypeSelectUpdate.value;
                if (!alternatePaymentGuid) {
                    showInlineStatus(statusEl, 'Client Error', 'Please select a payment type.', true);
                    return;
                }

                const paymentPayload = [{
                    type: 'OTHER',
                    otherPayment: { guid: alternatePaymentGuid },
                    amount: amount,
                    tipAmount: tipAmount
                }];
                
                const apiBase = environmentSelect.value;
                const fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${orderGuid}/checks/${checkGuid}/payments`;
                const { data } = await makeApiCall(fullUrl, 'POST', paymentPayload, statusEl, "Payment added! Reloading...");
                if(data) {
                    setTimeout(loadOrderForUpdate, 1500);
                }
            }

            async function voidOrder(e) {
                if (e.target.id !== 'voidOrderBtn') return;
                const statusEl = document.getElementById('updateActionStatus');

                // Check if all payments are of type 'OTHER'
                const check = activeUpdateOrder.checks[0];
                if (check.payments && check.payments.length > 0) {
                    const hasNonOtherPayment = check.payments.some(p => p.type !== 'OTHER');
                    if (hasNonOtherPayment) {
                        showInlineStatus(statusEl, 'Client Error', 'Voiding is only supported for orders paid with an "OTHER" payment type.', true);
                        return;
                    }
                }

                const orderGuid = activeUpdateOrder.guid;
                const apiBase = environmentSelect.value;
                const fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${orderGuid}/void`;
                
                const voidPayload = {
                    "selections": { "voidAll": true },
                    "payments": { "voidAll": true }
                };

                const { data } = await makeApiCall(fullUrl, 'POST', voidPayload, statusEl, "Order voided successfully! Reloading...");
                if (data) {
                    setTimeout(loadOrderForUpdate, 1500);
                }
            }
            
            async function voidItem(e) {
                if(!e.target.classList.contains('voidItemBtn')) return;
                const statusEl = document.getElementById('updateActionStatus');
                const selectionGuid = e.target.dataset.selectionGuid;
                const orderGuid = activeUpdateOrder.guid;
                const checkGuid = activeUpdateOrder.checks[0].guid;
                const patchPayload = { "selections": [{ "guid": selectionGuid, "void": true, "voidReason": { "guid": "5c069325-18b7-4a6c-94e8-8c54174d1c1c" } }] };
                const apiBase = environmentSelect.value;
                const fullUrl = `${CORS_PROXY}${apiBase}${ORDERS_PATH}/${orderGuid}/checks/${checkGuid}`;
                const { data } = await makeApiCall(fullUrl, 'PATCH', patchPayload, statusEl, "Item voided. Reloading...");
                if(data) {
                     setTimeout(loadOrderForUpdate, 1500);
                }
            }

            function getOrderStatus(order) {
                const status = order.guestOrderStatus;
                const isVoided = order.voided;

                if (isVoided) {
                    return { text: 'VOIDED', textClass: 'text-red-800 dark:text-red-300', bgClass: 'bg-red-100 dark:bg-red-900' };
                }
                if (status === 'CLOSED') {
                    return { text: 'CLOSED', textClass: 'text-gray-800 dark:text-gray-300', bgClass: 'bg-gray-200 dark:bg-gray-600' };
                }
                return { text: 'OPEN', textClass: 'text-green-800 dark:text-green-300', bgClass: 'bg-green-100 dark:bg-green-900' };
            }

            function renderReceipt(order) {
                const check = order.checks && order.checks[0];
                if (!check) return '<p>Check data not available.</p>';
                
                const status = getOrderStatus(order);
                const statusBanner = `
                    <div class="p-2 mb-4 text-center font-bold text-sm rounded-md ${status.bgClass} ${status.textClass}">
                        STATUS: ${status.text}
                    </div>
                `;

                const formatCurrency = (amount) => `$${(amount || 0).toFixed(2)}`;

                const subtotal = check.selections.reduce((acc, sel) => acc + (sel.voided ? 0 : sel.price), 0);
                const taxAmount = check.taxAmount || 0;
                const discountTotal = check.discountAmount || 0;
                const total = subtotal + taxAmount - discountTotal;
                const tipAmount = (check.payments || []).reduce((acc, p) => acc + (p.tipAmount || 0), 0);
                const amountPaid = (check.payments || []).reduce((acc, p) => acc + (p.amount || 0), 0);
                const balanceDue = total + tipAmount - amountPaid;

                const itemLines = check.selections.map(sel => {
                    const price = formatCurrency(sel.price);
                    let itemHtml = `<div class="flex justify-between items-center text-sm">
                        <span>${sel.quantity} x ${sel.displayName}</span>
                        <span>${price}</span>
                    </div>`;

                    if (sel.appliedDiscounts && sel.appliedDiscounts.length > 0) {
                        const itemDiscountHtml = sel.appliedDiscounts.map(d => `
                            <div class="flex justify-between items-center text-sm pl-4 text-green-600 dark:text-green-400">
                                <span>- ${d.discount.name}</span>
                                <span>-${formatCurrency(d.discountAmount)}</span>
                            </div>
                        `).join('');
                        itemHtml += itemDiscountHtml;
                    }
                    return sel.voided ? `<s class="text-red-500">${itemHtml}</s>` : itemHtml;
                }).join('');

                const checkDiscountLines = (check.appliedDiscounts || []).map(d => `
                    <div class="flex justify-between items-center text-sm">
                        <span>Discount (${d.discount.name})</span>
                        <span class="text-green-600">-${formatCurrency(d.discountAmount)}</span>
                    </div>
                `).join('');

                const paymentLines = (check.payments || []).map(p => `
                    <div class="flex justify-between items-center text-sm">
                        <span>Payment (${p.otherPayment?.name || p.type})</span>
                        <span>${formatCurrency(p.amount)}</span>
                    </div>
                `).join('');
                
                const tipLines = (check.payments || []).filter(p => p.tipAmount > 0).map(p => `
                    <div class="flex justify-between items-center text-sm">
                        <span>Tip</span>
                        <span>${formatCurrency(p.tipAmount)}</span>
                    </div>
                `).join('');

                return `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-inner font-mono text-gray-800 dark:text-gray-200 text-xs w-full max-w-md mx-auto">
                        ${statusBanner}
                        <div class="text-center mb-4">
                            <h4 class="font-bold text-base">${restaurantName.textContent}</h4>
                            <p>${order.diningOption?.name || 'Dine-In'}</p>
                        </div>
                        <div class="mb-2">
                            <p><strong>Order:</strong> ${order.guid}</p>
                            <p><strong>Opened:</strong> ${new Date(order.openedDate).toLocaleString()}</p>
                            <p><strong>Customer:</strong> ${check.customer?.firstName || ''} ${check.customer?.lastName || 'Guest'}</p>
                        </div>
                        <hr class="border-dashed my-2 border-gray-400 dark:border-gray-600"/>
                        <div class="space-y-1">
                            ${itemLines}
                        </div>
                        <hr class="border-dashed my-2 border-gray-400 dark:border-gray-600"/>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center font-semibold">
                                <span>Subtotal</span>
                                <span>${formatCurrency(subtotal)}</span>
                            </div>
                            ${checkDiscountLines}
                            <div class="flex justify-between items-center">
                                <span>Tax</span>
                                <span>${formatCurrency(taxAmount)}</span>
                            </div>
                            ${tipLines}
                            <div class="flex justify-between items-center font-bold text-base mt-2 pt-2 border-t border-dashed border-gray-400 dark:border-gray-600">
                                <span>Total</span>
                                <span>${formatCurrency(total + tipAmount)}</span>
                            </div>
                        </div>
                        ${paymentLines ? `<hr class="border-dashed my-2 border-gray-400 dark:border-gray-600"/>` : ''}
                        <div class="space-y-1">
                            ${paymentLines}
                        </div>
                        ${paymentLines ? `<hr class="border-dashed my-2 border-gray-400 dark:border-gray-600"/>` : ''}
                        <div class="space-y-1 font-semibold">
                             <div class="flex justify-between items-center">
                                <span>Total Paid</span>
                                <span>${formatCurrency(amountPaid)}</span>
                            </div>
                            <div class="flex justify-between items-center text-base">
                                <span>Balance Due</span>
                                <span>${formatCurrency(balanceDue)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            function createToggleView(order, isNested = false) {
                const container = document.createElement('div');
                const receiptHtml = renderReceipt(order);

                container.innerHTML = `
                    <div class="flex justify-center mb-2">
                        <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" class="toggle-view-btn active-toggle bg-blue-600 text-white py-2 px-4 text-sm font-medium rounded-l-lg">
                                Receipt View
                            </button>
                            <button type="button" class="toggle-view-btn bg-white dark:bg-gray-600 py-2 px-4 text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-500 rounded-r-md">
                                JSON View
                            </button>
                        </div>
                    </div>
                    <div class="view-content receipt-view">${receiptHtml}</div>
                    <div class="view-content json-view hidden">
                        <pre class="text-xs whitespace-pre-wrap break-all bg-gray-200 dark:bg-gray-800 p-2 rounded">${JSON.stringify(order, null, 2)}</pre>
                    </div>
                `;

                const buttons = container.querySelectorAll('.toggle-view-btn');
                const receiptView = container.querySelector('.receipt-view');
                const jsonView = container.querySelector('.json-view');

                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        buttons.forEach(btn => {
                            btn.classList.remove('active-toggle', 'bg-blue-600', 'text-white');
                            btn.classList.add('bg-white', 'dark:bg-gray-600');
                        });
                        button.classList.add('active-toggle', 'bg-blue-600', 'text-white');
                        button.classList.remove('bg-white', 'dark:bg-gray-600');
                        
                        if (button.textContent.includes('Receipt')) {
                            receiptView.classList.remove('hidden');
                            jsonView.classList.add('hidden');
                        } else {
                            receiptView.classList.add('hidden');
                            jsonView.classList.remove('hidden');
                        }
                    });
                });

                return container;
            }

            function handleDiscountSelectChange(e) {
                const selectEl = e.target;
                const isUpdateWorkflow = selectEl.id.includes('Update');
                
                const detailsSection = document.getElementById(isUpdateWorkflow ? 'discountDetailsSectionUpdate' : 'discountDetailsSection');
                const valueInput = document.getElementById(isUpdateWorkflow ? 'discountValueInputUpdate' : 'discountValueInput');
                const valueLabel = document.getElementById(isUpdateWorkflow ? 'discountValueLabelUpdate' : 'discountValueLabel');
                const itemSelectorContainer = document.getElementById(isUpdateWorkflow ? 'discountItemSelectorContainer' : 'discountItemSelectorContainerCreate');
                const itemSelect = document.getElementById(isUpdateWorkflow ? 'discountItemSelect' : 'discountItemSelectCreate');

                const selectedOption = selectEl.options[selectEl.selectedIndex];
                
                // If no discount is selected, hide both conditional sections and exit
                if (!selectedOption || !selectedOption.value) {
                    detailsSection?.classList.add('hidden');
                    itemSelectorContainer?.classList.add('hidden');
                    return;
                }

                const discountType = selectedOption.dataset.type;
                const selectionType = selectedOption.dataset.selectionType;

                // 1. Handle Item Selector visibility: show only for ITEM discounts with items in the cart
                itemSelectorContainer.classList.add('hidden'); // Hide by default
                if (selectionType === 'ITEM') {
                    const items = isUpdateWorkflow 
                        ? (activeUpdateOrder?.checks[0]?.selections.filter(sel => !sel.voided) || [])
                        : cartItems;

                    if (items.length > 0) {
                        itemSelectorContainer.classList.remove('hidden');
                        const optionsHtml = isUpdateWorkflow
                            ? items.map(sel => `<option value="${sel.guid}">${sel.quantity}x ${sel.displayName}</option>`).join('')
                            : items.map((item, index) => `<option value="${index}">${item.quantity}x ${item.name}</option>`).join('');
                        itemSelect.innerHTML = `<option value="">Select an item to discount</option>` + optionsHtml;
                    } 
                }
                
                // 2. Handle Amount Input visibility and state
                const typesRequiringValue = ['OPEN_FIXED', 'OPEN_PERCENT', 'FIXED_TOTAL'];
                if (typesRequiringValue.includes(discountType)) {
                    detailsSection.classList.remove('hidden');
                    valueInput.disabled = false;
                    valueInput.value = '';
                    valueInput.classList.remove('bg-gray-200', 'dark:bg-gray-800', 'cursor-not-allowed');
                    valueInput.classList.add('bg-white', 'dark:bg-gray-600');

                    if (discountType.includes('PERCENT')) {
                        valueLabel.textContent = 'Discount Percentage (%)';
                        valueInput.placeholder = 'e.g., 10';
                    } else if (discountType === 'FIXED_TOTAL') {
                        valueLabel.textContent = 'Final Price ($)';
                        valueInput.placeholder = 'e.g., 5.00';
                    } else { // OPEN_FIXED
                        valueLabel.textContent = 'Discount Amount ($)';
                        valueInput.placeholder = 'e.g., 5.00';
                    }
                } else {
                    // For discounts that don't need a value, hide the input section
                    detailsSection.classList.add('hidden');
                }
            }

            // --- Stock Management Functions ---
            async function viewInventory() {
                const statusFilter = inventoryStatusFilter.value;
                
                viewInventoryBtnText.textContent = 'Loading...';
                viewInventorySpinner.classList.remove('hidden');
                viewInventoryBtn.disabled = true;
                viewInventoryStatus.innerHTML = '';
                
                try {
                    let url = STOCK_INVENTORY_PATH;
                    if (statusFilter) {
                        url += `?status=${statusFilter}`;
                    }
                    
                    const response = await makeRequest(url, {
                        method: 'GET'
                    });
                    
                    if (response.ok) {
                        const inventory = await response.json();
                        viewInventoryStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${inventory.length} items</span>`;
                        displayInventoryResults(inventory, 'Current Inventory');
                    } else {
                        const error = await response.text();
                        viewInventoryStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${error}</span>`;
                    }
                } catch (error) {
                    viewInventoryStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    viewInventoryBtnText.textContent = 'View Inventory';
                    viewInventorySpinner.classList.add('hidden');
                    viewInventoryBtn.disabled = false;
                }
            }
            
            async function searchInventory() {
                const guidInput = searchItemGuids.value.trim();
                const mlIdInput = searchItemMLIds.value.trim();
                
                if (!guidInput && !mlIdInput) {
                    searchInventoryStatus.innerHTML = `<span class="text-yellow-600">Please enter at least one identifier</span>`;
                    return;
                }
                
                searchInventoryBtnText.textContent = 'Searching...';
                searchInventorySpinner.classList.remove('hidden');
                searchInventoryBtn.disabled = true;
                searchInventoryStatus.innerHTML = '';
                
                try {
                    const searchRequest = {};
                    
                    if (guidInput) {
                        searchRequest.guids = guidInput.split(',').map(g => g.trim()).filter(g => g);
                    }
                    
                    if (mlIdInput) {
                        searchRequest.multiLocationIds = mlIdInput.split(',').map(id => id.trim()).filter(id => id);
                    }
                    
                    const response = await makeRequest(STOCK_SEARCH_PATH, {
                        method: 'POST',
                        body: JSON.stringify(searchRequest)
                    });
                    
                    if (response.ok) {
                        const inventory = await response.json();
                        searchInventoryStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${inventory.length} items</span>`;
                        displayInventoryResults(inventory, 'Search Results');
                    } else {
                        const error = await response.text();
                        searchInventoryStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${error}</span>`;
                    }
                } catch (error) {
                    searchInventoryStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    searchInventoryBtnText.textContent = 'Search Items';
                    searchInventorySpinner.classList.add('hidden');
                    searchInventoryBtn.disabled = false;
                }
            }
            
            async function bulkUpdateInventory() {
                const items = [];
                const itemElements = inventoryUpdateList.querySelectorAll('.inventory-update-item:not(#updateTemplate)');
                
                for (const element of itemElements) {
                    const identifier = element.querySelector('.item-identifier').value.trim();
                    const status = element.querySelector('.item-status').value;
                    const quantity = element.querySelector('.item-quantity').value;
                    
                    if (!identifier) continue;
                    
                    const item = { status };
                    
                    // Determine if identifier is GUID or multiLocationId
                    if (identifier.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
                        item.guid = identifier;
                    } else {
                        item.multiLocationId = identifier;
                    }
                    
                    if (status === 'QUANTITY' && quantity) {
                        item.quantity = parseFloat(quantity);
                    }
                    
                    items.push(item);
                }
                
                if (items.length === 0) {
                    bulkUpdateInventoryStatus.innerHTML = `<span class="text-yellow-600">No items to update</span>`;
                    return;
                }
                
                bulkUpdateInventoryBtnText.textContent = 'Updating...';
                bulkUpdateInventorySpinner.classList.remove('hidden');
                bulkUpdateInventoryBtn.disabled = true;
                bulkUpdateInventoryStatus.innerHTML = '';
                
                try {
                    const response = await makeRequest(STOCK_UPDATE_PATH, {
                        method: 'PUT',
                        body: JSON.stringify(items)
                    });
                    
                    if (response.ok) {
                        const updatedInventory = await response.json();
                        bulkUpdateInventoryStatus.innerHTML = `<span class="text-green-600">âœ“ Updated ${updatedInventory.length} items</span>`;
                        displayInventoryResults(updatedInventory, 'Updated Inventory');
                    } else {
                        const error = await response.text();
                        bulkUpdateInventoryStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${error}</span>`;
                    }
                } catch (error) {
                    bulkUpdateInventoryStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    bulkUpdateInventoryBtnText.textContent = 'Update All Items';
                    bulkUpdateInventorySpinner.classList.add('hidden');
                    bulkUpdateInventoryBtn.disabled = false;
                }
            }
            
            function addUpdateItem() {
                const template = document.getElementById('updateTemplate');
                const newItem = template.cloneNode(true);
                newItem.id = '';
                newItem.style.display = 'block';
                
                // Set up status change handler for quantity field
                const statusSelect = newItem.querySelector('.item-status');
                const quantityInput = newItem.querySelector('.item-quantity');
                
                statusSelect.addEventListener('change', function() {
                    if (this.value === 'QUANTITY') {
                        quantityInput.disabled = false;
                        quantityInput.required = true;
                    } else {
                        quantityInput.disabled = true;
                        quantityInput.required = false;
                        quantityInput.value = '';
                    }
                });
                
                // Set up remove button
                const removeBtn = newItem.querySelector('.remove-item-btn');
                removeBtn.addEventListener('click', function() {
                    newItem.remove();
                });
                
                inventoryUpdateList.appendChild(newItem);
            }
            
            function displayInventoryResults(inventory, title) {
                let html = `<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-3">${title}</h3>`;
                
                if (inventory.length === 0) {
                    html += '<p class="text-gray-500">No inventory items found</p>';
                } else {
                    html += '<div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-gray-50 dark:bg-gray-700"><tr>';
                    html += '<th class="px-3 py-2 text-left font-medium">Item ID</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Multi-Location ID</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Status</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Quantity</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Validity</th>';
                    html += '</tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">';
                    
                    inventory.forEach(item => {
                        const statusClass = item.status === 'OUT_OF_STOCK' ? 'text-red-600' : 
                                          item.status === 'QUANTITY' ? 'text-yellow-600' : 'text-green-600';
                        const validityClass = item.itemGuidValidity === 'INVALID' ? 'text-red-600' : 'text-green-600';
                        
                        html += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700">`;
                        html += `<td class="px-3 py-2 font-mono text-xs">${item.guid || 'N/A'}</td>`;
                        html += `<td class="px-3 py-2">${item.multiLocationId || 'N/A'}</td>`;
                        html += `<td class="px-3 py-2 ${statusClass}">${item.status}</td>`;
                        html += `<td class="px-3 py-2">${item.quantity !== null ? item.quantity : '-'}</td>`;
                        html += `<td class="px-3 py-2 ${validityClass}">${item.itemGuidValidity || 'N/A'}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
            }

            // --- Labor Management Functions ---
            
            // Store fetched employees and jobs for dropdowns
            let allEmployees = [];
            let allJobs = [];
            
            // Store fetched menu data for dropdowns
            let allMenus = [];
            let allMenuGroups = [];
            let allMenuItems = [];
            let allModifierGroups = [];
            let allModifierOptions = [];
            
            // Employee Management Functions
            async function fetchAllEmployees() {
                fetchAllEmployeesBtnText.textContent = 'Fetching...';
                fetchAllEmployeesSpinner.classList.remove('hidden');
                fetchAllEmployeesBtn.disabled = true;
                viewEmployeesStatus.innerHTML = '';
                
                try {
                    const url = CORS_PROXY + environmentSelect.value + EMPLOYEES_PATH_BASE;
                    const result = await makeApiCall(url, 'GET');
                    
                    if (result.error) {
                        viewEmployeesStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        allEmployees = result.data || [];
                        
                        console.log('=== EMPLOYEE FETCH SUCCESS ===');
                        console.log('Total employees fetched:', allEmployees.length);
                        if (allEmployees.length > 0) {
                            console.log('Sample employee data structure:', allEmployees[0]);
                            console.log('Sample employee properties:', Object.keys(allEmployees[0]));
                        }
                        
                        viewEmployeesStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${allEmployees.length} employees</span>`;
                        
                        // Populate dropdown
                        populateEmployeeDropdowns();
                        
                        displayEmployeeResults(allEmployees, 'All Employees');
                    }
                } catch (error) {
                    viewEmployeesStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    fetchAllEmployeesBtnText.textContent = 'Fetch All Employees';
                    fetchAllEmployeesSpinner.classList.add('hidden');
                    fetchAllEmployeesBtn.disabled = false;
                }
            }
            
            function viewSelectedEmployee() {
                const selectedGuid = employeeDropdown.value;
                if (!selectedGuid) {
                    viewEmployeesStatus.innerHTML = `<span class="text-yellow-600">Please select an employee first</span>`;
                    return;
                }
                
                const selectedEmployee = allEmployees.find(emp => emp.guid === selectedGuid);
                if (selectedEmployee) {
                    displayEmployeeResults([selectedEmployee], 'Selected Employee Details');
                    viewEmployeesStatus.innerHTML = `<span class="text-green-600">âœ“ Showing details for selected employee</span>`;
                }
            }
            
            function autoFillEmployeeData() {
                // Generate random test data
                const firstNames = ['Alex', 'Jamie', 'Taylor', 'Morgan', 'Casey', 'Riley', 'Jordan', 'Sage'];
                const lastNames = ['Johnson', 'Williams', 'Brown', 'Davis', 'Miller', 'Wilson', 'Moore', 'Taylor'];
                
                const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                const timestamp = Date.now().toString().slice(-4);
                
                newEmployeeFirstName.value = firstName;
                newEmployeeLastName.value = lastName;
                newEmployeeEmail.value = `${firstName.toLowerCase()}.${lastName.toLowerCase()}${timestamp}@testrestaurant.com`;
                newEmployeeExternalId.value = `EMP-${timestamp}`;
                
                // Show feedback
                addEmployeeStatus.innerHTML = `<span class="text-blue-600">âœ“ Test data filled! Ready to add employee.</span>`;
            }
            
            function populateEmployeeDropdowns() {
                const dropdowns = [employeeDropdown, updateEmployeeDropdown, assignJobEmployeeDropdown, shiftEmployeeDropdown, timeEntryEmployeeDropdown];
                
                dropdowns.forEach(dropdown => {
                    if (dropdown) {
                        dropdown.innerHTML = '<option value="">Select an employee...</option>';
                        allEmployees.forEach(emp => {
                            const fullName = [emp.firstName, emp.chosenName, emp.lastName].filter(n => n).join(' ');
                            const displayName = fullName || emp.email || emp.guid.slice(-8);
                            dropdown.innerHTML += `<option value="${emp.guid}">${displayName} (${emp.guid.slice(-8)})</option>`;
                        });
                    }
                });
                
                // Enable buttons that depend on employee data
                viewSelectedEmployeeBtn.disabled = false;
                updateEmployeeBtn.disabled = false;
                assignJobsBtn.disabled = (allJobs.length === 0); // Only enable if jobs are also fetched
                createShiftBtn.disabled = (allJobs.length === 0); // Only enable if jobs are also fetched
            }
            
            function populateJobDropdowns() {
                // Populate regular job dropdown (for viewing jobs)
                if (jobDropdown) {
                    jobDropdown.innerHTML = '<option value="">Select a job...</option>';
                    allJobs.forEach(job => {
                        const displayName = job.title || job.guid.slice(-8);
                        jobDropdown.innerHTML += `<option value="${job.guid}">${displayName} (${job.guid.slice(-8)})</option>`;
                    });
                }
                
                // For shift job dropdown, use the employee-aware filtering
                updateShiftJobDropdownForEmployee();
                
                // Populate job selection area for assignment
                if (jobSelectionArea && allJobs.length > 0) {
                    jobSelectionArea.innerHTML = '';
                    allJobs.forEach(job => {
                        const displayName = job.title || job.guid.slice(-8);
                        jobSelectionArea.innerHTML += `
                            <label class="flex items-center text-sm mb-1">
                                <input type="checkbox" value="${job.guid}" class="mr-2 job-checkbox">
                                ${displayName} (${job.guid.slice(-8)})
                            </label>`;
                    });
                }
                
                // Enable buttons that depend on job data
                viewSelectedJobBtn.disabled = false;
                assignJobsBtn.disabled = (allEmployees.length === 0); // Only enable if employees are also fetched
                createShiftBtn.disabled = (allEmployees.length === 0); // Only enable if employees are also fetched
            }
            
            // Job Management Functions
            async function fetchAllJobs() {
                fetchAllJobsBtnText.textContent = 'Fetching...';
                fetchAllJobsSpinner.classList.remove('hidden');
                fetchAllJobsBtn.disabled = true;
                viewJobsStatus.innerHTML = '';
                
                try {
                    const url = CORS_PROXY + environmentSelect.value + JOBS_PATH_BASE;
                    const result = await makeApiCall(url, 'GET');
                    
                    if (result.error) {
                        viewJobsStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        allJobs = result.data || [];
                        viewJobsStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${allJobs.length} jobs</span>`;
                        
                        // Populate dropdowns
                        populateJobDropdowns();
                        
                        displayJobResults(allJobs, 'All Jobs');
                    }
                } catch (error) {
                    viewJobsStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    fetchAllJobsBtnText.textContent = 'Fetch All Jobs';
                    fetchAllJobsSpinner.classList.add('hidden');
                    fetchAllJobsBtn.disabled = false;
                }
            }
            
            function viewSelectedJob() {
                const selectedGuid = jobDropdown.value;
                if (!selectedGuid) {
                    viewJobsStatus.innerHTML = `<span class="text-yellow-600">Please select a job first</span>`;
                    return;
                }
                
                const selectedJob = allJobs.find(job => job.guid === selectedGuid);
                if (selectedJob) {
                    displayJobResults([selectedJob], 'Selected Job Details');
                    viewJobsStatus.innerHTML = `<span class="text-green-600">âœ“ Showing details for selected job</span>`;
                }
            }
            
            async function viewEmployees() {
                const employeeIds = employeeIdsInput.value.trim();
                
                viewEmployeesBtnText.textContent = 'Loading...';
                viewEmployeesSpinner.classList.remove('hidden');
                viewEmployeesBtn.disabled = true;
                viewEmployeesStatus.innerHTML = '';
                
                try {
                    let url = CORS_PROXY + environmentSelect.value + EMPLOYEES_PATH_BASE;
                    if (employeeIds) {
                        const ids = employeeIds.split(',').map(id => id.trim()).filter(id => id);
                        const params = ids.map(id => `employeeIds=${encodeURIComponent(id)}`).join('&');
                        url += `?${params}`;
                    }
                    
                    const result = await makeApiCall(url, 'GET');
                    
                    if (result.error) {
                        viewEmployeesStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        const employees = result.data || [];
                        viewEmployeesStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${employees.length} employees</span>`;
                        displayEmployeeResults(employees, 'Employees');
                    }
                } catch (error) {
                    viewEmployeesStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    viewEmployeesBtnText.textContent = 'View';
                    viewEmployeesSpinner.classList.add('hidden');
                    viewEmployeesBtn.disabled = false;
                }
            }
            
            async function addEmployee() {
                const firstName = newEmployeeFirstName.value.trim();
                const lastName = newEmployeeLastName.value.trim();
                const email = newEmployeeEmail.value.trim();
                const externalId = newEmployeeExternalId.value.trim();
                
                if (!firstName || !lastName || !email) {
                    addEmployeeStatus.innerHTML = `<span class="text-yellow-600">Please fill in first name, last name, and email</span>`;
                    return;
                }
                
                addEmployeeBtnText.textContent = 'Adding...';
                addEmployeeSpinner.classList.remove('hidden');
                addEmployeeBtn.disabled = true;
                addEmployeeStatus.innerHTML = '';
                
                try {
                    const employeeData = {
                        entityType: 'RestaurantUser',
                        firstName,
                        lastName,
                        email
                    };
                    
                    if (externalId) {
                        employeeData.externalId = externalId;
                    }
                    
                    const url = CORS_PROXY + environmentSelect.value + EMPLOYEES_PATH_BASE;
                    const result = await makeApiCall(url, 'POST', employeeData);
                    
                    if (result.error) {
                        addEmployeeStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        const newEmployee = result.data;
                        addEmployeeStatus.innerHTML = `<span class="text-green-600">âœ“ Employee created successfully</span>`;
                        displayEmployeeResults([newEmployee], 'New Employee Created');
                        
                        // Clear form
                        newEmployeeFirstName.value = '';
                        newEmployeeLastName.value = '';
                        newEmployeeEmail.value = '';
                        newEmployeeExternalId.value = '';
                    }
                } catch (error) {
                    addEmployeeStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    addEmployeeBtnText.textContent = 'Add Employee';
                    addEmployeeSpinner.classList.add('hidden');
                    addEmployeeBtn.disabled = false;
                }
            }
            
            async function updateEmployee() {
                const employeeId = updateEmployeeDropdown.value;
                const firstName = updateEmployeeFirstName.value.trim();
                const lastName = updateEmployeeLastName.value.trim();
                
                if (!employeeId) {
                    updateEmployeeStatus.innerHTML = `<span class="text-yellow-600">Please select an employee first</span>`;
                    return;
                }
                
                if (!firstName && !lastName) {
                    updateEmployeeStatus.innerHTML = `<span class="text-yellow-600">Please enter at least first or last name to update</span>`;
                    return;
                }
                
                updateEmployeeBtnText.textContent = 'Updating...';
                updateEmployeeSpinner.classList.remove('hidden');
                updateEmployeeBtn.disabled = true;
                updateEmployeeStatus.innerHTML = '';
                
                try {
                    const updateData = {};
                    if (firstName) updateData.firstName = firstName;
                    if (lastName) updateData.lastName = lastName;
                    
                    const url = CORS_PROXY + environmentSelect.value + `${EMPLOYEES_PATH_BASE}/${employeeId}`;
                    const result = await makeApiCall(url, 'PATCH', updateData);
                    
                    if (result.error) {
                        updateEmployeeStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        const updatedEmployee = result.data;
                        updateEmployeeStatus.innerHTML = `<span class="text-green-600">âœ“ Employee updated successfully</span>`;
                        displayEmployeeResults([updatedEmployee], 'Updated Employee');
                    }
                } catch (error) {
                    updateEmployeeStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    updateEmployeeBtnText.textContent = 'Update Employee';
                    updateEmployeeSpinner.classList.add('hidden');
                    updateEmployeeBtn.disabled = false;
                }
            }
            
            // Job Management Functions
            async function viewJobs() {
                const jobIds = jobIdsInput.value.trim();
                
                viewJobsBtnText.textContent = 'Loading...';
                viewJobsSpinner.classList.remove('hidden');
                viewJobsBtn.disabled = true;
                viewJobsStatus.innerHTML = '';
                
                try {
                    let url = CORS_PROXY + environmentSelect.value + JOBS_PATH_BASE;
                    if (jobIds) {
                        const ids = jobIds.split(',').map(id => id.trim()).filter(id => id);
                        const params = ids.map(id => `jobIds=${encodeURIComponent(id)}`).join('&');
                        url += `?${params}`;
                    }
                    
                    const result = await makeApiCall(url, 'GET');
                    
                    if (result.error) {
                        viewJobsStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        const jobs = result.data || [];
                        viewJobsStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${jobs.length} jobs</span>`;
                        displayJobResults(jobs, 'Jobs');
                    }
                } catch (error) {
                    viewJobsStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    viewJobsBtnText.textContent = 'View';
                    viewJobsSpinner.classList.add('hidden');
                    viewJobsBtn.disabled = false;
                }
            }
            
            async function assignJobs() {
                const employeeId = assignJobEmployeeDropdown.value;
                const selectedJobCheckboxes = jobSelectionArea.querySelectorAll('.job-checkbox:checked');
                
                if (!employeeId) {
                    assignJobsStatus.innerHTML = `<span class="text-yellow-600">Please select an employee</span>`;
                    return;
                }
                
                if (selectedJobCheckboxes.length === 0) {
                    assignJobsStatus.innerHTML = `<span class="text-yellow-600">Please select at least one job</span>`;
                    return;
                }
                
                assignJobsBtnText.textContent = 'Assigning...';
                assignJobsSpinner.classList.remove('hidden');
                assignJobsBtn.disabled = true;
                assignJobsStatus.innerHTML = '';
                
                try {
                    const ids = Array.from(selectedJobCheckboxes).map(checkbox => checkbox.value);
                    const jobReferences = ids.map(id => {
                        // Check if it's a GUID or external ID
                        if (id.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
                            return { guid: id };
                        } else {
                            return { externalId: id };
                        }
                    });
                    
                    const url = CORS_PROXY + environmentSelect.value + `${EMPLOYEES_PATH_BASE}/${employeeId}/jobs`;
                    const result = await makeApiCall(url, 'PUT', jobReferences);
                    
                    if (result.error) {
                        assignJobsStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        const updatedEmployee = result.data;
                        
                        console.log('=== JOB ASSIGNMENT SUCCESS ===');
                        console.log('Updated employee data:', updatedEmployee);
                        console.log('Updated employee properties:', Object.keys(updatedEmployee));
                        
                        // Update the employee in the allEmployees array
                        const employeeIndex = allEmployees.findIndex(emp => emp.guid === employeeId);
                        if (employeeIndex !== -1) {
                            console.log('Updating employee in allEmployees array at index:', employeeIndex);
                            console.log('Old employee data:', allEmployees[employeeIndex]);
                            allEmployees[employeeIndex] = updatedEmployee;
                            console.log('New employee data:', allEmployees[employeeIndex]);
                            
                            // Repopulate dropdowns with updated data
                            populateEmployeeDropdowns();
                            updateShiftJobDropdownForEmployee();
                        } else {
                            console.warn('Could not find employee in allEmployees array to update');
                        }
                        
                        assignJobsStatus.innerHTML = `<span class="text-green-600">âœ“ Jobs assigned successfully</span>`;
                        displayEmployeeResults([updatedEmployee], 'Employee with Updated Jobs');
                    }
                } catch (error) {
                    assignJobsStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    assignJobsBtnText.textContent = 'Assign Jobs';
                    assignJobsSpinner.classList.add('hidden');
                    assignJobsBtn.disabled = false;
                }
            }
            
            // Shift Management Functions
            async function viewShifts() {
                const startDate = shiftsStartDate.value;
                const endDate = shiftsEndDate.value;
                
                if (!startDate || !endDate) {
                    viewShiftsStatus.innerHTML = `<span class="text-yellow-600">Please select start and end dates</span>`;
                    return;
                }
                
                viewShiftsBtnText.textContent = 'Loading...';
                viewShiftsSpinner.classList.remove('hidden');
                viewShiftsBtn.disabled = true;
                viewShiftsStatus.innerHTML = '';
                
                try {
                    const startISO = new Date(startDate).toISOString();
                    const endISO = new Date(endDate).toISOString();
                    const url = CORS_PROXY + environmentSelect.value + `${SHIFTS_PATH}?startDate=${encodeURIComponent(startISO)}&endDate=${encodeURIComponent(endISO)}`;
                    
                    const result = await makeApiCall(url, 'GET');
                    
                    if (result.error) {
                        viewShiftsStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        const shifts = result.data || [];
                        viewShiftsStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${shifts.length} shifts</span>`;
                        displayShiftResults(shifts, 'Shifts', { 
                            startDate: startDate, 
                            endDate: endDate, 
                            startISO: startISO, 
                            endISO: endISO 
                        });
                    }
                } catch (error) {
                    viewShiftsStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    viewShiftsBtnText.textContent = 'View Shifts';
                    viewShiftsSpinner.classList.add('hidden');
                    viewShiftsBtn.disabled = false;
                }
            }
            
            async function createShift() {
                const employeeId = shiftEmployeeDropdown.value;
                const jobId = shiftJobDropdown.value;
                const startTime = shiftStartTime.value;
                const endTime = shiftEndTime.value;
                
                if (!employeeId || !jobId || !startTime || !endTime) {
                    createShiftStatus.innerHTML = `<span class="text-yellow-600">Please fill in all fields</span>`;
                    return;
                }
                
                // Validate dates
                const startDate = new Date(startTime);
                const endDate = new Date(endTime);
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    createShiftStatus.innerHTML = `<span class="text-red-600">Invalid date/time format</span>`;
                    return;
                }
                
                if (endDate <= startDate) {
                    createShiftStatus.innerHTML = `<span class="text-red-600">End time must be after start time</span>`;
                    return;
                }
                
                // Validate GUIDs format (basic check)
                const guidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (!guidRegex.test(employeeId)) {
                    createShiftStatus.innerHTML = `<span class="text-red-600">Invalid employee GUID format</span>`;
                    return;
                }
                if (!guidRegex.test(jobId)) {
                    createShiftStatus.innerHTML = `<span class="text-red-600">Invalid job GUID format</span>`;
                    return;
                }
                
                createShiftBtnText.textContent = 'Creating...';
                createShiftSpinner.classList.remove('hidden');
                createShiftBtn.disabled = true;
                createShiftStatus.innerHTML = '';
                
                try {
                    // Always use +0000 date format (confirmed working)
                    const shiftData = {
                        entityType: 'Shift',
                        jobReference: {
                            guid: jobId,
                            entityType: 'RestaurantJob'
                        },
                        employeeReference: {
                            guid: employeeId,
                            entityType: 'RestaurantUser'
                        },
                        inDate: startDate.toISOString().replace('Z', '+0000'),
                        outDate: endDate.toISOString().replace('Z', '+0000')
                    };
                    
                    const url = CORS_PROXY + environmentSelect.value + SHIFTS_PATH;
                    
                    // Debug logging to help troubleshoot
                    console.log('=== SHIFT CREATION DEBUG ===');
                    console.log('Full URL:', url);
                    console.log('Method: POST');
                    console.log('Employee GUID:', employeeId);
                    console.log('Job GUID:', jobId);
                    console.log('Raw start time:', startTime);
                    console.log('Raw end time:', endTime);
                    console.log('Parsed start date:', startDate);
                    console.log('Parsed end date:', endDate);
                    console.log('Final payload (using +0000 format):', JSON.stringify(shiftData, null, 2));
                    
                    const result = await makeApiCall(url, 'POST', shiftData);
                    
                    if (result.error) {
                        const errorMessage = typeof result.error === 'object' ? 
                            result.error.message || JSON.stringify(result.error) : 
                            result.error;
                        console.error('Shift creation failed:', result.error);
                        createShiftStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${errorMessage}</span>`;
                    } else {
                        const newShift = result.data;
                        createShiftStatus.innerHTML = `<span class="text-green-600">âœ“ Shift created successfully</span>`;
                        displayShiftResults([newShift], 'New Shift Created');
                        
                        // Clear form
                        shiftEmployeeDropdown.value = '';
                        shiftJobDropdown.value = '';
                        shiftStartTime.value = '';
                        shiftEndTime.value = '';
                        updateShiftDurationDisplay();
                    }
                } catch (error) {
                    createShiftStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    createShiftBtnText.textContent = 'Create Shift';
                    createShiftSpinner.classList.add('hidden');
                    createShiftBtn.disabled = false;
                }
            }
            
            // Time Entry Management Functions
            async function viewTimeEntries() {
                const queryType = timeEntryQuery.value;
                const includeMissed = includeMissedBreaks.checked;
                
                let url = TIME_ENTRIES_PATH + '?';
                const params = [];
                
                if (queryType === 'date') {
                    const startDate = timeEntryStartDate.value;
                    const endDate = timeEntryEndDate.value;
                    if (!startDate || !endDate) {
                        viewTimeEntriesStatus.innerHTML = `<span class="text-yellow-600">Please select start and end dates</span>`;
                        return;
                    }
                    params.push(`startDate=${encodeURIComponent(new Date(startDate).toISOString())}`);
                    params.push(`endDate=${encodeURIComponent(new Date(endDate).toISOString())}`);
                } else if (queryType === 'businessDate') {
                    const bizDate = businessDate.value;
                    if (!bizDate) {
                        viewTimeEntriesStatus.innerHTML = `<span class="text-yellow-600">Please select a business date</span>`;
                        return;
                    }
                    const formattedDate = bizDate.replace(/-/g, '');
                    params.push(`businessDate=${formattedDate}`);
                } else if (queryType === 'modified') {
                    const startDate = timeEntryStartDate.value;
                    const endDate = timeEntryEndDate.value;
                    if (!startDate || !endDate) {
                        viewTimeEntriesStatus.innerHTML = `<span class="text-yellow-600">Please select modified start and end dates</span>`;
                        return;
                    }
                    params.push(`modifiedStartDate=${encodeURIComponent(new Date(startDate).toISOString())}`);
                    params.push(`modifiedEndDate=${encodeURIComponent(new Date(endDate).toISOString())}`);
                }
                
                if (includeMissed) {
                    params.push('includeMissedBreaks=true');
                }
                
                url += params.join('&');
                
                viewTimeEntriesBtnText.textContent = 'Loading...';
                viewTimeEntriesSpinner.classList.remove('hidden');
                viewTimeEntriesBtn.disabled = true;
                viewTimeEntriesStatus.innerHTML = '';
                
                try {
                    const fullUrl = CORS_PROXY + environmentSelect.value + url.replace(TIME_ENTRIES_PATH + '?', TIME_ENTRIES_PATH + '?');
                    const result = await makeApiCall(fullUrl, 'GET');
                    
                    if (result.error) {
                        viewTimeEntriesStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${result.error}</span>`;
                    } else {
                        const timeEntries = result.data || [];
                        viewTimeEntriesStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${timeEntries.length} time entries</span>`;
                        displayTimeEntryResults(timeEntries, 'Time Entries');
                    }
                } catch (error) {
                    viewTimeEntriesStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    viewTimeEntriesBtnText.textContent = 'View Time Entries';
                    viewTimeEntriesSpinner.classList.add('hidden');
                    viewTimeEntriesBtn.disabled = false;
                }
            }
            
            // Time Entry Creation Functions
            window.setTimeEntryScenario = function(scenario) {
                if (!allEmployees || allEmployees.length === 0) {
                    createTimeEntryStatus.innerHTML = `<span class="text-yellow-600">Please fetch employees first</span>`;
                    return;
                }
                
                // Set employee to first available
                const firstEmployee = allEmployees.find(emp => !emp.deleted);
                if (firstEmployee) {
                    timeEntryEmployeeDropdown.value = firstEmployee.guid;
                    updateTimeEntryJobDropdown();
                }
                
                const now = new Date();
                let clockIn, clockOut, tips = 0, breakMinutes = 30;
                
                switch(scenario) {
                    case 'perfect':
                        // Perfect 8-hour shift: 9 AM - 5 PM today
                        clockIn = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0);
                        clockOut = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 17, 0);
                        tips = 45.50;
                        breakMinutes = 30;
                        break;
                        
                    case 'late':
                        // Late start: 9:20 AM - 5:00 PM (20 minutes late)
                        clockIn = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 20);
                        clockOut = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 17, 0);
                        tips = 38.25;
                        breakMinutes = 30;
                        break;
                        
                    case 'overtime':
                        // Long day: 8 AM - 7 PM (11 hours, 3 hours overtime)
                        clockIn = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0);
                        clockOut = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 19, 0);
                        tips = 125.75;
                        breakMinutes = 45; // Longer break for longer shift
                        break;
                        
                    case 'short':
                        // Left early: 10 AM - 2:30 PM (4.5 hours, slow day)
                        clockIn = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0);
                        clockOut = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 14, 30);
                        tips = 18.50;
                        breakMinutes = 15; // Short break for short shift
                        break;
                }
                
                timeEntryClockIn.value = clockIn.toISOString().slice(0, 16);
                timeEntryClockOut.value = clockOut.toISOString().slice(0, 16);
                timeEntryCashTips.value = tips.toFixed(2);
                timeEntryBreakMinutes.value = breakMinutes;
                
                updateTimeEntryHours();
                updateCreateTimeEntryButtonState();
                
                // Show scenario info
                const scenarioNames = {
                    'perfect': 'âœ… Perfect Day - 8 hours, on time',
                    'late': 'â° Late Start - Started 20 min late', 
                    'overtime': 'ðŸ”¥ Overtime Shift - 11 hours worked',
                    'short': 'ðŸƒ Left Early - Short 4.5 hour shift'
                };
                createTimeEntryStatus.innerHTML = `<span class="text-blue-600">${scenarioNames[scenario]} scenario loaded</span>`;
            };
            
            function updateTimeEntryJobDropdown() {
                const selectedEmployeeGuid = timeEntryEmployeeDropdown.value;
                
                // Clear the job dropdown first
                timeEntryJobDropdown.innerHTML = '<option value="">Select job...</option>';
                
                if (!selectedEmployeeGuid) {
                    timeEntryJobDropdown.disabled = true;
                    timeEntryJobDropdown.innerHTML = '<option value="">Select employee first...</option>';
                    return;
                }
                
                // Get jobs assigned to this employee
                const assignedJobGuids = getEmployeeJobGuids(selectedEmployeeGuid);
                
                if (assignedJobGuids.length === 0) {
                    // Employee has no assigned jobs, show all jobs with warning
                    timeEntryJobDropdown.disabled = false;
                    timeEntryJobDropdown.innerHTML = '<option value="">âš ï¸ Employee has no assigned jobs</option>';
                    if (allJobs && allJobs.length > 0) {
                        allJobs.forEach(job => {
                            if (!job.deleted) {
                                timeEntryJobDropdown.innerHTML += `<option value="${job.guid}">âš ï¸ ${job.title} (not assigned)</option>`;
                            }
                        });
                    }
                } else {
                    // Show only assigned jobs
                    timeEntryJobDropdown.disabled = false;
                    assignedJobGuids.forEach(jobGuid => {
                        const job = allJobs?.find(j => j.guid === jobGuid);
                        if (job && !job.deleted) {
                            timeEntryJobDropdown.innerHTML += `<option value="${job.guid}">âœ… ${job.title}</option>`;
                        }
                    });
                }
                
                updateCreateTimeEntryButtonState();
            }
            
            function updateTimeEntryHours() {
                const clockIn = timeEntryClockIn.value;
                const clockOut = timeEntryClockOut.value;
                
                if (!clockIn || !clockOut) {
                    timeEntryHoursDisplay.textContent = '';
                    timeEntryOvertimeWarning.textContent = '';
                    return;
                }
                
                const startTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                if (endTime <= startTime) {
                    timeEntryHoursDisplay.textContent = 'Invalid times';
                    timeEntryHoursDisplay.className = 'text-xs text-red-600 dark:text-red-400';
                    timeEntryOvertimeWarning.textContent = '';
                    return;
                }
                
                const totalHours = (endTime - startTime) / (1000 * 60 * 60);
                const breakMinutes = parseInt(timeEntryBreakMinutes.value) || 0;
                const workHours = totalHours - (breakMinutes / 60);
                
                timeEntryHoursDisplay.textContent = `${workHours.toFixed(1)} work hours (${totalHours.toFixed(1)} total)`;
                timeEntryHoursDisplay.className = 'text-xs text-green-600 dark:text-green-400 font-medium';
                
                // Show overtime warning
                if (workHours > 8) {
                    const overtimeHours = workHours - 8;
                    timeEntryOvertimeWarning.textContent = `âš ï¸ ${overtimeHours.toFixed(1)}h OT`;
                    timeEntryOvertimeWarning.className = 'text-xs text-orange-600 dark:text-orange-400 font-bold';
                } else {
                    timeEntryOvertimeWarning.textContent = '';
                }
            }
            
            function updateCreateTimeEntryButtonState() {
                const hasEmployee = timeEntryEmployeeDropdown.value !== '';
                const hasJob = timeEntryJobDropdown.value !== '';
                const hasClockIn = timeEntryClockIn.value !== '';
                const hasClockOut = timeEntryClockOut.value !== '';
                
                createTimeEntryBtn.disabled = !(hasEmployee && hasJob && hasClockIn && hasClockOut);
            }
            
            async function createTimeEntry() {
                const employeeId = timeEntryEmployeeDropdown.value;
                const jobId = timeEntryJobDropdown.value;
                const clockInTime = timeEntryClockIn.value;
                const clockOutTime = timeEntryClockOut.value;
                
                if (!employeeId || !jobId || !clockInTime || !clockOutTime) {
                    createTimeEntryStatus.innerHTML = `<span class="text-yellow-600">Please fill in all required fields</span>`;
                    return;
                }
                
                // Validate times
                const startDate = new Date(clockInTime);
                const endDate = new Date(clockOutTime);
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    createTimeEntryStatus.innerHTML = `<span class="text-red-600">Invalid date/time format</span>`;
                    return;
                }
                
                if (endDate <= startDate) {
                    createTimeEntryStatus.innerHTML = `<span class="text-red-600">Clock out time must be after clock in time</span>`;
                    return;
                }
                
                // Validate GUIDs format
                const guidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (!guidRegex.test(employeeId)) {
                    createTimeEntryStatus.innerHTML = `<span class="text-red-600">Invalid employee GUID format</span>`;
                    return;
                }
                if (!guidRegex.test(jobId)) {
                    createTimeEntryStatus.innerHTML = `<span class="text-red-600">Invalid job GUID format</span>`;
                    return;
                }
                
                createTimeEntryBtnText.textContent = 'Creating...';
                createTimeEntrySpinner.classList.remove('hidden');
                createTimeEntryBtn.disabled = true;
                createTimeEntryStatus.innerHTML = '';
                
                try {
                    // Calculate work hours
                    const totalHours = (endDate - startDate) / (1000 * 60 * 60);
                    const breakMinutes = parseInt(timeEntryBreakMinutes.value) || 0;
                    const regularHours = totalHours - (breakMinutes / 60);
                    
                    const timeEntryData = {
                        entityType: 'TimeEntry',
                        employeeReference: {
                            guid: employeeId,
                            entityType: 'RestaurantUser'
                        },
                        jobReference: {
                            guid: jobId,
                            entityType: 'RestaurantJob'
                        },
                        inDate: startDate.toISOString().replace('Z', '+0000'),
                        outDate: endDate.toISOString().replace('Z', '+0000'),
                        regularHours: parseFloat(regularHours.toFixed(2)),
                        declaredCashTips: parseFloat(timeEntryCashTips.value) || 0
                    };
                    
                    // Add break information if specified
                    if (breakMinutes > 0) {
                        // Calculate break start time (middle of shift)
                        const breakStart = new Date(startDate.getTime() + (endDate - startDate) / 2 - (breakMinutes * 60 * 1000) / 2);
                        const breakEnd = new Date(breakStart.getTime() + breakMinutes * 60 * 1000);
                        
                        timeEntryData.breaks = [{
                            startTime: breakStart.toISOString().replace('Z', '+0000'),
                            endTime: breakEnd.toISOString().replace('Z', '+0000')
                        }];
                    }
                    
                    const url = CORS_PROXY + environmentSelect.value + TIME_ENTRIES_PATH;
                    
                    // Debug logging
                    console.log('=== TIME ENTRY CREATION DEBUG ===');
                    console.log('Full URL:', url);
                    console.log('Employee GUID:', employeeId);
                    console.log('Job GUID:', jobId);
                    console.log('Clock in time:', clockInTime);
                    console.log('Clock out time:', clockOutTime);
                    console.log('Calculated regular hours:', regularHours);
                    console.log('Final payload:', JSON.stringify(timeEntryData, null, 2));
                    
                    const result = await makeApiCall(url, 'POST', timeEntryData);
                    
                    if (result.error) {
                        const errorMessage = typeof result.error === 'object' ? 
                            result.error.message || JSON.stringify(result.error) : 
                            result.error;
                        console.error('Time entry creation failed:', result.error);
                        
                        // Special handling for 405 Method Not Allowed
                        if (errorMessage.includes('405') || errorMessage.toLowerCase().includes('method not allowed')) {
                            createTimeEntryStatus.innerHTML = `
                                <div class="space-y-2 text-left">
                                    <div class="text-red-600 font-semibold">â›” Time Entry Creation Not Supported</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400">
                                        <p class="mb-2">The Toast API doesn't allow creating time entries via POST requests.</p>
                                        <p class="mb-2"><strong>Likely reasons:</strong></p>
                                        <ul class="list-disc list-inside mb-2 text-xs space-y-1">
                                            <li>Time entries must be created by physical clock-in/out</li>
                                            <li>Security restriction to prevent time fraud</li>
                                            <li>Integration with POS terminals required</li>
                                        </ul>
                                        <p class="text-blue-600 dark:text-blue-400">ðŸ’¡ You can still view existing time entries to analyze labor data!</p>
                                    </div>
                                </div>
                            `;
                        } else {
                            createTimeEntryStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${errorMessage}</span>`;
                        }
                    } else {
                        const newTimeEntry = result.data;
                        createTimeEntryStatus.innerHTML = `<span class="text-green-600">âœ“ Time entry created successfully</span>`;
                        displayTimeEntryResults([newTimeEntry], 'New Time Entry Created');
                        
                        // Clear form
                        timeEntryEmployeeDropdown.value = '';
                        timeEntryJobDropdown.value = '';
                        timeEntryClockIn.value = '';
                        timeEntryClockOut.value = '';
                        timeEntryCashTips.value = '';
                        timeEntryBreakMinutes.value = '';
                        updateTimeEntryHours();
                        updateTimeEntryJobDropdown();
                    }
                } catch (error) {
                    createTimeEntryStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    createTimeEntryBtnText.textContent = 'Create Time Entry';
                    createTimeEntrySpinner.classList.add('hidden');
                    createTimeEntryBtn.disabled = false;
                }
            }
            
            // Display functions for Labor Management results
            function getEmployeeAssignedJobs(employee) {
                // Debug: Log the employee object to see its structure
                console.log('Employee data structure:', employee);
                console.log('Employee properties:', Object.keys(employee));
                
                // Check various possible property names for job assignments
                const jobsProperty = employee.jobs || employee.jobReferences || employee.assignedJobs || employee.jobAssignments;
                
                console.log('Jobs property found:', jobsProperty);
                
                if (!jobsProperty || jobsProperty.length === 0) {
                    return '<span class="text-gray-400 text-xs">No jobs assigned</span>';
                }
                
                let jobsList = '';
                jobsProperty.forEach((jobRef, index) => {
                    // Find the job title from allJobs if available
                    const jobGuid = jobRef.guid || jobRef.id || jobRef;
                    const job = allJobs?.find(j => j.guid === jobGuid);
                    const jobTitle = job ? job.title : (jobGuid?.slice(-8) || 'Unknown');
                    
                    console.log('Processing job reference:', jobRef, 'Found job:', job);
                    
                    if (index > 0) jobsList += ', ';
                    jobsList += `<span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs px-2 py-1 rounded-full mr-1 mb-1">${jobTitle}</span>`;
                });
                
                return jobsList || '<span class="text-gray-400 text-xs">No jobs assigned</span>';
            }
            
            function getEmployeeJobGuids(employeeGuid) {
                const employee = allEmployees?.find(emp => emp.guid === employeeGuid);
                console.log('Getting job GUIDs for employee:', employeeGuid, 'Found employee:', employee);
                
                if (!employee) {
                    return [];
                }
                
                // Check various possible property names for job assignments
                const jobsProperty = employee.jobs || employee.jobReferences || employee.assignedJobs || employee.jobAssignments;
                
                console.log('Jobs property for filtering:', jobsProperty);
                
                if (!jobsProperty || jobsProperty.length === 0) {
                    return [];
                }
                
                const jobGuids = jobsProperty.map(jobRef => jobRef.guid || jobRef.id || jobRef);
                console.log('Extracted job GUIDs:', jobGuids);
                
                return jobGuids;
            }
            
            function updateShiftJobDropdownForEmployee() {
                const selectedEmployeeGuid = shiftEmployeeDropdown.value;
                
                // Clear the job dropdown first
                shiftJobDropdown.innerHTML = '<option value="">Select job...</option>';
                
                if (!selectedEmployeeGuid) {
                    // If no employee selected, disable job dropdown
                    shiftJobDropdown.disabled = true;
                    shiftJobDropdown.innerHTML = '<option value="">Select employee first...</option>';
                    return;
                }
                
                // Get jobs assigned to this employee
                const assignedJobGuids = getEmployeeJobGuids(selectedEmployeeGuid);
                
                if (assignedJobGuids.length === 0) {
                    // Employee has no assigned jobs, show all jobs with warning
                    shiftJobDropdown.disabled = false;
                    shiftJobDropdown.innerHTML = '<option value="">âš ï¸ Employee has no assigned jobs</option>';
                    if (allJobs && allJobs.length > 0) {
                        allJobs.forEach(job => {
                            if (!job.deleted) {
                                shiftJobDropdown.innerHTML += `<option value="${job.guid}">âš ï¸ ${job.title} (not assigned)</option>`;
                            }
                        });
                    }
                } else {
                    // Show only assigned jobs
                    shiftJobDropdown.disabled = false;
                    assignedJobGuids.forEach(jobGuid => {
                        const job = allJobs?.find(j => j.guid === jobGuid);
                        if (job && !job.deleted) {
                            shiftJobDropdown.innerHTML += `<option value="${job.guid}">âœ… ${job.title}</option>`;
                        }
                    });
                }
                
                // Update create shift button state
                updateCreateShiftButtonState();
            }
            
            function updateCreateShiftButtonState() {
                const hasEmployee = shiftEmployeeDropdown.value !== '';
                const hasJob = shiftJobDropdown.value !== '';
                const hasStartTime = shiftStartTime.value !== '';
                const hasEndTime = shiftEndTime.value !== '';
                
                createShiftBtn.disabled = !(hasEmployee && hasJob && hasStartTime && hasEndTime);
            }
            
            function displayEmployeeResults(employees, title) {
                let html = `<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-3">${title}</h3>`;
                
                if (employees.length === 0) {
                    html += '<p class="text-gray-500">No employees found</p>';
                } else {
                    html += '<div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-gray-50 dark:bg-gray-700"><tr>';
                    html += '<th class="px-3 py-2 text-left font-medium">Name</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Email</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Assigned Jobs</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">GUID</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Status</th>';
                    html += '</tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">';
                    
                    employees.forEach(emp => {
                        const fullName = [emp.firstName, emp.chosenName, emp.lastName].filter(n => n).join(' ');
                        const statusClass = emp.deleted ? 'text-red-600' : 'text-green-600';
                        const status = emp.deleted ? 'Deleted' : 'Active';
                        
                        // Get assigned jobs for this employee
                        const assignedJobs = getEmployeeAssignedJobs(emp);
                        
                        html += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700">`;
                        html += `<td class="px-3 py-2">${fullName || 'N/A'}</td>`;
                        html += `<td class="px-3 py-2">${emp.email || 'N/A'}</td>`;
                        html += `<td class="px-3 py-2">${assignedJobs}</td>`;
                        html += `<td class="px-3 py-2 font-mono text-xs">${emp.guid || 'N/A'}</td>`;
                        html += `<td class="px-3 py-2 ${statusClass}">${status}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
            }
            
            function displayJobResults(jobs, title) {
                let html = `<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-3">${title}</h3>`;
                
                if (jobs.length === 0) {
                    html += '<p class="text-gray-500">No jobs found</p>';
                } else {
                    html += '<div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-gray-50 dark:bg-gray-700"><tr>';
                    html += '<th class="px-3 py-2 text-left font-medium">Title</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">GUID</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Default Wage</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Tipped</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Status</th>';
                    html += '</tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">';
                    
                    jobs.forEach(job => {
                        const statusClass = job.deleted ? 'text-red-600' : 'text-green-600';
                        const status = job.deleted ? 'Deleted' : 'Active';
                        const wage = job.defaultWage ? `$${job.defaultWage}/${job.wageFrequency?.toLowerCase() || 'hr'}` : 'N/A';
                        
                        html += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700">`;
                        html += `<td class="px-3 py-2">${job.title || 'N/A'}</td>`;
                        html += `<td class="px-3 py-2 font-mono text-xs">${job.guid || 'N/A'}</td>`;
                        html += `<td class="px-3 py-2">${wage}</td>`;
                        html += `<td class="px-3 py-2">${job.tipped ? 'Yes' : 'No'}</td>`;
                        html += `<td class="px-3 py-2 ${statusClass}">${status}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
            }
            
            function displayShiftResults(shifts, title, reportData = null) {
                const reportId = `shift-report-${Date.now()}`;
                
                let html = `<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-4">${title}</h3>`;
                
                if (shifts.length === 0) {
                    html += '<p class="text-gray-500">No shifts found</p>';
                } else {
                    // Tab navigation
                    html += `
                        <div class="mb-4 border-b border-gray-200 dark:border-gray-600">
                            <nav class="-mb-px flex space-x-8">
                                <button onclick="showShiftTab('${reportId}', 'report')" 
                                        id="${reportId}-report-tab" 
                                        class="shift-tab-btn py-2 px-1 border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 font-medium text-sm">
                                    ðŸ“Š Labor Cost Report
                                </button>
                                <button onclick="showShiftTab('${reportId}', 'raw')" 
                                        id="${reportId}-raw-tab" 
                                        class="shift-tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 font-medium text-sm">
                                    ðŸ“‹ Raw Shift Data
                                </button>
                            </nav>
                        </div>`;
                    
                    // Labor Cost Report Tab
                    html += `<div id="${reportId}-report-content" class="shift-tab-content">`;
                    html += generateLaborCostReport(shifts, reportData);
                    html += '</div>';
                    
                    // Raw Data Tab
                    html += `<div id="${reportId}-raw-content" class="shift-tab-content hidden">`;
                    html += generateRawShiftTable(shifts);
                    html += '</div>';
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
            }
            
            function generateLaborCostReport(shifts, reportData) {
                let html = '';
                
                // Report Header
                if (reportData) {
                    const startFormatted = new Date(reportData.startDate).toLocaleDateString();
                    const endFormatted = new Date(reportData.endDate).toLocaleDateString();
                    
                    html += `
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
                            <h4 class="text-lg font-bold text-blue-900 dark:text-blue-100 mb-2">ðŸ“ˆ Labor Cost Analysis</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-semibold text-blue-800 dark:text-blue-200">Report Period:</span>
                                    <span class="ml-2 text-blue-700 dark:text-blue-300">${startFormatted} - ${endFormatted}</span>
                                </div>
                                <div>
                                    <span class="font-semibold text-blue-800 dark:text-blue-200">Total Shifts:</span>
                                    <span class="ml-2 text-blue-700 dark:text-blue-300">${shifts.length}</span>
                                </div>
                            </div>
                        </div>`;
                }
                
                // Calculate labor data
                const laborData = calculateLaborCosts(shifts);
                
                // Summary Cards
                html += `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                            <div class="text-green-600 dark:text-green-400 text-sm font-medium">Total Hours</div>
                            <div class="text-2xl font-bold text-green-900 dark:text-green-100">${laborData.totalHours.toFixed(1)}</div>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
                            <div class="text-purple-600 dark:text-purple-400 text-sm font-medium">Employees</div>
                            <div class="text-2xl font-bold text-purple-900 dark:text-purple-100">${laborData.uniqueEmployees}</div>
                        </div>
                        <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-4">
                            <div class="text-orange-600 dark:text-orange-400 text-sm font-medium">Job Types</div>
                            <div class="text-2xl font-bold text-orange-900 dark:text-orange-100">${laborData.uniqueJobs}</div>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                            <div class="text-blue-600 dark:text-blue-400 text-sm font-medium">Est. Labor Cost</div>
                            <div class="text-2xl font-bold text-blue-900 dark:text-blue-100">$${laborData.totalCost.toFixed(2)}</div>
                        </div>
                    </div>`;
                
                // Detailed Employee Breakdown
                html += `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-900 dark:text-gray-100 mb-4">ðŸ’¼ Employee Breakdown</h5>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100 dark:bg-gray-600">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-900 dark:text-gray-100">Employee</th>
                                        <th class="px-3 py-2 text-left font-semibold text-gray-900 dark:text-gray-100">Job Position</th>
                                        <th class="px-3 py-2 text-right font-semibold text-gray-900 dark:text-gray-100">Hours</th>
                                        <th class="px-3 py-2 text-right font-semibold text-gray-900 dark:text-gray-100">Hourly Rate</th>
                                        <th class="px-3 py-2 text-right font-semibold text-gray-900 dark:text-gray-100">Labor Cost</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-600">`;
                
                laborData.employeeBreakdown.forEach(emp => {
                    html += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
                            <td class="px-3 py-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white text-xs font-bold mr-3">
                                        ${emp.employeeName.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="font-medium text-gray-900 dark:text-gray-100">${emp.employeeName}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">${emp.employeeId}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-3 py-2">
                                <div>
                                    <div class="font-medium text-gray-900 dark:text-gray-100">${emp.jobTitle}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${emp.jobId}</div>
                                </div>
                            </td>
                            <td class="px-3 py-2 text-right font-mono">${emp.hours.toFixed(1)}h</td>
                            <td class="px-3 py-2 text-right font-mono">${emp.hourlyRate}</td>
                            <td class="px-3 py-2 text-right font-bold text-green-600 dark:text-green-400 font-mono">$${emp.laborCost.toFixed(2)}</td>
                        </tr>`;
                });
                
                html += `
                                </tbody>
                                <tfoot class="bg-gray-100 dark:bg-gray-600">
                                    <tr class="font-bold">
                                        <td colspan="2" class="px-3 py-3 text-gray-900 dark:text-gray-100">TOTALS</td>
                                        <td class="px-3 py-3 text-right text-gray-900 dark:text-gray-100 font-mono">${laborData.totalHours.toFixed(1)}h</td>
                                        <td class="px-3 py-3 text-right text-gray-500 dark:text-gray-400">â€”</td>
                                        <td class="px-3 py-3 text-right text-green-600 dark:text-green-400 font-mono text-lg">$${laborData.totalCost.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>`;
                
                // Add disclaimer
                html += `
                    <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                        <div class="flex items-start">
                            <span class="text-yellow-600 dark:text-yellow-400 mr-2">âš ï¸</span>
                            <div class="text-xs text-yellow-800 dark:text-yellow-200">
                                <strong>Note:</strong> This report uses estimated hourly rates where actual job pay rates are not available. 
                                Labor costs are calculated based on shift duration and may not reflect actual payroll including overtime, 
                                benefits, or other compensation factors.
                            </div>
                        </div>
                    </div>`;
                
                return html;
            }
            
            function generateRawShiftTable(shifts) {
                let html = '<div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-gray-50 dark:bg-gray-700"><tr>';
                html += '<th class="px-3 py-2 text-left font-medium">Employee ID</th>';
                html += '<th class="px-3 py-2 text-left font-medium">Job ID</th>';
                html += '<th class="px-3 py-2 text-left font-medium">Start Time</th>';
                html += '<th class="px-3 py-2 text-left font-medium">End Time</th>';
                html += '<th class="px-3 py-2 text-left font-medium">Duration</th>';
                html += '<th class="px-3 py-2 text-left font-medium">Shift GUID</th>';
                html += '</tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">';
                
                shifts.forEach(shift => {
                    const startDate = new Date(shift.inDate);
                    const endDate = new Date(shift.outDate);
                    const duration = ((endDate - startDate) / (1000 * 60 * 60)).toFixed(1);
                    const startFormatted = startDate.toLocaleDateString() + ' ' + startDate.toLocaleTimeString();
                    const endFormatted = endDate.toLocaleDateString() + ' ' + endDate.toLocaleTimeString();
                    
                    html += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700">`;
                    html += `<td class="px-3 py-2 font-mono text-xs">${shift.employeeReference?.guid || 'N/A'}</td>`;
                    html += `<td class="px-3 py-2 font-mono text-xs">${shift.jobReference?.guid || 'N/A'}</td>`;
                    html += `<td class="px-3 py-2">${startFormatted}</td>`;
                    html += `<td class="px-3 py-2">${endFormatted}</td>`;
                    html += `<td class="px-3 py-2 font-mono font-bold">${duration}h</td>`;
                    html += `<td class="px-3 py-2 font-mono text-xs">${shift.guid || 'N/A'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                return html;
            }
            
            function calculateLaborCosts(shifts) {
                const employeeMap = new Map();
                let totalHours = 0;
                let totalCost = 0;
                
                shifts.forEach(shift => {
                    const employeeId = shift.employeeReference?.guid || 'Unknown';
                    const jobId = shift.jobReference?.guid || 'Unknown';
                    const startDate = new Date(shift.inDate);
                    const endDate = new Date(shift.outDate);
                    const hours = (endDate - startDate) / (1000 * 60 * 60);
                    
                    totalHours += hours;
                    
                    const key = `${employeeId}-${jobId}`;
                    if (!employeeMap.has(key)) {
                        // Look up employee name from allEmployees if available
                        const employee = allEmployees?.find(emp => emp.guid === employeeId);
                        const job = allJobs?.find(j => j.guid === jobId);
                        
                        const employeeName = employee ? 
                            [employee.firstName, employee.lastName].filter(n => n).join(' ') || 
                            employee.email || 
                            `Employee ${employeeId.slice(-8)}` 
                            : `Employee ${employeeId.slice(-8)}`;
                        
                        const jobTitle = job?.title || `Job ${jobId.slice(-8)}`;
                        
                        // Estimate hourly rate based on job title or use default
                        const hourlyRate = estimateHourlyRate(jobTitle);
                        
                        employeeMap.set(key, {
                            employeeId: employeeId.slice(-8),
                            employeeName: employeeName,
                            jobId: jobId.slice(-8),
                            jobTitle: jobTitle,
                            hours: 0,
                            hourlyRate: hourlyRate,
                            laborCost: 0
                        });
                    }
                    
                    const emp = employeeMap.get(key);
                    emp.hours += hours;
                    emp.laborCost = emp.hours * parseFloat(emp.hourlyRate.replace('$', ''));
                    totalCost += hours * parseFloat(emp.hourlyRate.replace('$', ''));
                });
                
                const employeeBreakdown = Array.from(employeeMap.values())
                    .sort((a, b) => b.laborCost - a.laborCost);
                
                return {
                    totalHours: totalHours,
                    totalCost: totalCost,
                    uniqueEmployees: new Set(shifts.map(s => s.employeeReference?.guid)).size,
                    uniqueJobs: new Set(shifts.map(s => s.jobReference?.guid)).size,
                    employeeBreakdown: employeeBreakdown
                };
            }
            
            function estimateHourlyRate(jobTitle) {
                const title = jobTitle.toLowerCase();
                
                // Estimate rates based on common restaurant positions
                if (title.includes('manager') || title.includes('supervisor')) return '$22.00';
                if (title.includes('chef') || title.includes('cook')) return '$18.00';
                if (title.includes('server') || title.includes('waiter') || title.includes('waitress')) return '$15.00';
                if (title.includes('bartender') || title.includes('bar')) return '$16.00';
                if (title.includes('host') || title.includes('hostess')) return '$14.00';
                if (title.includes('cashier') || title.includes('register')) return '$15.00';
                if (title.includes('dishwasher') || title.includes('prep')) return '$13.00';
                if (title.includes('driver') || title.includes('delivery')) return '$16.00';
                
                // Default rate for unknown positions
                return '$15.50';
            }
            
            // Helper functions for shift creation
            window.setTodayShiftTimes = function() {
                const today = new Date();
                const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 9, 0); // 9:00 AM
                const endTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 17, 0); // 5:00 PM
                
                shiftStartTime.value = startTime.toISOString().slice(0, 16); // Format for datetime-local
                shiftEndTime.value = endTime.toISOString().slice(0, 16);
                
                updateShiftDurationDisplay();
            };
            
            window.setTomorrowMorningShift = function() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const startTime = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 8, 0); // 8:00 AM
                const endTime = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), 12, 0); // 12:00 PM
                
                shiftStartTime.value = startTime.toISOString().slice(0, 16);
                shiftEndTime.value = endTime.toISOString().slice(0, 16);
                
                updateShiftDurationDisplay();
            };
            
            window.setSimpleTestShift = function() {
                // Set a very simple 2-hour shift starting in 1 hour from now
                const now = new Date();
                const startTime = new Date(now.getTime() + 60 * 60 * 1000); // 1 hour from now
                const endTime = new Date(startTime.getTime() + 2 * 60 * 60 * 1000); // 2 hours later
                
                shiftStartTime.value = startTime.toISOString().slice(0, 16);
                shiftEndTime.value = endTime.toISOString().slice(0, 16);
                
                updateShiftDurationDisplay();
            };
            
            function updateShiftDurationDisplay() {
                const shiftDurationDisplay = document.getElementById('shiftDurationDisplay');
                if (!shiftDurationDisplay) return;
                
                const startTime = shiftStartTime.value;
                const endTime = shiftEndTime.value;
                
                if (startTime && endTime) {
                    const start = new Date(startTime);
                    const end = new Date(endTime);
                    
                    if (end > start) {
                        const duration = (end - start) / (1000 * 60 * 60); // Hours
                        shiftDurationDisplay.textContent = `${duration.toFixed(1)} hours`;
                        shiftDurationDisplay.className = 'text-xs text-green-600 dark:text-green-400 font-medium';
                    } else {
                        shiftDurationDisplay.textContent = 'Invalid times';
                        shiftDurationDisplay.className = 'text-xs text-red-600 dark:text-red-400';
                    }
                } else {
                    shiftDurationDisplay.textContent = '';
                }
            }
            
            // Tab switching function for shift results
            window.showShiftTab = function(reportId, tabType) {
                // Hide all tab contents
                document.getElementById(`${reportId}-report-content`).classList.add('hidden');
                document.getElementById(`${reportId}-raw-content`).classList.add('hidden');
                
                // Remove active styles from all tabs
                document.querySelectorAll('.shift-tab-btn').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:hover:text-gray-300');
                });
                
                // Show selected tab content
                document.getElementById(`${reportId}-${tabType}-content`).classList.remove('hidden');
                
                // Add active styles to selected tab
                const activeTab = document.getElementById(`${reportId}-${tabType}-tab`);
                activeTab.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                activeTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:hover:text-gray-300');
            };
            
            function displayTimeEntryResults(timeEntries, title) {
                let html = `<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-3">${title}</h3>`;
                
                if (timeEntries.length === 0) {
                    html += '<p class="text-gray-500">No time entries found</p>';
                } else {
                    html += '<div class="overflow-x-auto"><table class="min-w-full text-sm"><thead class="bg-gray-50 dark:bg-gray-700"><tr>';
                    html += '<th class="px-3 py-2 text-left font-medium">Employee</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">In Date</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Out Date</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Regular Hours</th>';
                    html += '<th class="px-3 py-2 text-left font-medium">Tips</th>';
                    html += '</tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600">';
                    
                    timeEntries.forEach(entry => {
                        const inDate = entry.inDate ? new Date(entry.inDate).toLocaleDateString() + ' ' + new Date(entry.inDate).toLocaleTimeString() : 'N/A';
                        const outDate = entry.outDate ? new Date(entry.outDate).toLocaleDateString() + ' ' + new Date(entry.outDate).toLocaleTimeString() : 'Still clocked in';
                        const totalTips = ((entry.declaredCashTips || 0) + (entry.nonCashTips || 0)).toFixed(2);
                        
                        html += `<tr class="hover:bg-gray-50 dark:hover:bg-gray-700">`;
                        html += `<td class="px-3 py-2">${entry.employeeReference?.guid?.slice(-8) || 'N/A'}</td>`;
                        html += `<td class="px-3 py-2">${inDate}</td>`;
                        html += `<td class="px-3 py-2">${outDate}</td>`;
                        html += `<td class="px-3 py-2">${entry.regularHours || 0} hrs</td>`;
                        html += `<td class="px-3 py-2">$${totalTips}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
            }

            // --- Menu Management Functions ---
            
            // Fetch All Menus
            async function fetchAllMenus() {
                fetchAllMenusBtnText.textContent = 'Fetching...';
                fetchAllMenusSpinner.classList.remove('hidden');
                fetchAllMenusBtn.disabled = true;
                viewMenusStatus.innerHTML = '';
                
                try {
                    const url = CORS_PROXY + environmentSelect.value + MENUS_PATH_BASE;
                    const result = await makeApiCall(url, 'GET', null, viewMenusStatus, 'Menus fetched successfully');
                    
                    if (result.error) {
                        const errorMessage = typeof result.error === 'object' ? 
                            result.error.message || JSON.stringify(result.error) : 
                            result.error;
                        viewMenusStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${errorMessage}</span>`;
                    } else {
                        allMenus = result.data || [];
                        viewMenusStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${allMenus.length} menus</span>`;
                        populateMenuDropdowns();
                        displayMenuResults(allMenus, 'All Restaurant Menus');
                        
                        // Extract menu groups and items for other dropdowns
                        extractMenuGroupsAndItems();
                    }
                } catch (error) {
                    viewMenusStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    fetchAllMenusBtnText.textContent = 'Fetch All Menus';
                    fetchAllMenusSpinner.classList.add('hidden');
                    fetchAllMenusBtn.disabled = false;
                }
            }
            
            // View Selected Menu
            function viewSelectedMenu() {
                const selectedGuid = menuDropdown.value;
                if (!selectedGuid) {
                    viewMenusStatus.innerHTML = `<span class="text-yellow-600">Please select a menu first</span>`;
                    return;
                }
                
                const selectedMenu = allMenus.find(menu => menu.guid === selectedGuid);
                if (selectedMenu) {
                    displayMenuResults([selectedMenu], 'Selected Menu Details');
                    viewMenusStatus.innerHTML = `<span class="text-green-600">âœ“ Menu details displayed</span>`;
                } else {
                    viewMenusStatus.innerHTML = `<span class="text-red-600">âœ— Menu not found in cache</span>`;
                }
            }
            
            // Extract Menu Groups and Items from fetched menus
            function extractMenuGroupsAndItems() {
                allMenuGroups = [];
                allMenuItems = [];
                
                allMenus.forEach(menu => {
                    if (menu.menuGroups) {
                        menu.menuGroups.forEach(group => {
                            allMenuGroups.push({
                                ...group,
                                menuName: menu.name,
                                menuGuid: menu.guid
                            });
                            
                            if (group.menuItems) {
                                group.menuItems.forEach(item => {
                                    allMenuItems.push({
                                        ...item,
                                        groupName: group.name,
                                        groupGuid: group.guid,
                                        menuName: menu.name,
                                        menuGuid: menu.guid
                                    });
                                });
                            }
                        });
                    }
                });
                
                populateMenuGroupDropdowns();
                populateMenuItemDropdowns();
                
                console.log(`Extracted ${allMenuGroups.length} menu groups and ${allMenuItems.length} menu items`);
            }
            
            // Populate Menu Dropdowns
            function populateMenuDropdowns() {
                if (menuDropdown) {
                    menuDropdown.innerHTML = '<option value="">Select a menu...</option>';
                    allMenus.forEach(menu => {
                        const displayName = menu.name || menu.guid.slice(-8);
                        menuDropdown.innerHTML += `<option value="${menu.guid}">${displayName}</option>`;
                    });
                    
                    // Enable buttons that depend on menu data
                    viewSelectedMenuBtn.disabled = false;
                }
            }
            
            // Populate Menu Group Dropdowns
            function populateMenuGroupDropdowns() {
                if (menuGroupDropdown) {
                    menuGroupDropdown.innerHTML = '<option value="">Select a category...</option>';
                    allMenuGroups.forEach(group => {
                        const displayName = `${group.name} (${group.menuName})`;
                        menuGroupDropdown.innerHTML += `<option value="${group.guid}">${displayName}</option>`;
                    });
                    
                    // Enable buttons
                    viewMenuGroupBtn.disabled = false;
                }
            }
            
            // Populate Menu Item Dropdowns
            function populateMenuItemDropdowns() {
                const dropdowns = [menuItemDropdown, itemOperationDropdown];
                
                dropdowns.forEach(dropdown => {
                    if (dropdown) {
                        const placeholder = dropdown === menuItemDropdown ? 'Select an item...' : 'Select item for operations...';
                        dropdown.innerHTML = `<option value="">${placeholder}</option>`;
                        
                        allMenuItems.forEach(item => {
                            const displayName = `${item.name} (${item.groupName})`;
                            dropdown.innerHTML += `<option value="${item.guid}">${displayName}</option>`;
                        });
                    }
                });
                
                // Enable buttons
                if (viewSelectedItemBtn) viewSelectedItemBtn.disabled = false;
            }
            
            // Display Menu Results
            function displayMenuResults(menus, title) {
                let html = `<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-3">${title}</h3>`;
                
                if (menus.length === 0) {
                    html += '<p class="text-gray-500">No menus found</p>';
                } else {
                    html += '<div class="space-y-4">';
                    
                    menus.forEach(menu => {
                        html += `
                        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-amber-600 dark:text-amber-400">${menu.name || 'Unnamed Menu'}</h4>
                                <span class="text-xs text-gray-500 font-mono">${menu.guid.slice(-8)}</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">Menu Groups:</span> ${menu.menuGroups ? menu.menuGroups.length : 0}
                                </div>
                                <div>
                                    <span class="font-medium">Total Items:</span> ${menu.menuGroups ? 
                                        menu.menuGroups.reduce((total, group) => total + (group.menuItems ? group.menuItems.length : 0), 0) : 0}
                                </div>
                                <div>
                                    <span class="font-medium">Master:</span> ${menu.master ? 'Yes' : 'No'}
                                </div>
                                <div>
                                    <span class="font-medium">Status:</span> <span class="px-2 py-1 rounded text-xs ${menu.published ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'}">${menu.published ? 'Published' : 'Draft'}</span>
                                </div>
                            </div>`;
                        
                        // Show menu groups if available
                        if (menu.menuGroups && menu.menuGroups.length > 0) {
                            html += `
                            <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <h5 class="font-medium mb-2">Menu Categories (${menu.menuGroups.length}):</h5>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">`;
                            
                            menu.menuGroups.forEach(group => {
                                const itemCount = group.menuItems ? group.menuItems.length : 0;
                                html += `
                                <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-sm">
                                    <div class="font-medium">${group.name}</div>
                                    <div class="text-gray-600 dark:text-gray-400">${itemCount} items</div>
                                </div>`;
                            });
                            
                            html += `
                                </div>
                            </div>`;
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
            }

            // --- Menu Items Management Functions ---
            
            // View Selected Menu Item
            function viewSelectedItem() {
                const selectedGuid = menuItemDropdown.value;
                if (!selectedGuid) {
                    searchMenuItemsStatus.innerHTML = `<span class="text-yellow-600">Please select an item first</span>`;
                    return;
                }
                
                const selectedItem = allMenuItems.find(item => item.guid === selectedGuid);
                if (selectedItem) {
                    displayMenuItemResults([selectedItem], 'Selected Item Details');
                    searchMenuItemsStatus.innerHTML = `<span class="text-green-600">âœ“ Item details displayed</span>`;
                } else {
                    searchMenuItemsStatus.innerHTML = `<span class="text-red-600">âœ— Item not found in cache</span>`;
                }
            }
            
            // Search Menu Items
            async function searchMenuItems() {
                const searchTerm = itemSearchInput.value.trim();
                if (!searchTerm) {
                    searchMenuItemsStatus.innerHTML = `<span class="text-yellow-600">Please enter a search term</span>`;
                    return;
                }
                
                searchMenuItemsBtnText.textContent = 'Searching...';
                searchMenuItemsSpinner.classList.remove('hidden');
                searchMenuItemsBtn.disabled = true;
                searchMenuItemsStatus.innerHTML = '';
                
                try {
                    // If menus aren't loaded yet, load them first
                    if (allMenuItems.length === 0) {
                        await fetchAllMenus();
                    }
                    
                    // Filter items by search term (name, description, or price)
                    const filteredItems = allMenuItems.filter(item => {
                        const searchLower = searchTerm.toLowerCase();
                        return (
                            (item.name && item.name.toLowerCase().includes(searchLower)) ||
                            (item.description && item.description.toLowerCase().includes(searchLower)) ||
                            (item.basePrice && item.basePrice.toString().includes(searchTerm)) ||
                            (item.plu && item.plu.toLowerCase().includes(searchLower))
                        );
                    });
                    
                    searchMenuItemsStatus.innerHTML = `<span class="text-green-600">âœ“ Found ${filteredItems.length} matching items</span>`;
                    displayMenuItemResults(filteredItems, `Search Results for "${searchTerm}"`);
                    
                } catch (error) {
                    searchMenuItemsStatus.innerHTML = `<span class="text-red-600">âœ— Search failed: ${error.message}</span>`;
                } finally {
                    searchMenuItemsBtnText.textContent = 'Search Items';
                    searchMenuItemsSpinner.classList.add('hidden');
                    searchMenuItemsBtn.disabled = false;
                }
            }
            
            // Update Item Price
            async function updateItemPrice() {
                const selectedGuid = itemOperationDropdown.value;
                if (!selectedGuid) {
                    itemOperationsStatus.innerHTML = `<span class="text-yellow-600">Please select an item first</span>`;
                    return;
                }
                
                const newPrice = prompt('Enter new price (in cents, e.g., 1250 for $12.50):');
                if (!newPrice || isNaN(newPrice) || newPrice <= 0) {
                    itemOperationsStatus.innerHTML = `<span class="text-red-600">âœ— Invalid price entered</span>`;
                    return;
                }
                
                const selectedItem = allMenuItems.find(item => item.guid === selectedGuid);
                if (!selectedItem) {
                    itemOperationsStatus.innerHTML = `<span class="text-red-600">âœ— Item not found</span>`;
                    return;
                }
                
                updateItemPriceBtn.disabled = true;
                itemOperationsStatus.innerHTML = '<span class="text-blue-600">â³ Updating price...</span>';
                
                try {
                    const url = CORS_PROXY + environmentSelect.value + MENU_ITEMS_PATH + '/' + selectedGuid;
                    const updateData = {
                        basePrice: parseInt(newPrice)
                    };
                    
                    const result = await makeApiCall(url, 'PATCH', updateData, null, 'Price updated successfully');
                    
                    if (result.error) {
                        const errorMessage = typeof result.error === 'object' ? 
                            result.error.message || JSON.stringify(result.error) : 
                            result.error;
                        itemOperationsStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${errorMessage}</span>`;
                    } else {
                        // Update the cached item
                        const itemIndex = allMenuItems.findIndex(item => item.guid === selectedGuid);
                        if (itemIndex !== -1) {
                            allMenuItems[itemIndex].basePrice = parseInt(newPrice);
                        }
                        
                        itemOperationsStatus.innerHTML = `<span class="text-green-600">âœ“ Price updated to $${(newPrice / 100).toFixed(2)}</span>`;
                        displayMenuItemResults([result.data || selectedItem], 'Updated Item');
                    }
                } catch (error) {
                    itemOperationsStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    updateItemPriceBtn.disabled = false;
                }
            }
            
            // Toggle Item Availability
            async function toggleItemAvailability() {
                const selectedGuid = itemOperationDropdown.value;
                if (!selectedGuid) {
                    itemOperationsStatus.innerHTML = `<span class="text-yellow-600">Please select an item first</span>`;
                    return;
                }
                
                const selectedItem = allMenuItems.find(item => item.guid === selectedGuid);
                if (!selectedItem) {
                    itemOperationsStatus.innerHTML = `<span class="text-red-600">âœ— Item not found</span>`;
                    return;
                }
                
                const currentlyActive = selectedItem.active !== false; // Default to true if undefined
                const newStatus = !currentlyActive;
                
                toggleItemAvailabilityBtn.disabled = true;
                itemOperationsStatus.innerHTML = `<span class="text-blue-600">â³ ${newStatus ? 'Enabling' : 'Disabling'} item...</span>`;
                
                try {
                    const url = CORS_PROXY + environmentSelect.value + MENU_ITEMS_PATH + '/' + selectedGuid;
                    const updateData = {
                        active: newStatus
                    };
                    
                    const result = await makeApiCall(url, 'PATCH', updateData, null, 'Availability updated successfully');
                    
                    if (result.error) {
                        const errorMessage = typeof result.error === 'object' ? 
                            result.error.message || JSON.stringify(result.error) : 
                            result.error;
                        itemOperationsStatus.innerHTML = `<span class="text-red-600">âœ— Failed: ${errorMessage}</span>`;
                    } else {
                        // Update the cached item
                        const itemIndex = allMenuItems.findIndex(item => item.guid === selectedGuid);
                        if (itemIndex !== -1) {
                            allMenuItems[itemIndex].active = newStatus;
                        }
                        
                        itemOperationsStatus.innerHTML = `<span class="text-green-600">âœ“ Item ${newStatus ? 'enabled' : 'disabled'}</span>`;
                        displayMenuItemResults([result.data || selectedItem], 'Updated Item Availability');
                    }
                } catch (error) {
                    itemOperationsStatus.innerHTML = `<span class="text-red-600">âœ— Error: ${error.message}</span>`;
                } finally {
                    toggleItemAvailabilityBtn.disabled = false;
                }
            }
            
            // Display Menu Item Results
            function displayMenuItemResults(items, title) {
                let html = `<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-3">${title}</h3>`;
                
                if (items.length === 0) {
                    html += '<p class="text-gray-500">No menu items found</p>';
                } else {
                    html += '<div class="space-y-4">';
                    
                    items.forEach(item => {
                        const price = item.basePrice ? `$${(item.basePrice / 100).toFixed(2)}` : 'No price set';
                        const isActive = item.active !== false; // Default to true if undefined
                        const statusClass = isActive ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
                        const statusText = isActive ? 'Available' : 'Unavailable';
                        
                        html += `
                        <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-emerald-600 dark:text-emerald-400">${item.name || 'Unnamed Item'}</h4>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 rounded text-xs ${statusClass}">${statusText}</span>
                                    <span class="text-xs text-gray-500 font-mono">${item.guid.slice(-8)}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">Price:</span> <span class="text-green-600 dark:text-green-400 font-semibold">${price}</span>
                                </div>
                                <div>
                                    <span class="font-medium">Category:</span> ${item.groupName || 'Unknown'}
                                </div>
                                <div>
                                    <span class="font-medium">Menu:</span> ${item.menuName || 'Unknown'}
                                </div>
                                <div>
                                    <span class="font-medium">PLU:</span> ${item.plu || 'Not set'}
                                </div>
                            </div>`;
                        
                        // Show description if available
                        if (item.description) {
                            html += `
                            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <span class="font-medium text-sm">Description:</span>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${item.description}</p>
                            </div>`;
                        }
                        
                        // Show modifiers if available
                        if (item.modifierGroups && item.modifierGroups.length > 0) {
                            html += `
                            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                <span class="font-medium text-sm">Modifiers (${item.modifierGroups.length}):</span>
                                <div class="flex flex-wrap gap-1 mt-2">`;
                            
                            item.modifierGroups.forEach(modGroup => {
                                html += `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded">${modGroup.name || 'Modifier Group'}</span>`;
                            });
                            
                            html += `
                                </div>
                            </div>`;
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
            }

            // --- Event Listeners ---
            testProxyBtn.addEventListener('click', testProxyConnection);
            authBtn.addEventListener('click', handleAuthentication);
            logoutBtn.addEventListener('click', handleLogout);
            fetchRestaurantNameBtn.addEventListener('click', fetchRestaurantName);
            fetchAllConfigBtn.addEventListener('click', fetchAllConfig);

            // Navigation panel toggles
            const toggleNavPanel = () => {
                navPanel.classList.toggle('open');
                navOverlay.classList.toggle('open');
            };
            toggleNavBtn.addEventListener('click', toggleNavPanel);
            closeNavBtn.addEventListener('click', toggleNavPanel);
            navOverlay.addEventListener('click', toggleNavPanel);
            
            // Welcome button click handler (using event delegation)
            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'welcomeNavBtn') {
                    toggleNavPanel();
                }
            });
            
            // Navigation workflow buttons
            navCreateOrderBtn.addEventListener('click', () => { 
                currentWorkflow = 'create'; 
                updateUIState(); 
                toggleNavPanel(); // Close nav panel
                resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400">Order results will appear here after sending.</p>';
            });
            navFetchOrderBtn.addEventListener('click', () => { 
                currentWorkflow = 'fetch'; 
                updateUIState(); 
                toggleNavPanel(); // Close nav panel
                resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400">Results will be displayed here.</p>' 
            });
            navUpdateOrderBtn.addEventListener('click', () => { 
                currentWorkflow = 'update'; 
                updateUIState(); 
                toggleNavPanel(); // Close nav panel
                resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400">Load an order to begin editing.</p>' 
            });
            navStockBtn.addEventListener('click', () => { 
                currentWorkflow = 'stock'; 
                updateUIState(); 
                toggleNavPanel(); // Close nav panel
                resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400">Inventory results will be displayed here.</p>' 
            });

            // Labor Management Navigation
            navEmployeeManagementBtn.addEventListener('click', () => { 
                currentWorkflow = 'employee-management'; 
                updateUIState();
                // Auto-fetch employee data
                if (isAuthenticated) {
                    fetchAllEmployees();
                }
                toggleNavPanel(); // Close nav panel
            });

            navShiftManagementBtn.addEventListener('click', () => { 
                currentWorkflow = 'shift-management'; 
                updateUIState();
                // Auto-fetch employee data for shift creation
                if (isAuthenticated) {
                    fetchAllEmployees();
                }
                toggleNavPanel(); // Close nav panel
            });

            navJobManagementBtn.addEventListener('click', () => { 
                currentWorkflow = 'job-management'; 
                updateUIState();
                // Auto-fetch job data
                if (isAuthenticated) {
                    fetchAllJobs();
                }
                toggleNavPanel(); // Close nav panel
            });

            navTimeEntryManagementBtn.addEventListener('click', () => { 
                currentWorkflow = 'time-entry-management'; 
                updateUIState();
                toggleNavPanel(); // Close nav panel
            });
            // Menu Management Sub-navigation
            navMenuStructureBtn.addEventListener('click', () => { 
                currentWorkflow = 'menu-structure'; 
                updateUIState();
                // Auto-fetch menu data for structure management
                if (isAuthenticated) {
                    fetchAllMenus();
                }
                toggleNavPanel(); // Close nav panel
            });
            navMenuItemsBtn.addEventListener('click', () => { 
                currentWorkflow = 'menu-items'; 
                updateUIState();
                // Auto-fetch menu data for item management
                if (isAuthenticated) {
                    fetchAllMenus();
                }
                toggleNavPanel(); // Close nav panel
            });
            navModifiersBtn.addEventListener('click', () => { 
                currentWorkflow = 'modifiers'; 
                updateUIState();
                // Auto-fetch modifier groups
                if (isAuthenticated && typeof fetchModifierGroups === 'function') {
                    fetchModifierGroups();
                }
                toggleNavPanel(); // Close nav panel
            });
            navBulkOperationsBtn.addEventListener('click', () => { 
                currentWorkflow = 'bulk-operations'; 
                updateUIState();
                // Auto-fetch menu data for bulk operations
                if (isAuthenticated) {
                    fetchAllMenus();
                }
                toggleNavPanel(); // Close nav panel
            });

            // API Section toggles for collapsible navigation
            const toggleApiSection = (apiName) => {
                const subMenu = document.getElementById(`${apiName}SubMenu`);
                const chevron = document.getElementById(`${apiName}Chevron`);
                
                if (subMenu && chevron) {
                    if (subMenu.classList.contains('hidden')) {
                        subMenu.classList.remove('hidden');
                        chevron.style.transform = 'rotate(90deg)';
                    } else {
                        subMenu.classList.add('hidden');
                        chevron.style.transform = 'rotate(0deg)';
                    }
                }
            };
            
            // Make toggleApiSection globally available for onclick handlers
            window.toggleApiSection = toggleApiSection;


            // Config panel toggles
            const toggleConfigPanel = () => {
                configPanel.classList.toggle('open');
                configOverlay.classList.toggle('open');
            };
            toggleConfigBtn.addEventListener('click', toggleConfigPanel);
            closeConfigBtn.addEventListener('click', toggleConfigPanel);
            configOverlay.addEventListener('click', toggleConfigPanel);

            // Troubleshooting panel toggles
            const toggleTroubleshootingPanel = () => {
                troubleshootingPanel.classList.toggle('open');
                troubleshootingOverlay.classList.toggle('open');
            };
            toggleTroubleshootingBtn.addEventListener('click', toggleTroubleshootingPanel);
            closeTroubleshootingBtn.addEventListener('click', toggleTroubleshootingPanel);
            troubleshootingOverlay.addEventListener('click', toggleTroubleshootingPanel);

            // Workflow Selection
            createWorkflowBtn.addEventListener('click', () => { 
                currentWorkflow = 'create'; 
                updateUIState();
                renderCart();
                renderCustomFields();
                 resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400">Order results will appear here after sending.</p>';
            });
            // Legacy workflow buttons (now handled by navigation panel)
            fetchWorkflowBtn.addEventListener('click', () => { currentWorkflow = 'fetch'; updateUIState(); resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400">Results will be displayed here.</p>' });
            updateWorkflowBtn.addEventListener('click', () => { currentWorkflow = 'update'; updateUIState(); resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400">Load an order to begin editing.</p>' });
            stockWorkflowBtn.addEventListener('click', () => { currentWorkflow = 'stock'; updateUIState(); resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400">Inventory results will be displayed here.</p>' });
            laborWorkflowBtn.addEventListener('click', () => { currentWorkflow = 'employee-management'; updateUIState(); resultsContainer.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-sm">Select an employee management operation from the navigation panel...</p>' });
            resetWorkflowBtns.forEach(btn => btn.addEventListener('click', () => { 
                currentWorkflow = null; 
                activeUpdateOrder = null; 
                cartItems = [];
                customFields = [];
                stagedItemsForUpdate = [];
                // Clear any menu section highlights
                const allSections = document.querySelectorAll('#menuManagementSection .bg-amber-50, #menuManagementSection .dark\\:bg-amber-900\\/10');
                allSections.forEach(section => {
                    section.classList.remove('ring-2', 'ring-amber-400', 'ring-opacity-50', 'bg-amber-50', 'dark:bg-amber-900/10');
                    section.classList.add('bg-gray-50', 'dark:bg-gray-700');
                });
                updateUIState(); 
            }));

            // Create Order
            addItemBtn.addEventListener('click', () => {
                const selectedOption = itemSelectAdd.options[itemSelectAdd.selectedIndex];
                if(!selectedOption || !selectedOption.value) return;
                const [guid, itemGroupGuid] = selectedOption.value.split('|');
                const name = selectedOption.text;
                const quantity = itemQuantityInput.value;
                cartItems.push({ guid, itemGroupGuid, name, quantity });
                renderCart();
            });
            itemsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('removeItemBtn')) {
                    cartItems.splice(e.target.dataset.index, 1);
                    renderCart();
                }
            });
            sendOrderBtn.addEventListener('click', createAndSendOrder);

            discountSelect.addEventListener('change', handleDiscountSelectChange);
            
            // Custom Fields
            addCustomFieldBtn.addEventListener('click', () => {
                const key = customFieldKeyInput.value.trim();
                const value = customFieldValueInput.value.trim();
                if (!key) return;
                customFields.push({ key, value });
                renderCustomFields();
                customFieldKeyInput.value = '';
                customFieldValueInput.value = '';
            });

            customFieldsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('removeCustomFieldBtn')) {
                    customFields.splice(e.target.dataset.index, 1);
                    renderCustomFields();
                }
            });

            diningOptionsSelect.addEventListener('change', (e) => {
                const selectedOptionText = e.target.options[e.target.selectedIndex].text;
                const isDelivery = selectedOptionText.toLowerCase().includes('delivery');
                
                deliveryInfoSection.style.display = isDelivery ? 'block' : 'none';
                guestFirstNameInput.required = isDelivery;
                guestLastNameInput.required = isDelivery;
                guestPhoneInput.required = isDelivery;
            });

            function generateRandomDetails() {
                const firstNames = ['John', 'Jane', 'Peter', 'Mary', 'David', 'Susan'];
                const lastNames = ['Smith', 'Jones', 'Williams', 'Brown', 'Davis', 'Miller'];
                const streetNames = ['Main St', 'Highland Ave', 'Maple St', 'Oak Ave', 'Park Ave'];
                const cities = ['Boston', 'Cambridge', 'Somerville', 'Brookline', 'Newton'];
                
                const randomFromArray = (arr) => arr[Math.floor(Math.random() * arr.length)];
                
                const firstName = randomFromArray(firstNames);
                const lastName = randomFromArray(lastNames);
                
                guestFirstNameInput.value = firstName;
                guestLastNameInput.value = lastName;
                guestPhoneInput.value = `555-${Math.floor(100 + Math.random() * 900)}-${Math.floor(1000 + Math.random() * 9000)}`;
                guestEmailInput.value = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`;
                
                deliveryAddress1Input.value = `${Math.floor(10 + Math.random() * 899)} ${randomFromArray(streetNames)}`;
                deliveryCityInput.value = randomFromArray(cities);
                deliveryStateInput.value = 'MA';
                deliveryZipInput.value = `02${Math.floor(100 + Math.random() * 900)}`;
            }

            generateDetailsBtn.addEventListener('click', generateRandomDetails);


            // Fetch Order
            fetchOrderByGuidBtn.addEventListener('click', fetchOrderByGuid);
            fetchOrdersByDateBtn.addEventListener('click', fetchOrdersByDate);
            resultsContainer.addEventListener('toggle', (e) => {
                if (e.target.tagName === 'DETAILS' && e.target.open) {
                    fetchAndDisplayOrderDetails(e.target);
                }
            }, true);
            
            // Update Order
            loadOrderForUpdateBtn.addEventListener('click', loadOrderForUpdate);
            resultsContainer.addEventListener('click', addPayment);
            resultsContainer.addEventListener('click', voidOrder);
            resultsContainer.addEventListener('click', voidItem);
            resultsContainer.addEventListener('click', addItemsToCheck);
            resultsContainer.addEventListener('click', applyDiscountToOrder);
            
            // Stock Management
            viewInventoryBtn.addEventListener('click', viewInventory);
            searchInventoryBtn.addEventListener('click', searchInventory);
            bulkUpdateInventoryBtn.addEventListener('click', bulkUpdateInventory);
            addUpdateItemBtn.addEventListener('click', addUpdateItem);
            
            // Labor Management
            fetchAllEmployeesBtn.addEventListener('click', fetchAllEmployees);
            viewSelectedEmployeeBtn.addEventListener('click', viewSelectedEmployee);
            autoFillEmployeeBtn.addEventListener('click', autoFillEmployeeData);
            viewEmployeesBtn.addEventListener('click', viewEmployees);
            addEmployeeBtn.addEventListener('click', addEmployee);
            updateEmployeeBtn.addEventListener('click', updateEmployee);
            fetchAllJobsBtn.addEventListener('click', fetchAllJobs);
            viewSelectedJobBtn.addEventListener('click', viewSelectedJob);
            viewJobsBtn.addEventListener('click', viewJobs);
            assignJobsBtn.addEventListener('click', assignJobs);
            viewShiftsBtn.addEventListener('click', viewShifts);
            createShiftBtn.addEventListener('click', createShift);
            viewTimeEntriesBtn.addEventListener('click', viewTimeEntries);
            createTimeEntryBtn.addEventListener('click', createTimeEntry);
            
            // Menu Management
            fetchAllMenusBtn.addEventListener('click', fetchAllMenus);
            viewSelectedMenuBtn.addEventListener('click', viewSelectedMenu);
            
            // Menu Items
            viewSelectedItemBtn.addEventListener('click', viewSelectedItem);
            searchMenuItemsBtn.addEventListener('click', searchMenuItems);
            updateItemPriceBtn.addEventListener('click', updateItemPrice);
            toggleItemAvailabilityBtn.addEventListener('click', toggleItemAvailability);
            
            // Enable/disable item operation buttons based on selection
            itemOperationDropdown.addEventListener('change', function() {
                const hasSelection = itemOperationDropdown.value !== '';
                updateItemPriceBtn.disabled = !hasSelection;
                toggleItemAvailabilityBtn.disabled = !hasSelection;
            });
            
            // Add event listeners for shift creation form
            shiftEmployeeDropdown.addEventListener('change', updateShiftJobDropdownForEmployee);
            shiftJobDropdown.addEventListener('change', updateCreateShiftButtonState);
            shiftStartTime.addEventListener('input', function() {
                updateShiftDurationDisplay();
                updateCreateShiftButtonState();
            });
            shiftEndTime.addEventListener('input', function() {
                updateShiftDurationDisplay(); 
                updateCreateShiftButtonState();
            });
            
            // Add event listeners for time entry creation form
            timeEntryEmployeeDropdown.addEventListener('change', updateTimeEntryJobDropdown);
            timeEntryJobDropdown.addEventListener('change', updateCreateTimeEntryButtonState);
            timeEntryClockIn.addEventListener('input', function() {
                updateTimeEntryHours();
                updateCreateTimeEntryButtonState();
            });
            timeEntryClockOut.addEventListener('input', function() {
                updateTimeEntryHours();
                updateCreateTimeEntryButtonState();
            });
            timeEntryBreakMinutes.addEventListener('input', updateTimeEntryHours);
            timeEntryCashTips.addEventListener('input', updateCreateTimeEntryButtonState);
            
            // Time Entry Query Type Handler
            timeEntryQuery.addEventListener('change', function() {
                if (this.value === 'businessDate') {
                    timeEntryDateInputs.style.display = 'none';
                    timeEntryBusinessDateInput.style.display = 'block';
                } else {
                    timeEntryDateInputs.style.display = 'block';
                    timeEntryBusinessDateInput.style.display = 'none';
                }
            });

            resultsContainer.addEventListener('click', (e) => {
                if (e.target.id === 'stageItemBtn') {
                    const itemSelectUpdate = document.getElementById('itemSelectUpdate');
                    const quantityInput = document.getElementById('itemQuantityUpdate');
                    const selectedOption = itemSelectUpdate.options[itemSelectUpdate.selectedIndex];
                    if(!selectedOption || !selectedOption.value) return;
                    
                    const [guid, itemGroupGuid] = selectedOption.value.split('|');
                    const name = selectedOption.text;
                    const quantity = parseInt(quantityInput.value, 10);
                    
                    stagedItemsForUpdate.push({ guid, itemGroupGuid, name, quantity });
                    renderStagedItems();
                }
                if (e.target.classList.contains('removeStagedItemBtn')) {
                    stagedItemsForUpdate.splice(e.target.dataset.index, 1);
                    renderStagedItems();
                }
            });

            // Saved Locations
            savedLocationsSelect.addEventListener('change', (e) => {
                const index = e.target.value;
                if (index === "") {
                    clientIdInput.value = '';
                    clientSecretInput.value = '';
                    restaurantGuidInput.value = '';
                    return;
                }
                const locations = JSON.parse(localStorage.getItem('toastTestClientLocations')) || [];
                const selectedLocation = locations[index];
                if (selectedLocation) {
                    clientIdInput.value = selectedLocation.clientId;
                    clientSecretInput.value = selectedLocation.clientSecret;
                    restaurantGuidInput.value = selectedLocation.restaurantGuid;
                }
            });

            clearLocationsBtn.addEventListener('click', () => {
                localStorage.removeItem('toastTestClientLocations');
                loadSavedLocations();
            });

            // --- Initial Load ---
            updateUIState();
            renderCart();
            renderCustomFields();
            renderApiLogHistory();
        });
    </script>
</body>
</html>

